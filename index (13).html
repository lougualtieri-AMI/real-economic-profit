<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Real Economic Profit Analyzer</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0f0f0f;--card:#1a1a1a;--card2:#222;--border:#333;
  --text:#e8e8e8;--text2:#999;--text3:#666;
  --accent:#d4a025;--accent2:#f0c040;--accent-dim:#8b6914;
  --green:#2ecc71;--red:#e74c3c;--blue:#3498db;--orange:#e67e22;--purple:#9b59b6;
  --radius:12px;
}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);line-height:1.6;padding:16px;max-width:800px;margin:0 auto}
h1{font-size:1.6rem;font-weight:700;color:var(--accent2);text-align:center;margin:20px 0 4px}
.subtitle{text-align:center;color:var(--text2);font-size:.85rem;margin-bottom:24px}
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:20px;margin-bottom:16px}
.card h2{font-size:1.05rem;font-weight:600;color:var(--accent);margin-bottom:16px;padding-bottom:8px;border-bottom:1px solid var(--border)}
.card h3{font-size:.9rem;font-weight:600;color:var(--text2);margin:16px 0 8px;text-transform:uppercase;letter-spacing:.5px}
.field{margin-bottom:12px}
.field label{display:block;font-size:.82rem;color:var(--text2);margin-bottom:4px;font-weight:500}
.field input{width:100%;padding:10px 12px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:.9rem;transition:border-color .2s}
.field input:focus{outline:none;border-color:var(--accent)}
.field .hint{font-size:.72rem;color:var(--text3);margin-top:2px}
.row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
button.calc{width:100%;padding:14px;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#000;font-family:'DM Sans',sans-serif;font-size:1rem;font-weight:700;border:none;border-radius:var(--radius);cursor:pointer;margin:8px 0 20px;transition:transform .15s,box-shadow .15s}
button.calc:hover{transform:translateY(-1px);box-shadow:0 4px 20px rgba(212,160,37,.3)}
button.calc:active{transform:translateY(0)}
button.secondary{width:100%;padding:12px;background:var(--card2);border:1px solid var(--border);border-radius:var(--radius);color:var(--text2);font-family:'DM Sans',sans-serif;font-size:.9rem;font-weight:600;cursor:pointer;margin-bottom:8px;transition:border-color .2s,color .2s}
button.secondary:hover{border-color:var(--accent);color:var(--text)}
.modal-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);z-index:100;align-items:center;justify-content:center;padding:16px}
.modal-overlay.active{display:flex}
.modal{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:24px;max-width:600px;width:100%;max-height:80vh;overflow-y:auto}
.modal h3{color:var(--accent2);margin-bottom:12px;font-size:1.1rem}
.modal textarea{width:100%;height:200px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:.8rem;padding:12px;resize:vertical}
.modal textarea:focus{outline:none;border-color:var(--accent)}
.modal p{font-size:.82rem;color:var(--text2);margin-bottom:12px;line-height:1.5}
.modal .btn-row{display:flex;gap:8px;margin-top:12px}
.modal .btn-row button{flex:1;padding:10px;border-radius:8px;font-family:'DM Sans',sans-serif;font-weight:600;cursor:pointer;font-size:.9rem}
.modal .btn-import{background:var(--accent);color:#000;border:none}
.modal .btn-cancel{background:var(--card2);color:var(--text2);border:1px solid var(--border)}
.import-status{font-size:.82rem;margin-top:8px;padding:8px 12px;border-radius:6px;display:none}
.import-status.success{display:block;background:rgba(46,204,113,.1);color:var(--green)}
.import-status.error{display:block;background:rgba(231,76,60,.1);color:var(--red)}
.source-badge{display:inline-block;font-size:.65rem;padding:2px 6px;border-radius:4px;margin-left:6px;vertical-align:middle;font-weight:600}
.source-badge.annual{background:rgba(52,152,219,.15);color:var(--blue)}
.source-badge.balance{background:rgba(46,204,113,.15);color:var(--green)}
.verdict{text-align:center;padding:24px;border-radius:var(--radius);margin-bottom:16px}
.verdict .yield-num{font-family:'JetBrains Mono',monospace;font-size:2.4rem;font-weight:700;line-height:1.2}
.verdict .yield-label{font-size:.85rem;color:var(--text2);margin-top:4px}
.verdict .rating{display:inline-block;padding:4px 14px;border-radius:20px;font-size:.82rem;font-weight:600;margin-top:10px}
.verdict.strong{background:rgba(46,204,113,.08);border:1px solid rgba(46,204,113,.3)}
.verdict.strong .yield-num{color:var(--green)}
.verdict.strong .rating{background:rgba(46,204,113,.15);color:var(--green)}
.verdict.fair{background:rgba(52,152,219,.08);border:1px solid rgba(52,152,219,.3)}
.verdict.fair .yield-num{color:var(--blue)}
.verdict.fair .rating{background:rgba(52,152,219,.15);color:var(--blue)}
.verdict.growth{background:rgba(230,126,34,.08);border:1px solid rgba(230,126,34,.3)}
.verdict.growth .yield-num{color:var(--orange)}
.verdict.growth .rating{background:rgba(230,126,34,.15);color:var(--orange)}
.verdict.expensive{background:rgba(231,76,60,.08);border:1px solid rgba(231,76,60,.3)}
.verdict.expensive .yield-num{color:var(--red)}
.verdict.expensive .rating{background:rgba(231,76,60,.15);color:var(--red)}
.metrics{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px}
.metric{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:14px}
.metric .val{font-family:'JetBrains Mono',monospace;font-size:1.15rem;font-weight:600;color:var(--text)}
.metric .lbl{font-size:.75rem;color:var(--text2);margin-top:2px}
.metric.highlight .val{color:var(--accent2)}
.waterfall{margin:16px 0}
.wf-bar{display:flex;align-items:center;margin-bottom:6px;font-size:.82rem}
.wf-label{width:130px;text-align:right;padding-right:10px;color:var(--text2);flex-shrink:0;font-size:.78rem}
.wf-track{flex:1;height:28px;background:var(--bg);border-radius:6px;position:relative;overflow:hidden}
.wf-fill{height:100%;border-radius:6px;display:flex;align-items:center;padding:0 8px;font-family:'JetBrains Mono',monospace;font-size:.75rem;font-weight:500;color:#fff;white-space:nowrap;min-width:fit-content;transition:width .4s ease}
.wf-fill.positive{background:linear-gradient(90deg,#2ecc71,#27ae60)}
.wf-fill.negative{background:linear-gradient(90deg,#e74c3c,#c0392b)}
.wf-fill.invest{background:linear-gradient(90deg,var(--blue),#2980b9)}
.wf-fill.result{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#000}
.breakdown{width:100%;border-collapse:collapse;font-size:.82rem;margin:12px 0}
.breakdown th{text-align:left;padding:8px 6px;border-bottom:1px solid var(--border);color:var(--text2);font-weight:500;font-size:.75rem;text-transform:uppercase;letter-spacing:.3px}
.breakdown td{padding:8px 6px;border-bottom:1px solid rgba(51,51,51,.5)}
.breakdown td:last-child{text-align:right;font-family:'JetBrains Mono',monospace;font-weight:500}
.breakdown tr.subtotal td{border-top:2px solid var(--accent-dim);font-weight:600;color:var(--accent2)}
.breakdown tr.negative td:last-child{color:var(--red)}
.breakdown tr.positive td:last-child{color:var(--green)}
.flags{margin-top:12px}
.flag{padding:10px 14px;border-radius:8px;margin-bottom:8px;font-size:.82rem;line-height:1.5}
.flag.warn{background:rgba(231,76,60,.08);border-left:3px solid var(--red);color:#e8b4b0}
.flag.caution{background:rgba(230,126,34,.08);border-left:3px solid var(--orange);color:#e8cdb0}
.flag.ok{background:rgba(46,204,113,.08);border-left:3px solid var(--green);color:#b0e8c6}
.flag.info{background:rgba(52,152,219,.08);border-left:3px solid var(--blue);color:#b0d0e8}
.flag.growth{background:rgba(155,89,182,.08);border-left:3px solid var(--purple);color:#d0b0e8}
.proj-table{width:100%;border-collapse:collapse;font-size:.82rem;margin:12px 0}
.proj-table th{text-align:center;padding:8px 6px;border-bottom:1px solid var(--border);color:var(--text2);font-weight:500;font-size:.75rem}
.proj-table td{text-align:center;padding:10px 6px;border-bottom:1px solid rgba(51,51,51,.5);font-family:'JetBrains Mono',monospace;font-weight:500}
.proj-table td:first-child{text-align:left;font-family:'DM Sans',sans-serif;color:var(--text2)}
.proj-table tr.highlight-row td{color:var(--accent2);font-weight:600}
#results{display:none}
.section-note{font-size:.75rem;color:var(--text3);font-style:italic;margin-top:4px}
.tip-box{background:rgba(52,152,219,.06);border:1px solid rgba(52,152,219,.2);border-radius:8px;padding:12px 14px;margin-bottom:16px;font-size:.78rem;color:var(--text2);line-height:1.6}
.tip-box strong{color:var(--blue)}
.year-pills{display:flex;flex-wrap:wrap;gap:6px;margin:12px 0}
.year-pill{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;background:var(--card2);border:1px solid var(--border);border-radius:20px;font-size:.78rem;font-family:'JetBrains Mono',monospace;color:var(--text2);transition:all .2s}
.year-pill.current{border-color:var(--accent);color:var(--accent2);background:rgba(212,160,37,.08)}
.year-pill .remove-year{cursor:pointer;color:var(--text3);font-size:.7rem;padding:2px;transition:color .2s}
.year-pill .remove-year:hover{color:var(--red)}
.year-pill .load-year{cursor:pointer;padding:2px 4px}
.year-pill .load-year:hover{color:var(--accent2)}
.trend-table{width:100%;border-collapse:collapse;font-size:.78rem;margin:12px 0;overflow-x:auto;display:block}
.trend-table th{text-align:center;padding:8px 6px;border-bottom:1px solid var(--border);color:var(--text2);font-weight:500;font-size:.72rem;text-transform:uppercase;white-space:nowrap}
.trend-table td{text-align:center;padding:8px 6px;border-bottom:1px solid rgba(51,51,51,.5);font-family:'JetBrains Mono',monospace;font-size:.78rem;white-space:nowrap}
.trend-table td:first-child{text-align:left;font-family:'DM Sans',sans-serif;color:var(--text2)}
.trend-table tr.trend-up td.trend-val{color:var(--green)}
.trend-table tr.trend-down td.trend-val{color:var(--red)}
.chart-legend{display:flex;flex-wrap:wrap;gap:12px;justify-content:center;margin-top:8px;font-size:.75rem}
.chart-legend span{display:flex;align-items:center;gap:4px;color:var(--text2)}
.chart-legend .dot{width:10px;height:10px;border-radius:50%;display:inline-block}

/* Growth decomposition */
.decomp-row{display:flex;align-items:center;margin-bottom:10px;font-size:.82rem}
.decomp-label{width:110px;text-align:right;padding-right:10px;color:var(--text2);flex-shrink:0;font-size:.78rem}
.decomp-bar-track{flex:1;height:32px;background:var(--bg);border-radius:6px;position:relative;overflow:hidden;display:flex}
.decomp-seg{height:100%;display:flex;align-items:center;justify-content:center;font-family:'JetBrains Mono',monospace;font-size:.72rem;font-weight:500;color:#fff;white-space:nowrap;min-width:30px;transition:width .4s ease}
.decomp-seg.organic{background:linear-gradient(90deg,#2ecc71,#27ae60)}
.decomp-seg.reinvest{background:linear-gradient(90deg,#9b59b6,#8e44ad)}
.decomp-seg.negative-organic{background:linear-gradient(90deg,#e67e22,#d35400)}
.decomp-summary{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin:12px 0}
.decomp-stat{background:var(--bg);border-radius:8px;padding:10px 12px;text-align:center}
.decomp-stat .ds-val{font-family:'JetBrains Mono',monospace;font-size:1rem;font-weight:600}
.decomp-stat .ds-lbl{font-size:.72rem;color:var(--text3);margin-top:2px}
.decomp-stat .ds-val.organic-color{color:var(--green)}
.decomp-stat .ds-val.reinvest-color{color:var(--purple)}
.decomp-stat .ds-val.total-color{color:var(--accent2)}
.decomp-stat .ds-val.neg-color{color:var(--orange)}
</style>
</head>
<body>

<h1>‚ö° Real Economic Profit Analyzer</h1>
<p class="subtitle">Cut through accounting noise ‚Äî find the real cash yield of a business</p>

<button class="secondary" onclick="openImport()">üìã Import 10-K Data from Gemini</button>

<div id="yearPills" class="year-pills" style="display:none"></div>

<div class="tip-box">
  <strong>üí° Data sourcing:</strong> Use <strong>annual 10-K</strong> for all cash flow items. Use the <strong>latest 10-Q</strong> for balance sheet items. Feed both PDFs to Gemini and paste the JSON here. For <strong>multi-year trends</strong>, import each year's 10-K in separate Gemini chats ‚Äî the fiscal year is auto-detected.
</div>

<div class="card">
  <h2>üìä Phase 1 ‚Äî Cash Flow <span class="source-badge annual">from 10-K annual</span></h2>
  <div class="row" style="margin-bottom:12px">
    <div class="field"><label>Company / Ticker</label><input type="text" id="ticker" placeholder="e.g. AAPL"></div>
    <div class="field"><label>Current Share Price ($)</label><input type="number" id="price" step="0.01" placeholder="Look up live price"></div>
  </div>
  <h3>Operating Cash Flow</h3>
  <div class="field"><label>Cash From Operations ($M)</label><input type="number" id="cfo" step="1"></div>
  <div class="row">
    <div class="field"><label>SBC Expense Addback ($M)</label><input type="number" id="sbc_expense" step="1"><div class="hint">From cash flow statement</div></div>
    <div class="field"><label>SBC Grant Value ($M)</label><input type="number" id="sbc_grant" step="1"><div class="hint">Notes: RSUs granted √ó weighted avg grant date FV</div></div>
  </div>
  <h3>Capital Expenditures</h3>
  <div class="row3">
    <div class="field"><label>Total CapEx ($M)</label><input type="number" id="capex" step="1"></div>
    <div class="field"><label>D&A ($M)</label><input type="number" id="da" step="1"></div>
    <div class="field"><label>Maint. CapEx ($M)</label><input type="number" id="maint_capex" step="1" placeholder="If disclosed"><div class="hint">Leave blank to auto-estimate</div></div>
  </div>
  <h3>Other Adjustments</h3>
  <div class="row">
    <div class="field"><label>Restructuring Charges ($M)</label><input type="number" id="restructuring" step="1" value="0"></div>
    <div class="field"><label>Inventory Change ($M)</label><input type="number" id="inv_change" step="1"><div class="hint">+ = cash freed ¬∑ ‚àí = cash trapped</div></div>
  </div>
  <div class="row">
    <div class="field"><label>Receivables Change ($M)</label><input type="number" id="recv_change" step="1"><div class="hint">+ = collected ¬∑ ‚àí = not collected</div></div>
    <div class="field"><label>Interest Paid ($M)</label><input type="number" id="interest" step="1"><div class="hint">Supplemental disclosure</div></div>
  </div>
  <div class="field"><label>Income Tax Paid ($M)</label><input type="number" id="tax_paid" step="1"><div class="hint">Supplemental disclosure</div></div>
</div>

<div class="card">
  <h2>üè¶ Phase 2 ‚Äî Balance Sheet <span class="source-badge balance">from latest 10-Q</span></h2>
  <div class="row">
    <div class="field"><label>Total Debt ($M)</label><input type="number" id="debt" step="1"><div class="hint">CP + current term + non-current term debt</div></div>
    <div class="field"><label>Cash & Equivalents ($M)</label><input type="number" id="cash" step="1"></div>
  </div>
  <div class="row">
    <div class="field"><label>Short-Term Investments ($M)</label><input type="number" id="sti" step="1" value="0"></div>
    <div class="field"><label>Diluted Shares Outstanding (M)</label><input type="number" id="shares" step="1"></div>
  </div>
  <h3>üìê ROIC Inputs</h3>
  <div class="row">
    <div class="field"><label>Total Shareholders' Equity ($M)</label><input type="number" id="equity" step="1"><div class="hint">Total stockholders' equity</div></div>
    <div class="field"><label>Total Assets ($M)</label><input type="number" id="total_assets" step="1"><div class="hint">Asset turnover context</div></div>
  </div>
  <h3>üí∞ Investment Portfolio</h3>
  <div class="row">
    <div class="field"><label>Non-Cash LT Investments ($M)</label><input type="number" id="lt_investments" step="1" value="0"><div class="hint">Marketable securities, bond portfolios</div></div>
    <div class="field"><label>Expected Return (%)</label><input type="number" id="inv_return_rate" step="0.1" value="4"><div class="hint">Default 4%</div></div>
  </div>
  <p class="section-note">Investment income is added to Real Economic Profit as a credit.</p>
</div>

<button class="calc" onclick="calculate()">‚ö° Analyze Real Economic Profit</button>

<div id="results">
  <div id="verdict" class="verdict"></div>
  <div id="metricsGrid" class="metrics"></div>
  <div class="card"><h2>üìâ Profit Waterfall</h2><div id="waterfall" class="waterfall"></div></div>
  <div class="card" id="roicCard" style="display:none">
    <h2>üîÑ ROIC & Growth CapEx Analysis</h2>
    <div id="roicMetrics" class="metrics" style="margin-bottom:16px"></div>
    <div id="growthProjection"></div>
  </div>
  <div class="card" id="trendCard" style="display:none">
    <h2>üìà Historical Trend</h2>
    <div id="trendContent"></div>
  </div>
  <div class="card"><h2>üìã Detailed Breakdown</h2><table id="breakdown" class="breakdown"></table></div>
  <div class="card"><h2>üö© Red Flags & Signals</h2><div id="flags" class="flags"></div></div>
</div>

<div class="modal-overlay" id="importModal">
  <div class="modal">
    <h3>üìã Import 10-K Data from Gemini</h3>
    <p>Paste the JSON output from Gemini. The fiscal year is auto-detected. For <strong>multi-year trends</strong>, import each year's 10-K separately (new Gemini chat each time). Enter <strong>ticker</strong> and <strong>share price</strong> manually.</p>
    <textarea id="jsonInput" placeholder='Paste Gemini JSON here...'></textarea>
    <div id="importStatus" class="import-status"></div>
    <div class="btn-row">
      <button class="btn-cancel" onclick="closeImport()">Cancel</button>
      <button class="btn-import" onclick="doImport()">Import & Fill</button>
    </div>
  </div>
</div>

<script>
// ============ Multi-year store ============
const yearStore = {};
let currentYearKey = null;

function v(id){const el=document.getElementById(id);return el.value===''?null:parseFloat(el.value)}
function fmt(n,dec){if(dec===undefined)dec=0;if(n===null||isNaN(n))return '‚Äî';return n<0?'-$'+Math.abs(n).toLocaleString('en-US',{minimumFractionDigits:dec,maximumFractionDigits:dec}):'$'+n.toLocaleString('en-US',{minimumFractionDigits:dec,maximumFractionDigits:dec})}
function fmtM(n){if(n===null||isNaN(n))return '‚Äî';var abs=Math.abs(n);var s;if(abs>=1e6)s=(n/1e6).toFixed(1)+'T';else if(abs>=1e3)s=(n/1e3).toFixed(1)+'B';else s=n.toFixed(0)+'M';return n<0?'-$'+s.replace('-',''):'$'+s}
function pct(n,dec){if(dec===undefined)dec=2;if(n===null||isNaN(n))return '‚Äî';return (n*100).toFixed(dec)+'%'}

// ============ JSON Import ============
function openImport(){document.getElementById('jsonInput').value='';document.getElementById('importStatus').className='import-status';document.getElementById('importModal').classList.add('active')}
function closeImport(){document.getElementById('importModal').classList.remove('active');document.getElementById('importStatus').className='import-status'}

function stripJsonComments(str){return str.replace(/("(?:[^"\\]|\\.)*")|\/\/[^\n]*/g,function(m,g){return g||''});}

function doImport(){
  var raw=document.getElementById('jsonInput').value.trim();
  var statusEl=document.getElementById('importStatus');
  try{
    var cleaned=stripJsonComments(raw);
    var d=JSON.parse(cleaned);
    var map={
      'cash from operations':'cfo','cash_from_operations':'cfo','cfo':'cfo',
      'sbc expense addback':'sbc_expense','sbc expense':'sbc_expense','sbc_expense_addback':'sbc_expense',
      'sbc grant date fair value':'sbc_grant','sbc grant value':'sbc_grant','sbc_grant_value':'sbc_grant',
      'total capex':'capex','capital expenditures':'capex','capex_total':'capex','capex':'capex',
      'd&a':'da','da':'da','d_and_a':'da','depreciation & amortization':'da','depreciation and amortization':'da','depreciation_and_amortization':'da',
      'maintenance capex':'maint_capex','maint capex':'maint_capex','maintenance_capex_explicit':'maint_capex',
      'restructuring charges':'restructuring','restructuring':'restructuring','restructuring_cash_payments':'restructuring',
      'inventory change':'inv_change','inventory_change':'inv_change',
      'receivables change':'recv_change','accounts receivable change':'recv_change','trade receivables change':'recv_change','receivables_change':'recv_change',
      'interest paid':'interest','cash_interest_paid':'interest','cash interest paid':'interest',
      'income tax paid':'tax_paid','income taxes paid':'tax_paid','cash_taxes_paid':'tax_paid','cash taxes paid':'tax_paid',
      'total debt':'debt','total_debt_principal':'debt','total debt principal':'debt',
      'cash & equivalents':'cash','cash and equivalents':'cash','cash & cash equivalents':'cash','cash and cash equivalents':'cash','cash_and_equivalents':'cash',
      'short-term investments':'sti','short term investments':'sti','current marketable securities':'sti','short_term_investments':'sti',
      'non-current marketable securities':'lt_investments','non current marketable securities':'lt_investments','long-term investments':'lt_investments','long term investments':'lt_investments','non_current_marketable_securities':'lt_investments',
      'diluted shares outstanding':'shares','diluted shares':'shares','shares_outstanding_diluted':'shares',
      'total shareholders equity':'equity','total stockholders equity':'equity','shareholders_equity':'equity','stockholders_equity':'equity','total_shareholders_equity':'equity','total_stockholders_equity':'equity','equity':'equity',
      'total assets':'total_assets','total_assets':'total_assets',
      'ticker':'ticker','company':'ticker','share price':'price','current share price':'price'
    };
    var fyKeys={'fiscal_year_end':1,'fiscal year end':1,'fiscal_year_end_date':1,'fiscal year end date':1,'period_end_date':1,'period end date':1};
    var fyLabelKeys={'fiscal_year_label':1,'fiscal year label':1,'fiscal year':1,'fiscal_year':1,'fy_label':1};
    var extraKeys={'revenue':1,'total revenue':1,'net revenue':1,'total_revenue':1,'net income':1,'net_income':1,'operating income':1,'operating_income':1};

    function flatten(obj){var flat={};for(var k in obj){if(!obj.hasOwnProperty(k))continue;var val=obj[k];if(val!==null&&typeof val==='object'&&!Array.isArray(val)){var sub=flatten(val);for(var sk in sub)flat[sk]=sub[sk];}else{flat[k]=val;}}return flat;}
    var flat=flatten(d);

    var filled=0,warnings=[],fyEnd=null,fyLabel=null,extra={};
    for(var key in flat){
      if(!flat.hasOwnProperty(key))continue;
      var val=flat[key];
      var lk=key.toLowerCase();
      if(fyKeys[lk]){fyEnd=val;continue;}
      if(fyLabelKeys[lk]){fyLabel=val;continue;}
      if(extraKeys[lk]){extra[lk.replace(/ /g,'_')]=val;continue;}
      var fieldId=map[lk];
      if(fieldId&&val!==null&&val!==undefined){
        var el=document.getElementById(fieldId);
        if(el){el.value=val;filled++;}
      }else if(val===null&&map[lk]){warnings.push(key);}
    }

    // Post-import fixups
    var mcEl=document.getElementById('maint_capex');
    if(mcEl&&(mcEl.value===''||mcEl.value==='0'||parseFloat(mcEl.value)===0))mcEl.value='';
    var cxEl=document.getElementById('capex');
    if(cxEl&&parseFloat(cxEl.value)<0)cxEl.value=Math.abs(parseFloat(cxEl.value));
    var daEl=document.getElementById('da');
    if(daEl&&parseFloat(daEl.value)<0)daEl.value=Math.abs(parseFloat(daEl.value));

    // Save to year store
    if(fyEnd||fyLabel){
      var yearKey=fyEnd||fyLabel;
      saveCurrentYear(yearKey,fyEnd,fyLabel,extra);
    }

    var msg='‚úì Imported '+filled+' fields.';
    if(fyLabel||fyEnd)msg+=' üìÖ '+(fyLabel||'')+' '+(fyEnd?'(ended '+fyEnd+')':'');
    if(warnings.length>0)msg+=' ‚ö† Null: '+warnings.join(', ')+'.';
    if(!fyEnd&&!fyLabel)msg+=' ‚ö† No fiscal year detected ‚Äî add fiscal_year_end & fiscal_year_label to prompt.';
    msg+=' Enter ticker & share price, then analyze!';
    statusEl.className='import-status success';
    statusEl.textContent=msg;
    setTimeout(function(){closeImport()},3500);
  }catch(e){
    statusEl.className='import-status error';
    statusEl.textContent='‚úó Invalid JSON: '+e.message;
  }
}

// ============ Year Management ============
function captureForm(){
  return {cfo:v('cfo'),sbc_expense:v('sbc_expense'),sbc_grant:v('sbc_grant'),capex:v('capex'),da:v('da'),maint_capex:v('maint_capex'),restructuring:v('restructuring'),inv_change:v('inv_change'),recv_change:v('recv_change'),interest:v('interest'),tax_paid:v('tax_paid'),debt:v('debt'),cash:v('cash'),sti:v('sti'),shares:v('shares'),lt_investments:v('lt_investments'),inv_return_rate:v('inv_return_rate'),equity:v('equity'),total_assets:v('total_assets'),ticker:document.getElementById('ticker').value,price:v('price')};
}

function restoreForm(d){
  var fields=['cfo','sbc_expense','sbc_grant','capex','da','maint_capex','restructuring','inv_change','recv_change','interest','tax_paid','debt','cash','sti','shares','lt_investments','inv_return_rate','equity','total_assets'];
  fields.forEach(function(f){var el=document.getElementById(f);if(el&&d[f]!==null&&d[f]!==undefined)el.value=d[f];else if(el)el.value='';});
  if(d.ticker)document.getElementById('ticker').value=d.ticker;
  if(d.price)document.getElementById('price').value=d.price;
}

function saveCurrentYear(yearKey,fyEnd,fyLabel,extra){
  yearStore[yearKey]={formData:captureForm(),fiscal_year_end:fyEnd,fiscal_year_label:fyLabel,extra:extra||{}};
  currentYearKey=yearKey;
  renderPills();
}

function computeMetrics(entry){
  var d=entry.formData;
  var cfo=d.cfo||0,sbcExp=d.sbc_expense||0,sbcGrant=d.sbc_grant||0;
  var capex=d.capex||0,da=d.da||0,mcIn=d.maint_capex;
  var restructuring=d.restructuring||0;
  var ltInv=d.lt_investments||0,invRate=(d.inv_return_rate||4)/100;
  var equity=d.equity||0,debt=d.debt||0,cash=d.cash||0,sti=d.sti||0;
  var maintCapex;
  if(mcIn!==null&&mcIn>0){maintCapex=mcIn;}
  else{var ratio=da>0?capex/da:999;if(ratio>=0.8&&ratio<=1.2)maintCapex=capex;else maintCapex=da*1.05;}
  var realSBC=Math.max(sbcExp,sbcGrant);
  var invIncome=ltInv*invRate;
  var realProfit=cfo-realSBC-maintCapex-restructuring+invIncome;
  var growthCapex=Math.max(capex-maintCapex,0);
  var investedCapital=equity>0?(equity+debt-cash-sti):0;
  var realROIC=investedCapital>0?realProfit/investedCapital:0;
  var reportedFCF=cfo-capex;
  return {cfo:cfo,realSBC:realSBC,maintCapex:maintCapex,growthCapex:growthCapex,realProfit:realProfit,investedCapital:investedCapital,realROIC:realROIC,reportedFCF:reportedFCF,equity:equity,debt:debt,sbcExp:sbcExp,sbcGrant:sbcGrant,capex:capex,da:da,revenue:entry.extra.revenue||entry.extra.total_revenue||entry.extra.net_revenue||null,net_income:entry.extra.net_income||null};
}

function renderPills(){
  var c=document.getElementById('yearPills');
  var keys=Object.keys(yearStore).sort(function(a,b){
    var da=yearStore[a].fiscal_year_end||a;
    var db=yearStore[b].fiscal_year_end||b;
    return da<db?-1:da>db?1:0;
  });
  if(keys.length===0){c.style.display='none';return;}
  c.style.display='flex';
  c.innerHTML=keys.map(function(k){
    var yr=yearStore[k];
    var label=yr.fiscal_year_label||(yr.fiscal_year_end?'FY'+new Date(yr.fiscal_year_end).getFullYear():k);
    var endD=yr.fiscal_year_end||'';
    var cur=k===currentYearKey;
    return '<span class="year-pill'+(cur?' current':'')+'" title="'+endD+'"><span class="load-year" onclick="loadYear(\''+k+'\')">'+label+(endD?' ('+endD+')':'')+'</span> <span class="remove-year" onclick="removeYear(\''+k+'\')" title="Remove">‚úï</span></span>';
  }).join('');
}

function loadYear(k){
  if(currentYearKey&&yearStore[currentYearKey])yearStore[currentYearKey].formData=captureForm();
  var yr=yearStore[k];
  if(yr){restoreForm(yr.formData);currentYearKey=k;renderPills();}
}

function removeYear(k){
  delete yearStore[k];
  if(currentYearKey===k)currentYearKey=null;
  renderPills();
  if(document.getElementById('results').style.display==='block')renderTrend();
}

// ============ Trend Rendering ============
function renderTrend(){
  var trendCard=document.getElementById('trendCard');
  var keys=Object.keys(yearStore).sort(function(a,b){
    var da=yearStore[a].fiscal_year_end||a;var db=yearStore[b].fiscal_year_end||b;return da<db?-1:da>db?1:0;
  });
  if(keys.length<2){trendCard.style.display='none';return;}
  trendCard.style.display='block';

  var years=keys.map(function(k){
    var yr=yearStore[k];
    var m=computeMetrics(yr);
    m.label=yr.fiscal_year_label||(yr.fiscal_year_end?'FY'+new Date(yr.fiscal_year_end).getFullYear():k);
    m.endDate=yr.fiscal_year_end||k;
    return m;
  });

  var html='';

  // SVG Chart
  var cW=720,cH=240,pL=55,pR=55,pT=25,pB=35;
  var plotW=cW-pL-pR,plotH=cH-pT-pB;
  var n=years.length;

  var roicVals=years.map(function(y){return y.realROIC});
  var rMin=Math.min.apply(null,roicVals)*0.8;
  var rMax=Math.max.apply(null,roicVals)*1.2;
  if(rMax-rMin<0.01){rMin-=0.05;rMax+=0.05;}
  var rRange=rMax-rMin;

  var profitVals=years.map(function(y){return y.realProfit});
  var pMin=Math.min.apply(null,profitVals.concat([0]))*0.9;
  var pMax=Math.max.apply(null,profitVals)*1.1;
  if(pMax-pMin<1){pMin-=1000;pMax+=1000;}
  var pRange=pMax-pMin;

  function xP(i){return pL+(n>1?i/(n-1)*plotW:plotW/2)}
  function yR(val){return pT+plotH-((val-rMin)/rRange*plotH)}
  function yP(val){return pT+plotH-((val-pMin)/pRange*plotH)}

  html+='<svg viewBox="0 0 '+cW+' '+cH+'" style="width:100%;height:auto;margin:16px 0;overflow:visible">';

  // Grid
  for(var i=0;i<=4;i++){
    var gy=pT+(plotH/4)*i;
    html+='<line x1="'+pL+'" y1="'+gy+'" x2="'+(cW-pR)+'" y2="'+gy+'" stroke="#333" stroke-width="0.5"/>';
    var rv=rMax-((rMax-rMin)/4)*i;
    html+='<text x="'+(pL-6)+'" y="'+(gy+4)+'" fill="#999" font-size="9" text-anchor="end" font-family="JetBrains Mono">'+(rv*100).toFixed(1)+'%</text>';
    var pv=pMax-((pMax-pMin)/4)*i;
    html+='<text x="'+(cW-pR+6)+'" y="'+(gy+4)+'" fill="#999" font-size="9" text-anchor="start" font-family="JetBrains Mono">'+fmtM(pv)+'</text>';
  }

  // X labels
  years.forEach(function(y,i){
    html+='<text x="'+xP(i)+'" y="'+(cH-6)+'" fill="#999" font-size="10" text-anchor="middle" font-family="DM Sans">'+y.label+'</text>';
  });

  // Axis titles
  html+='<text x="10" y="'+(pT+plotH/2)+'" fill="#d4a025" font-size="9" text-anchor="middle" font-family="DM Sans" transform="rotate(-90,10,'+(pT+plotH/2)+')">Real ROIC</text>';
  html+='<text x="'+(cW-6)+'" y="'+(pT+plotH/2)+'" fill="#3498db" font-size="9" text-anchor="middle" font-family="DM Sans" transform="rotate(90,'+(cW-6)+','+(pT+plotH/2)+')">Real Profit</text>';

  // Profit bars
  var barW=Math.min(36,plotW/n*0.5);
  var zeroY=yP(0);
  years.forEach(function(y,i){
    var bx=xP(i)-barW/2;
    var by=yP(y.realProfit);
    var topY=Math.min(by,zeroY);
    var bh=Math.abs(by-zeroY);
    var barColor=y.realProfit>=0?'rgba(52,152,219,0.35)':'rgba(231,76,60,0.35)';
    var barStroke=y.realProfit>=0?'#3498db':'#e74c3c';
    html+='<rect x="'+bx+'" y="'+topY+'" width="'+barW+'" height="'+bh+'" fill="'+barColor+'" stroke="'+barStroke+'" stroke-width="1" rx="3"/>';
  });

  // ROIC line
  if(n>1){
    var path=years.map(function(y,i){return (i===0?'M':'L')+xP(i).toFixed(1)+','+yR(y.realROIC).toFixed(1)}).join(' ');
    html+='<path d="'+path+'" fill="none" stroke="#d4a025" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>';
  }
  years.forEach(function(y,i){
    html+='<circle cx="'+xP(i)+'" cy="'+yR(y.realROIC)+'" r="4" fill="#d4a025" stroke="#0f0f0f" stroke-width="2"/>';
    html+='<text x="'+xP(i)+'" y="'+(yR(y.realROIC)-10)+'" fill="#d4a025" font-size="10" text-anchor="middle" font-family="JetBrains Mono" font-weight="600">'+pct(y.realROIC,1)+'</text>';
  });
  html+='</svg>';
  html+='<div class="chart-legend"><span><span class="dot" style="background:#d4a025"></span> Real ROIC (left axis)</span><span><span class="dot" style="background:#3498db"></span> Real Profit (right axis)</span></div>';

  // Trend data table
  html+='<table class="trend-table"><tr><th style="text-align:left">Metric</th>';
  years.forEach(function(y){html+='<th>'+y.label+'</th>'});
  html+='<th>Trend</th></tr>';

  var trendRows=[
    {label:'Real Profit',key:'realProfit',f:fmtM},
    {label:'CFO',key:'cfo',f:fmtM},
    {label:'Real SBC',key:'realSBC',f:fmtM,inv:true},
    {label:'Total CapEx',key:'capex',f:fmtM,inv:true},
    {label:'Maint CapEx',key:'maintCapex',f:fmtM},
    {label:'Growth CapEx',key:'growthCapex',f:fmtM},
    {label:'Invested Capital',key:'investedCapital',f:fmtM},
    {label:'Real ROIC',key:'realROIC',f:function(v){return pct(v,1)}},
    {label:'Reported FCF',key:'reportedFCF',f:fmtM}
  ];
  if(years.some(function(y){return y.revenue})){
    trendRows.unshift({label:'Revenue',key:'revenue',f:fmtM});
  }

  trendRows.forEach(function(row){
    var vals=years.map(function(y){return y[row.key]});
    var first=vals[0],last=vals[vals.length-1];
    var trendClass='',trendText='‚Äî';
    if(first!=null&&last!=null&&Math.abs(first)>0){
      var ch=(last-first)/Math.abs(first);
      if(ch>0.05){trendClass=row.inv?'trend-down':'trend-up';trendText='‚Üë '+pct(ch,0);}
      else if(ch<-0.05){trendClass=row.inv?'trend-up':'trend-down';trendText='‚Üì '+pct(Math.abs(ch),0);}
      else trendText='‚Üí flat';
    }
    html+='<tr class="'+trendClass+'"><td>'+row.label+'</td>';
    vals.forEach(function(v){html+='<td>'+(v!=null?row.f(v):'‚Äî')+'</td>'});
    html+='<td class="trend-val" style="font-family:DM Sans;font-size:.75rem">'+trendText+'</td></tr>';
  });
  html+='</table>';

  // ============ Growth Decomposition ============
  if(years.length>=2){
    html+='<h3 style="color:var(--accent);margin:24px 0 8px;padding-top:16px;border-top:1px solid #333;font-size:.95rem">üî¨ Growth Decomposition</h3>';
    html+='<p style="font-size:.78rem;color:var(--text3);margin-bottom:16px">Where is profit growth coming from? Reinvestment engine (growth CapEx earning returns) vs. organic engine (existing base getting more productive).</p>';

    // For each year-over-year transition
    var decompData=[];
    for(var di=1;di<years.length;di++){
      var prev=years[di-1],curr=years[di];
      var profitChange=curr.realProfit-prev.realProfit;
      // Estimate reinvestment contribution: prior year growth capex * prior year ROIC
      // This assumes 1 year lag for growth capex to start earning
      var reinvestContrib=prev.growthCapex*prev.realROIC;
      var organicContrib=profitChange-reinvestContrib;
      decompData.push({
        from:prev.label,to:curr.label,
        profitChange:profitChange,
        reinvest:reinvestContrib,
        organic:organicContrib,
        prevProfit:prev.realProfit,
        currProfit:curr.realProfit,
        totalGrowthPct:prev.realProfit!==0?profitChange/Math.abs(prev.realProfit):0,
        capitalGrowthPct:(prev.investedCapital!==0)?(curr.investedCapital-prev.investedCapital)/Math.abs(prev.investedCapital):0
      });
    }

    // Summary metrics across all periods
    var totalProfitGrowth=years[years.length-1].realProfit-years[0].realProfit;
    var totalReinvest=decompData.reduce(function(s,d){return s+d.reinvest},0);
    var totalOrganic=decompData.reduce(function(s,d){return s+d.organic},0);
    var profitCAGR=years[0].realProfit>0?Math.pow(years[years.length-1].realProfit/years[0].realProfit,1/(years.length-1))-1:0;
    var capitalCAGR=years[0].investedCapital>0?Math.pow(years[years.length-1].investedCapital/years[0].investedCapital,1/(years.length-1))-1:0;

    // Capital efficiency ratio
    var efficiencyRatio=(capitalCAGR>0&&profitCAGR>0)?(profitCAGR/capitalCAGR):0;

    // Summary boxes
    html+='<div class="decomp-summary">';
    html+='<div class="decomp-stat"><div class="ds-val total-color">'+pct(profitCAGR,1)+'</div><div class="ds-lbl">Profit CAGR</div></div>';
    html+='<div class="decomp-stat"><div class="ds-val" style="color:var(--text2)">'+pct(capitalCAGR,1)+'</div><div class="ds-lbl">Capital CAGR</div></div>';
    html+='<div class="decomp-stat"><div class="ds-val '+(efficiencyRatio>=1?'organic-color':'neg-color')+'">'+efficiencyRatio.toFixed(2)+'x</div><div class="ds-lbl">Profit / Capital Growth</div></div>';
    html+='</div>';

    // Stacked bars for each period
    decompData.forEach(function(d){
      var absTotal=Math.abs(d.reinvest)+Math.abs(d.organic);
      if(absTotal===0)return;
      var reinvestPct=Math.abs(d.reinvest)/absTotal*100;
      var organicPct=Math.abs(d.organic)/absTotal*100;

      html+='<div class="decomp-row">';
      html+='<div class="decomp-label">'+d.from+' ‚Üí '+d.to+'</div>';
      html+='<div class="decomp-bar-track">';
      if(d.reinvest!==0){
        html+='<div class="decomp-seg reinvest" style="width:'+reinvestPct+'%" title="Reinvestment: '+fmtM(d.reinvest)+'">'+fmtM(d.reinvest)+'</div>';
      }
      if(d.organic!==0){
        var orgClass=d.organic>=0?'organic':'negative-organic';
        html+='<div class="decomp-seg '+orgClass+'" style="width:'+organicPct+'%" title="Organic: '+fmtM(d.organic)+'">'+(d.organic>=0?'+':'')+fmtM(d.organic)+'</div>';
      }
      html+='</div>';
      html+='</div>';

      // Period detail line
      html+='<div style="font-size:.72rem;color:var(--text3);margin:-4px 0 12px 120px">Œî Profit: '+fmtM(d.profitChange)+' ('+pct(d.totalGrowthPct,1)+') ¬∑ Capital grew '+pct(d.capitalGrowthPct,1)+'</div>';
    });

    // Legend
    html+='<div class="chart-legend" style="margin:12px 0"><span><span class="dot" style="background:#9b59b6"></span> Reinvestment engine (Growth CapEx √ó ROIC)</span><span><span class="dot" style="background:#2ecc71"></span> Organic growth (base productivity)</span></div>';

    // Interpretive narrative
    var avgOrganicPct=totalProfitGrowth!==0?totalOrganic/Math.abs(totalProfitGrowth):0;
    var narrative2='';
    if(avgOrganicPct>0.6){
      narrative2='<strong>Organic-Led Growth:</strong> ~'+Math.round(avgOrganicPct*100)+'% of profit growth comes from the existing base getting more productive ‚Äî pricing power, expanding margins, or growing users. This is high-quality growth that requires less capital to sustain.';
    }else if(avgOrganicPct>0.3){
      narrative2='<strong>Balanced Growth:</strong> Profit growth is split between organic improvement (~'+Math.round(avgOrganicPct*100)+'%) and reinvestment returns. Both engines are contributing, which is healthy.';
    }else if(avgOrganicPct>=0){
      narrative2='<strong>Reinvestment-Led Growth:</strong> Most profit growth (~'+Math.round((1-avgOrganicPct)*100)+'%) comes from growth CapEx earning returns. The existing base is stable but not expanding much on its own. Growth sustainability depends heavily on continued high-ROIC investment opportunities.';
    }else{
      narrative2='<strong>Base Erosion Alert:</strong> The organic base is actually shrinking ‚Äî existing operations are becoming less profitable. Growth CapEx is masking the decline. Watch for competitive pressure or margin compression in the core business.';
    }
    if(efficiencyRatio>=1.5){
      narrative2+=' The profit-to-capital growth ratio of '+efficiencyRatio.toFixed(1)+'x is excellent ‚Äî profit is growing significantly faster than capital deployed.';
    }else if(efficiencyRatio<0.8&&efficiencyRatio>0){
      narrative2+=' Profit is growing slower than capital ('+efficiencyRatio.toFixed(1)+'x) ‚Äî incremental returns may be dilutive.';
    }
    html+='<div class="flag '+(avgOrganicPct>0.3?'ok':avgOrganicPct>=0?'caution':'warn')+'" style="margin-top:12px">'+narrative2+'</div>';
    html+='<p class="section-note" style="margin-top:8px">Reinvestment contribution estimated as prior year Growth CapEx √ó ROIC (assumes ~1 year lag). Organic = total profit change minus reinvestment contribution.</p>';
  }

  // ROIC trajectory narrative
  if(years.length>=2){
    var fR=years[0].realROIC,lR=years[years.length-1].realROIC;
    var rCh=lR-fR;
    var rPctCh=Math.abs(fR)>0?rCh/Math.abs(fR):0;
    var narrative='';
    if(Math.abs(rPctCh)<0.05){
      narrative='<strong>Stable ROIC:</strong> Real ROIC held at ~'+pct(lR,1)+' over '+years.length+' years. The company is maintaining returns even as invested capital grows ‚Äî a positive signal.';
    }else if(rCh>0){
      narrative='<strong>Improving ROIC:</strong> From '+pct(fR,1)+' to '+pct(lR,1)+' (+'+(rCh*100).toFixed(1)+'pp). Growth CapEx appears to be creating value.';
    }else{
      narrative='<strong>Compressing ROIC:</strong> From '+pct(fR,1)+' to '+pct(lR,1)+' ('+(rCh*100).toFixed(1)+'pp). New investments may be earning lower returns ‚Äî scrutinize growth CapEx quality.';
    }
    html+='<div class="flag info" style="margin-top:12px">'+narrative+'</div>';
  }

  document.getElementById('trendContent').innerHTML=html;
}

// ============ Main Calculate ============
function calculate(){
  var ticker=document.getElementById('ticker').value||'Company';
  var price=v('price');
  var cfo=v('cfo');
  var sbcExp=v('sbc_expense')||0;
  var sbcGrant=v('sbc_grant')||0;
  var capex=v('capex')||0;
  var da=v('da')||0;
  var maintCapexInput=v('maint_capex');
  var restructuring=v('restructuring')||0;
  var invChange=v('inv_change')||0;
  var recvChange=v('recv_change')||0;
  var interest=v('interest')||0;
  var taxPaid=v('tax_paid')||0;
  var debt=v('debt')||0;
  var cash=v('cash')||0;
  var sti=v('sti')||0;
  var shares=v('shares');
  var ltInvestments=v('lt_investments')||0;
  var invReturnRate=(v('inv_return_rate')||4)/100;
  var equity=v('equity')||0;
  var totalAssets=v('total_assets')||0;

  if(!price||!cfo||!shares){alert('Please fill in at least: Share Price, CFO, and Diluted Shares.');return;}

  if(currentYearKey&&yearStore[currentYearKey])yearStore[currentYearKey].formData=captureForm();

  var maintCapex,maintMethod;
  if(maintCapexInput!==null&&maintCapexInput>0){maintCapex=maintCapexInput;maintMethod='Disclosed';}
  else{var ratio=da>0?capex/da:999;if(ratio>=0.8&&ratio<=1.2){maintCapex=capex;maintMethod='CapEx ‚âà D&A ‚Üí using total CapEx';}else{maintCapex=da*1.05;maintMethod='D&A + 5% inflation buffer';}}

  var realSBC=Math.max(sbcExp,sbcGrant);
  var sbcSource=sbcGrant>sbcExp?'Grant Value (higher)':'Expense';
  var wcDrag=invChange+recvChange;
  var investmentIncome=ltInvestments*invReturnRate;
  var realProfit=cfo-realSBC-maintCapex-restructuring+investmentIncome;
  var unleverProfit=realProfit+interest;
  var marketCap=price*shares;
  var ev=marketCap+debt-(cash+sti);
  var realYield=realProfit/ev;
  var unleverYield=unleverProfit/ev;
  var realPE=price/(realProfit/shares);
  var reportedFCF=cfo-capex;
  var gap=realProfit-reportedFCF;
  var growthCapex=Math.max(capex-maintCapex,0);
  var investedCapital=equity>0?(equity+debt-cash-sti):0;
  var realROIC=investedCapital>0?realProfit/investedCapital:0;

  var rating,ratingClass;
  if(realYield>=0.07){rating='Strong Value';ratingClass='strong';}
  else if(realYield>=0.04){rating='Fair Value';ratingClass='fair';}
  else if(realYield>=0.02){rating='Growth Priced In';ratingClass='growth';}
  else{rating='Expensive';ratingClass='expensive';}

  document.getElementById('verdict').className='verdict '+ratingClass;
  document.getElementById('verdict').innerHTML='<div class="yield-num">'+pct(realYield)+'</div><div class="yield-label">Real Cash Yield on EV ‚Äî '+ticker+'</div><div class="rating">'+rating+'</div>';

  var metricsData=[
    {label:'Real Economic Profit',value:fmtM(realProfit),sub:fmt(realProfit/shares,2)+'/share',hl:true},
    {label:'Unlevered Yield',value:pct(unleverYield)},
    {label:'Real P/E',value:realPE>0?realPE.toFixed(1)+'x':'N/A'},
    {label:'Enterprise Value',value:fmtM(ev)},
    {label:'Reported FCF',value:fmtM(reportedFCF)},
    {label:'Real vs Reported Gap',value:fmtM(gap),neg:gap<0}
  ];
  document.getElementById('metricsGrid').innerHTML=metricsData.map(function(m){
    return '<div class="metric'+(m.hl?' highlight':'')+'"><div class="val" '+(m.neg?'style="color:var(--red)"':'')+'>'+m.value+'</div><div class="lbl">'+m.label+(m.sub?' ¬∑ '+m.sub:'')+'</div></div>';
  }).join('');

  // Waterfall
  var wfItems=[{label:'CFO',value:cfo,type:'positive'},{label:'‚àí Real SBC',value:-realSBC,type:'negative'},{label:'‚àí Maint CapEx',value:-maintCapex,type:'negative'},{label:'‚àí Restructuring',value:-restructuring,type:'negative'}];
  if(investmentIncome>0)wfItems.push({label:'+ Invest. Income',value:investmentIncome,type:'invest'});
  wfItems.push({label:'= Real Profit',value:realProfit,type:'result'});
  var maxVal=Math.max.apply(null,wfItems.map(function(w){return Math.abs(w.value)}).concat([1]));
  document.getElementById('waterfall').innerHTML=wfItems.map(function(w){
    var width=Math.max(Math.abs(w.value)/maxVal*100,8);
    return '<div class="wf-bar"><span class="wf-label">'+w.label+'</span><div class="wf-track"><div class="wf-fill '+w.type+'" style="width:'+width+'%">'+fmtM(Math.abs(w.value))+'</div></div></div>';
  }).join('');

  // ROIC section
  var roicCard=document.getElementById('roicCard');
  if(equity>0&&growthCapex>0){
    roicCard.style.display='block';
    document.getElementById('roicMetrics').innerHTML=[
      {label:'Real ROIC',value:pct(realROIC),sub:'Real Profit √∑ Invested Capital'},
      {label:'Invested Capital',value:fmtM(investedCapital),sub:'Equity + Debt ‚àí Cash ‚àí STI'},
      {label:'Growth CapEx',value:fmtM(growthCapex),sub:'Total CapEx ‚àí Maint CapEx'},
      {label:'Maint CapEx',value:fmtM(maintCapex),sub:maintMethod}
    ].map(function(m){return '<div class="metric"><div class="val">'+m.value+'</div><div class="lbl">'+m.label+' ¬∑ '+m.sub+'</div></div>'}).join('');

    var scenarios=[{label:'Bear (10%)',roic:0.10},{label:'Base (ROIC: '+pct(realROIC,0)+')',roic:realROIC},{label:'Bull (25%)',roic:0.25}];
    if(realROIC<=0.10)scenarios[1]={label:'Base (15%)',roic:0.15};
    if(realROIC>=0.25)scenarios[1]={label:'Base (ROIC: '+pct(realROIC,0)+')',roic:realROIC};

    var projHTML='<p style="font-size:.82rem;color:var(--text2);margin-bottom:12px">If growth CapEx of <strong style="color:var(--text)">'+fmtM(growthCapex)+'/yr</strong> earns a given return, what will the real yield become?</p>';
    projHTML+='<table class="proj-table"><tr><th style="text-align:left">Scenario</th><th>New Profit (Yr 3)</th><th>Yield (Yr 3)</th><th>New Profit (Yr 5)</th><th>Yield (Yr 5)</th></tr>';
    scenarios.forEach(function(s,i){
      var a3=growthCapex*s.roic*3,a5=growthCapex*s.roic*5;
      var p3=realProfit+a3,p5=realProfit+a5;
      var y3=p3/ev,y5=p5/ev;
      var cls=i===1?' class="highlight-row"':'';
      projHTML+='<tr'+cls+'><td>'+s.label+'</td><td>'+fmtM(p3)+'</td><td>'+pct(y3)+'</td><td>'+fmtM(p5)+'</td><td>'+pct(y5)+'</td></tr>';
    });
    projHTML+='</table><p class="section-note">Assumes constant EV (no price change) and cumulative returns on annual growth CapEx.</p>';
    document.getElementById('growthProjection').innerHTML=projHTML;
  }else{
    roicCard.style.display=equity>0?'block':'none';
    if(equity>0){
      document.getElementById('roicMetrics').innerHTML='<div class="metric"><div class="val">'+pct(realROIC)+'</div><div class="lbl">Real ROIC ¬∑ Real Profit √∑ Invested Capital</div></div><div class="metric"><div class="val">'+fmtM(investedCapital)+'</div><div class="lbl">Invested Capital ¬∑ Equity + Debt ‚àí Cash ‚àí STI</div></div>';
      document.getElementById('growthProjection').innerHTML='<p style="font-size:.82rem;color:var(--text3)">No material growth CapEx detected (CapEx ‚âà D&A). ROIC shown above reflects return on existing capital base.</p>';
    }
  }

  // Breakdown table
  var rows=[
    ['Cash From Operations',fmt(cfo,0)+'M',''],
    ['SBC Expense (addback)',fmt(sbcExp,0)+'M','Included in CFO'],
    ['SBC Grant Value',fmt(sbcGrant,0)+'M',sbcGrant>0?'From Notes':'Not provided'],
    ['Real SBC Burden (MAX)',fmt(realSBC,0)+'M',sbcSource,'negative'],
    ['Total CapEx',fmt(capex,0)+'M',''],
    ['Depreciation & Amortization',fmt(da,0)+'M',''],
    ['Real Maintenance CapEx',fmt(maintCapex,0)+'M',maintMethod,'negative'],
    ['Growth CapEx',fmt(growthCapex,0)+'M','Total CapEx ‚àí Maint CapEx'],
    ['Restructuring',fmt(restructuring,0)+'M',restructuring===0?'None reported':'','negative'],
    ['Working Capital Drag',fmt(Math.abs(wcDrag),0)+'M',wcDrag<0?'Cash trapped':'Cash released',wcDrag<0?'negative':'positive'],
    ['Inventory Change',fmt(Math.abs(invChange),0)+'M',invChange<0?'Trapped':'Released'],
    ['Receivables Change',fmt(Math.abs(recvChange),0)+'M',recvChange<0?'Not collected':'Collected']
  ];
  if(ltInvestments>0){
    rows.push(['Non-Cash LT Investments',fmt(ltInvestments,0)+'M','Balance']);
    rows.push(['Expected Return Rate',pct(invReturnRate),'Applied to LT investments']);
    rows.push(['Investment Income Credit','+'+fmt(investmentIncome,0)+'M','Added to Real Profit','positive']);
  }
  rows.push(['','','','']);
  rows.push(['Real Economic Profit',fmt(realProfit,0)+'M','CFO ‚àí SBC ‚àí MaintCapex ‚àí Restruct'+(investmentIncome>0?' + Invest Income':''),'subtotal']);
  rows.push(['Reported FCF',fmt(reportedFCF,0)+'M','CFO ‚àí Total CapEx']);
  rows.push(['Gap (Real ‚àí Reported)',fmt(gap,0)+'M',gap<0?'Reported overstates profit':'Real exceeds reported',gap<0?'negative':'positive']);
  rows.push(['Interest Paid',fmt(interest,0)+'M','']);
  rows.push(['Unlevered Profit',fmt(unleverProfit,0)+'M','Real Profit + Interest']);
  rows.push(['Enterprise Value',fmtM(ev),'Mkt Cap + Debt ‚àí Cash ‚àí STI']);
  rows.push(['Market Cap',fmtM(marketCap),'Price √ó Shares']);
  if(equity>0){
    rows.push(['Shareholders Equity',fmtM(equity),'Balance sheet']);
    rows.push(['Invested Capital',fmtM(investedCapital),'Equity + Debt ‚àí Cash ‚àí STI']);
    rows.push(['Real ROIC',pct(realROIC),'Real Profit √∑ Invested Capital']);
  }

  var tableHTML='<tr><th>Line Item</th><th>Notes</th><th>Value</th></tr>';
  rows.forEach(function(r){
    if(!r[0]&&!r[1])return;
    var cls='';
    if(r[3]==='negative')cls=' class="negative"';if(r[3]==='positive')cls=' class="positive"';if(r[3]==='subtotal')cls=' class="subtotal"';
    tableHTML+='<tr'+cls+'><td>'+r[0]+'</td><td style="color:var(--text3)">'+(r[2]||'')+'</td><td>'+r[1]+'</td></tr>';
  });
  document.getElementById('breakdown').innerHTML=tableHTML;

  // Red Flags
  var flags=[];
  if(sbcGrant>0&&sbcGrant>sbcExp*1.2){
    var ratio=(sbcGrant/sbcExp).toFixed(1);
    flags.push({type:'warn',text:'<strong>‚ö† Hidden SBC Dilution:</strong> Grant Value is '+ratio+'x the expensed amount ‚Äî significant shareholder dilution not reflected in reported earnings.'});
  }
  if(sbcGrant>0&&sbcExp>sbcGrant*1.1){
    flags.push({type:'info',text:'<strong>‚Ñπ SBC Note:</strong> Expense ('+fmtM(sbcExp)+') exceeds Grant Value ('+fmtM(sbcGrant)+') ‚Äî older, cheaper grants being amortized. Current dilution is actually less than expensed.'});
  }
  var sbcPctCFO=realSBC/cfo;
  if(sbcPctCFO>0.3){flags.push({type:'warn',text:'<strong>‚ö† SBC as % of CFO:</strong> '+pct(sbcPctCFO,1)+' ‚Äî shareholders are funding a large portion of employee compensation.'});}
  else if(sbcPctCFO>0.15){flags.push({type:'caution',text:'<strong>‚ö° SBC as % of CFO:</strong> '+pct(sbcPctCFO,1)+' ‚Äî moderate but worth watching.'});}
  else{flags.push({type:'ok',text:'<strong>‚úì SBC as % of CFO:</strong> '+pct(sbcPctCFO,1)+' ‚Äî reasonable level.'});}
  if(restructuring>0){
    var restPct=restructuring/cfo;
    flags.push({type:restPct>0.05?'warn':'caution',text:'<strong>'+(restPct>0.05?'‚ö†':'‚ö°')+' Restructuring:</strong> '+fmt(restructuring,0)+'M ('+pct(restPct,1)+' of CFO) ‚Äî '+(restPct>0.05?'serial restructurer, treat as ongoing cost':'one-time charges reduce real profit')+'.'});
  }
  if(wcDrag<-1000){flags.push({type:'caution',text:'<strong>‚ö° Working Capital Drag:</strong> '+fmt(Math.abs(wcDrag),0)+'M consumed ‚Äî cash trapped in inventory/receivables.'});}
  else if(wcDrag>1000){flags.push({type:'ok',text:'<strong>‚úì Working Capital:</strong> Released '+fmt(wcDrag,0)+'M ‚Äî positive cash conversion.'});}
  if(debt>0&&realProfit>0){
    var debtRatio=debt/realProfit;
    if(debtRatio>8)flags.push({type:'warn',text:'<strong>‚ö† High Leverage:</strong> Debt is '+debtRatio.toFixed(1)+'x real profit ‚Äî significant leverage risk.'});
    else if(debtRatio>4)flags.push({type:'caution',text:'<strong>‚ö° Moderate Leverage:</strong> Debt is '+debtRatio.toFixed(1)+'x real profit.'});
    else flags.push({type:'ok',text:'<strong>‚úì Leverage:</strong> Debt is '+debtRatio.toFixed(1)+'x real profit ‚Äî manageable.'});
  }
  if(ltInvestments>0){
    var invPctEV=ltInvestments/ev;
    flags.push({type:'info',text:'<strong>‚Ñπ Investment Portfolio:</strong> '+fmtM(ltInvestments)+' in long-term investments ('+pct(invPctEV,1)+' of EV). Credited '+fmtM(investmentIncome)+'/yr at '+pct(invReturnRate)+' assumed return.'});
  }
  if(equity>0&&realROIC>0){
    if(realROIC>0.20)flags.push({type:'ok',text:'<strong>‚úì Real ROIC:</strong> '+pct(realROIC)+' ‚Äî exceptional returns on invested capital. Growth CapEx likely value-creating.'});
    else if(realROIC>0.12)flags.push({type:'ok',text:'<strong>‚úì Real ROIC:</strong> '+pct(realROIC)+' ‚Äî solid returns above cost of capital.'});
    else if(realROIC>0.06)flags.push({type:'caution',text:'<strong>‚ö° Real ROIC:</strong> '+pct(realROIC)+' ‚Äî moderate. Growth spending may not create significant value.'});
    else flags.push({type:'warn',text:'<strong>‚ö† Real ROIC:</strong> '+pct(realROIC)+' ‚Äî below typical cost of capital. Growth CapEx may be destroying value.'});
  }
  if(growthCapex>0&&growthCapex>maintCapex){
    var growthPct=growthCapex/capex;
    flags.push({type:'growth',text:'<strong>üöÄ Growth Investment:</strong> '+fmtM(growthCapex)+' ('+pct(growthPct,0)+' of total CapEx) is growth spending beyond maintenance. '+(realROIC>0.15?'At current ROIC, this should generate '+fmtM(growthCapex*realROIC)+'/yr in new profit.':'See projection table above for return scenarios.')});
  }
  if(realYield>=0.07)flags.push({type:'ok',text:'<strong>‚úì Yield Assessment:</strong> '+pct(realYield)+' real yield is strong ‚Äî business generating substantial cash relative to its price.'});
  else if(realYield>=0.04)flags.push({type:'ok',text:'<strong>‚úì Yield Assessment:</strong> '+pct(realYield)+' real yield is fair ‚Äî reasonable cash generation for the price.'});
  else if(realYield>=0.02)flags.push({type:'caution',text:'<strong>‚ö° Yield Assessment:</strong> '+pct(realYield)+' real yield means growth is priced in ‚Äî need significant earnings growth to justify.'});
  else flags.push({type:'warn',text:'<strong>‚ö† Yield Assessment:</strong> '+pct(realYield)+' real yield is expensive ‚Äî market pricing in exceptional future growth.'});

  document.getElementById('flags').innerHTML=flags.map(function(f){return '<div class="flag '+f.type+'">'+f.text+'</div>'}).join('');
  document.getElementById('results').style.display='block';

  // Render trend
  renderTrend();

  document.getElementById('results').scrollIntoView({behavior:'smooth',block:'start'});
}
</script>
</body>
</html>
