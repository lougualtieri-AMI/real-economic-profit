<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Real Economic Profit Analyzer</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0f0f0f;--card:#1a1a1a;--card2:#222;--border:#333;
  --text:#e8e8e8;--text2:#999;--text3:#666;
  --accent:#d4a025;--accent2:#f0c040;--accent-dim:#8b6914;
  --green:#2ecc71;--red:#e74c3c;--blue:#3498db;--orange:#e67e22;--purple:#9b59b6;
  --radius:12px;
}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);line-height:1.6;padding:16px;max-width:800px;margin:0 auto}
h1{font-size:1.6rem;font-weight:700;color:var(--accent2);text-align:center;margin:20px 0 4px}
.subtitle{text-align:center;color:var(--text2);font-size:.85rem;margin-bottom:24px}
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:20px;margin-bottom:16px}
.card h2{font-size:1.05rem;font-weight:600;color:var(--accent);margin-bottom:16px;padding-bottom:8px;border-bottom:1px solid var(--border)}
.card h3{font-size:.9rem;font-weight:600;color:var(--text2);margin:16px 0 8px;text-transform:uppercase;letter-spacing:.5px}
.field{margin-bottom:12px}
.field label{display:block;font-size:.82rem;color:var(--text2);margin-bottom:4px;font-weight:500}
.field input{width:100%;padding:10px 12px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:.9rem;transition:border-color .2s}
.field input:focus{outline:none;border-color:var(--accent)}
.field .hint{font-size:.72rem;color:var(--text3);margin-top:2px}
.row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
button.calc{width:100%;padding:14px;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#000;font-family:'DM Sans',sans-serif;font-size:1rem;font-weight:700;border:none;border-radius:var(--radius);cursor:pointer;margin:8px 0 20px;transition:transform .15s,box-shadow .15s}
button.calc:hover{transform:translateY(-1px);box-shadow:0 4px 20px rgba(212,160,37,.3)}
button.calc:active{transform:translateY(0)}
button.secondary{width:100%;padding:12px;background:var(--card2);border:1px solid var(--border);border-radius:var(--radius);color:var(--text2);font-family:'DM Sans',sans-serif;font-size:.9rem;font-weight:600;cursor:pointer;margin-bottom:8px;transition:border-color .2s,color .2s}
button.secondary:hover{border-color:var(--accent);color:var(--text)}
.modal-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);z-index:100;align-items:center;justify-content:center;padding:16px}
.modal-overlay.active{display:flex}
.modal{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:24px;max-width:600px;width:100%;max-height:80vh;overflow-y:auto}
.modal h3{color:var(--accent2);margin-bottom:12px;font-size:1.1rem}
.modal textarea{width:100%;height:200px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:.8rem;padding:12px;resize:vertical}
.modal textarea:focus{outline:none;border-color:var(--accent)}
.modal p{font-size:.82rem;color:var(--text2);margin-bottom:12px;line-height:1.5}
.modal .btn-row{display:flex;gap:8px;margin-top:12px}
.modal .btn-row button{flex:1;padding:10px;border-radius:8px;font-family:'DM Sans',sans-serif;font-weight:600;cursor:pointer;font-size:.9rem}
.modal .btn-import{background:var(--accent);color:#000;border:none}
.modal .btn-cancel{background:var(--card2);color:var(--text2);border:1px solid var(--border)}
.import-status{font-size:.82rem;margin-top:8px;padding:8px 12px;border-radius:6px;display:none}
.import-status.success{display:block;background:rgba(46,204,113,.1);color:var(--green)}
.import-status.error{display:block;background:rgba(231,76,60,.1);color:var(--red)}
.source-badge{display:inline-block;font-size:.65rem;padding:2px 6px;border-radius:4px;margin-left:6px;vertical-align:middle;font-weight:600}
.source-badge.annual{background:rgba(52,152,219,.15);color:var(--blue)}
.source-badge.balance{background:rgba(46,204,113,.15);color:var(--green)}
.verdict{text-align:center;padding:24px;border-radius:var(--radius);margin-bottom:16px}
.verdict .yield-num{font-family:'JetBrains Mono',monospace;font-size:2.4rem;font-weight:700;line-height:1.2}
.verdict .yield-label{font-size:.85rem;color:var(--text2);margin-top:4px}
.verdict .rating{display:inline-block;padding:4px 14px;border-radius:20px;font-size:.82rem;font-weight:600;margin-top:10px}
.verdict.strong{background:rgba(46,204,113,.08);border:1px solid rgba(46,204,113,.3)}
.verdict.strong .yield-num{color:var(--green)}
.verdict.strong .rating{background:rgba(46,204,113,.15);color:var(--green)}
.verdict.fair{background:rgba(52,152,219,.08);border:1px solid rgba(52,152,219,.3)}
.verdict.fair .yield-num{color:var(--blue)}
.verdict.fair .rating{background:rgba(52,152,219,.15);color:var(--blue)}
.verdict.growth{background:rgba(230,126,34,.08);border:1px solid rgba(230,126,34,.3)}
.verdict.growth .yield-num{color:var(--orange)}
.verdict.growth .rating{background:rgba(230,126,34,.15);color:var(--orange)}
.verdict.expensive{background:rgba(231,76,60,.08);border:1px solid rgba(231,76,60,.3)}
.verdict.expensive .yield-num{color:var(--red)}
.verdict.expensive .rating{background:rgba(231,76,60,.15);color:var(--red)}
.metrics{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px}
.metric{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:14px}
.metric .val{font-family:'JetBrains Mono',monospace;font-size:1.15rem;font-weight:600;color:var(--text)}
.metric .lbl{font-size:.75rem;color:var(--text2);margin-top:2px}
.metric.highlight .val{color:var(--accent2)}
.waterfall{margin:16px 0}
.wf-bar{display:flex;align-items:center;margin-bottom:6px;font-size:.82rem}
.wf-label{width:130px;text-align:right;padding-right:10px;color:var(--text2);flex-shrink:0;font-size:.78rem}
.wf-track{flex:1;height:28px;background:var(--bg);border-radius:6px;position:relative;overflow:hidden}
.wf-fill{height:100%;border-radius:6px;display:flex;align-items:center;padding:0 8px;font-family:'JetBrains Mono',monospace;font-size:.75rem;font-weight:500;color:#fff;white-space:nowrap;min-width:fit-content;transition:width .4s ease}
.wf-fill.positive{background:linear-gradient(90deg,#2ecc71,#27ae60)}
.wf-fill.negative{background:linear-gradient(90deg,#e74c3c,#c0392b)}
.wf-fill.invest{background:linear-gradient(90deg,var(--blue),#2980b9)}
.wf-fill.result{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#000}
.breakdown{width:100%;border-collapse:collapse;font-size:.82rem;margin:12px 0}
.breakdown th{text-align:left;padding:8px 6px;border-bottom:1px solid var(--border);color:var(--text2);font-weight:500;font-size:.75rem;text-transform:uppercase;letter-spacing:.3px}
.breakdown td{padding:8px 6px;border-bottom:1px solid rgba(51,51,51,.5)}
.breakdown td:last-child{text-align:right;font-family:'JetBrains Mono',monospace;font-weight:500}
.breakdown tr.subtotal td{border-top:2px solid var(--accent-dim);font-weight:600;color:var(--accent2)}
.breakdown tr.negative td:last-child{color:var(--red)}
.breakdown tr.positive td:last-child{color:var(--green)}
.flags{margin-top:12px}
.flag{padding:10px 14px;border-radius:8px;margin-bottom:8px;font-size:.82rem;line-height:1.5}
.flag.warn{background:rgba(231,76,60,.08);border-left:3px solid var(--red);color:#e8b4b0}
.flag.caution{background:rgba(230,126,34,.08);border-left:3px solid var(--orange);color:#e8cdb0}
.flag.ok{background:rgba(46,204,113,.08);border-left:3px solid var(--green);color:#b0e8c6}
.flag.info{background:rgba(52,152,219,.08);border-left:3px solid var(--blue);color:#b0d0e8}
.flag.growth{background:rgba(155,89,182,.08);border-left:3px solid var(--purple);color:#d0b0e8}
.proj-table{width:100%;border-collapse:collapse;font-size:.82rem;margin:12px 0}
.proj-table th{text-align:center;padding:8px 6px;border-bottom:1px solid var(--border);color:var(--text2);font-weight:500;font-size:.75rem}
.proj-table td{text-align:center;padding:10px 6px;border-bottom:1px solid rgba(51,51,51,.5);font-family:'JetBrains Mono',monospace;font-weight:500}
.proj-table td:first-child{text-align:left;font-family:'DM Sans',sans-serif;color:var(--text2)}
.proj-table tr.highlight-row td{color:var(--accent2);font-weight:600}
#results{display:none}
.section-note{font-size:.75rem;color:var(--text3);font-style:italic;margin-top:4px}
.tip-box{background:rgba(52,152,219,.06);border:1px solid rgba(52,152,219,.2);border-radius:8px;padding:12px 14px;margin-bottom:16px;font-size:.78rem;color:var(--text2);line-height:1.6}
.tip-box strong{color:var(--blue)}
.year-pills{display:flex;flex-wrap:wrap;gap:6px;margin:12px 0}
.year-pill{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;background:var(--card2);border:1px solid var(--border);border-radius:20px;font-size:.78rem;font-family:'JetBrains Mono',monospace;color:var(--text2);transition:all .2s}
.year-pill.current{border-color:var(--accent);color:var(--accent2);background:rgba(212,160,37,.08)}
.year-pill .remove-year{cursor:pointer;color:var(--text3);font-size:.7rem;padding:2px;transition:color .2s}
.year-pill .remove-year:hover{color:var(--red)}
.year-pill .load-year{cursor:pointer;padding:2px 4px}
.year-pill .load-year:hover{color:var(--accent2)}
.trend-table{width:100%;border-collapse:collapse;font-size:.78rem;margin:12px 0}
.trend-table-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch}
.trend-table th{text-align:center;padding:8px 6px;border-bottom:1px solid var(--border);color:var(--text2);font-weight:500;font-size:.72rem;text-transform:uppercase;white-space:nowrap}
.trend-table td{text-align:center;padding:8px 6px;border-bottom:1px solid rgba(51,51,51,.5);font-family:'JetBrains Mono',monospace;font-size:.78rem;white-space:nowrap}
.trend-table td:first-child{text-align:left;font-family:'DM Sans',sans-serif;color:var(--text2)}
.trend-table tr.trend-up td.trend-val{color:var(--green)}
.trend-table tr.trend-down td.trend-val{color:var(--red)}
.chart-legend{display:flex;flex-wrap:wrap;gap:12px;justify-content:center;margin-top:8px;font-size:.75rem}
.chart-legend span{display:flex;align-items:center;gap:4px;color:var(--text2)}
.chart-legend .dot{width:10px;height:10px;border-radius:50%;display:inline-block}

/* Growth decomposition */
.portfolio-bar{display:flex;flex-wrap:wrap;gap:6px;align-items:center;margin-bottom:12px;padding:12px 14px;background:var(--card);border:1px solid var(--border);border-radius:var(--radius)}
.portfolio-bar select{padding:8px 12px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:.85rem;flex:1;min-width:140px;max-width:280px}
.portfolio-bar select:focus{outline:none;border-color:var(--accent)}
.portfolio-bar .pb-btn{padding:6px 12px;background:var(--card2);border:1px solid var(--border);border-radius:6px;color:var(--text2);font-family:'DM Sans',sans-serif;font-size:.78rem;font-weight:500;cursor:pointer;transition:all .2s;white-space:nowrap}
.portfolio-bar .pb-btn:hover{border-color:var(--accent);color:var(--text)}
.portfolio-bar .pb-btn.save{background:rgba(212,160,37,.1);border-color:var(--accent-dim);color:var(--accent2)}
.portfolio-bar .pb-btn.save:hover{background:rgba(212,160,37,.2)}
.portfolio-bar .pb-btn.danger{color:var(--red)}
.portfolio-bar .pb-btn.danger:hover{border-color:var(--red);background:rgba(231,76,60,.1)}
.portfolio-bar .pb-label{font-size:.75rem;color:var(--text3);margin-right:4px}
.portfolio-bar .pb-sep{width:1px;height:20px;background:var(--border);margin:0 4px}
.compare-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.8);z-index:100;overflow-y:auto;padding:16px}
.compare-overlay.active{display:block}
.compare-panel{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);max-width:1100px;margin:0 auto;padding:24px;position:relative}
.compare-panel h3{color:var(--accent2);margin-bottom:16px;font-size:1.1rem}
.compare-table{width:100%;border-collapse:collapse;font-size:.82rem}
.compare-table-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch}
.compare-table th{padding:8px 10px;border-bottom:2px solid var(--border);color:var(--text2);font-weight:500;font-size:.72rem;text-transform:uppercase;white-space:nowrap;text-align:center;position:sticky;top:0;background:var(--card)}
.compare-table th:first-child{text-align:left}
.compare-table td{padding:8px 10px;border-bottom:1px solid rgba(51,51,51,.5);font-family:'JetBrains Mono',monospace;font-size:.82rem;text-align:center;white-space:nowrap}
.compare-table td:first-child{text-align:left;font-family:'DM Sans',sans-serif;color:var(--text2)}
.compare-table tr:hover td{background:rgba(212,160,37,.04)}
.compare-close{position:absolute;top:12px;right:16px;background:none;border:none;color:var(--text3);font-size:1.2rem;cursor:pointer;padding:4px 8px}
.compare-close:hover{color:var(--text)}
.decomp-row{display:flex;align-items:center;margin-bottom:10px;font-size:.82rem}
.decomp-label{width:110px;text-align:right;padding-right:10px;color:var(--text2);flex-shrink:0;font-size:.78rem}
.decomp-bar-track{flex:1;height:32px;background:var(--bg);border-radius:6px;position:relative;overflow:hidden;display:flex}
.decomp-seg{height:100%;display:flex;align-items:center;justify-content:center;font-family:'JetBrains Mono',monospace;font-size:.72rem;font-weight:500;color:#fff;white-space:nowrap;min-width:30px;transition:width .4s ease}
.decomp-seg.organic{background:linear-gradient(90deg,#2ecc71,#27ae60)}
.decomp-seg.reinvest{background:linear-gradient(90deg,#9b59b6,#8e44ad)}
.decomp-seg.negative-organic{background:linear-gradient(90deg,#e67e22,#d35400)}
.decomp-summary{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin:12px 0}
.decomp-stat{background:var(--bg);border-radius:8px;padding:10px 12px;text-align:center}
.decomp-stat .ds-val{font-family:'JetBrains Mono',monospace;font-size:1rem;font-weight:600}
.decomp-stat .ds-lbl{font-size:.72rem;color:var(--text3);margin-top:2px}
.decomp-stat .ds-val.organic-color{color:var(--green)}
.decomp-stat .ds-val.reinvest-color{color:var(--purple)}
.decomp-stat .ds-val.total-color{color:var(--accent2)}
.decomp-stat .ds-val.neg-color{color:var(--orange)}

/* Scorecard */
.scorecard-table{width:100%;border-collapse:collapse;font-size:.82rem}
.scorecard-table th{padding:10px 10px;border-bottom:2px solid var(--border);color:var(--text2);font-weight:600;font-size:.72rem;text-transform:uppercase;text-align:center;white-space:nowrap;position:sticky;top:0;background:var(--card)}
.scorecard-table th:first-child{text-align:left}
.scorecard-table td{padding:10px 10px;border-bottom:1px solid rgba(51,51,51,.5);font-family:'JetBrains Mono',monospace;font-size:.85rem;text-align:center;white-space:nowrap}
.scorecard-table td:first-child{text-align:left;font-family:'DM Sans',sans-serif;font-weight:600;color:var(--text)}
.scorecard-table tr:hover td{background:rgba(212,160,37,.04)}
.rank-1{color:var(--green);font-weight:700}
.rank-2{color:var(--accent2)}
.rank-3{color:var(--text2)}
.rank-4{color:var(--orange)}
.rank-5{color:var(--red)}
.rank-badge{display:inline-block;width:18px;height:18px;border-radius:50%;font-size:.65rem;line-height:18px;text-align:center;font-weight:700;margin-right:4px;font-family:'DM Sans',sans-serif}
.rank-badge.r1{background:rgba(46,204,113,.2);color:var(--green)}
.rank-badge.r2{background:rgba(212,160,37,.15);color:var(--accent2)}
.rank-badge.r3{background:rgba(153,153,153,.15);color:var(--text2)}
.rank-badge.r4{background:rgba(230,126,34,.15);color:var(--orange)}
.rank-badge.r5{background:rgba(231,76,60,.15);color:var(--red)}

/* Projections */
.proj-inputs{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin:12px 0}
.proj-inputs .field{margin-bottom:0}
.proj-inputs .field label{font-size:.75rem}
.proj-inputs .field input{padding:8px 10px;font-size:.82rem}
.proj-result-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin:16px 0}
.proj-result{background:var(--bg);border-radius:8px;padding:12px;text-align:center;border:1px solid var(--border)}
.proj-result .pr-val{font-family:'JetBrains Mono',monospace;font-size:1.1rem;font-weight:600}
.proj-result .pr-lbl{font-size:.72rem;color:var(--text3);margin-top:2px}
.proj-result .pr-delta{font-size:.72rem;margin-top:4px;font-family:'JetBrains Mono',monospace}
.proj-result .pr-delta.up{color:var(--green)}
.proj-result .pr-delta.down{color:var(--red)}
.proj-result .pr-delta.flat{color:var(--text3)}
.proj-toggle{background:none;border:1px solid var(--border);border-radius:8px;padding:8px 14px;color:var(--text2);font-family:'DM Sans',sans-serif;font-size:.82rem;cursor:pointer;transition:all .2s;width:100%}
.proj-toggle:hover{border-color:var(--accent);color:var(--text)}
.proj-toggle.active{border-color:var(--accent);color:var(--accent2)}

/* Company picker */
.picker-grid{display:flex;flex-wrap:wrap;gap:8px;margin:12px 0}
.picker-chip{display:flex;align-items:center;gap:6px;padding:8px 14px;background:var(--card2);border:2px solid var(--border);border-radius:8px;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:.85rem;color:var(--text2);transition:all .2s;user-select:none}
.picker-chip:hover{border-color:var(--accent-dim);color:var(--text)}
.picker-chip.selected{border-color:var(--accent);color:var(--accent2);background:rgba(212,160,37,.08)}
.picker-chip input{display:none}
.picker-check{width:16px;height:16px;border-radius:4px;border:2px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:.7rem;transition:all .2s}
.picker-chip.selected .picker-check{border-color:var(--accent);background:var(--accent);color:#000}
</style>
</head>
<body>

<h1>‚ö° Real Economic Profit Analyzer</h1>
<p class="subtitle">Cut through accounting noise ‚Äî find the real cash yield of a business</p>

<div class="portfolio-bar" id="portfolioBar">
  <span class="pb-label">Portfolio:</span>
  <select id="portfolioSelect" onchange="onPortfolioSelect()">
    <option value="">‚Äî New Company ‚Äî</option>
  </select>
  <button class="pb-btn save" onclick="saveToPortfolio()">üíæ Save</button>
  <button class="pb-btn" onclick="loadFromPortfolio()">üìÇ Load</button>
  <button class="pb-btn danger" onclick="deleteFromPortfolio()">üóë</button>
  <span class="pb-sep"></span>
  <button class="pb-btn" onclick="comparePortfolio()">üìä Compare</button>
  <button class="pb-btn" onclick="scorecardPortfolio()">üèÜ Scorecard</button>
  <span class="pb-sep"></span>
  <button class="pb-btn" onclick="downloadPortfolio()">‚¨á Backup</button>
  <button class="pb-btn" onclick="document.getElementById('portfolioFileInput').click()">‚¨Ü Restore</button>
  <input type="file" id="portfolioFileInput" accept=".json" style="display:none" onchange="restorePortfolio(event)">
  <span class="pb-sep"></span>
  <button class="pb-btn" onclick="openGlossary()">üìñ Glossary</button>
</div>

<button class="secondary" onclick="openImport()">üìã Import 10-K Data from Gemini</button>

<div id="yearPills" class="year-pills" style="display:none"></div>

<div class="tip-box">
  <strong>üí° Data sourcing:</strong> Use <strong>annual 10-K</strong> for all cash flow items. Use the <strong>latest 10-Q</strong> for balance sheet items. Feed both PDFs to Gemini and paste the JSON here. For <strong>multi-year trends</strong>, import each year's 10-K in separate Gemini chats ‚Äî the fiscal year is auto-detected.
</div>

<div class="card">
  <h2>üìä Phase 1 ‚Äî Cash Flow <span class="source-badge annual">from 10-K annual</span></h2>
  <div class="row" style="margin-bottom:12px">
    <div class="field"><label>Company / Ticker</label><input type="text" id="ticker" placeholder="e.g. AAPL"></div>
    <div class="field"><label>Current Share Price ($)</label><input type="number" id="price" step="0.01" placeholder="Look up live price"></div>
  </div>
  <h3>Operating Cash Flow</h3>
  <div class="field"><label>Cash From Operations ($M)</label><input type="number" id="cfo" step="1"></div>
  <div class="row">
    <div class="field"><label>SBC Expense Addback ($M)</label><input type="number" id="sbc_expense" step="1"><div class="hint">From cash flow statement</div></div>
    <div class="field"><label>SBC Grant Value ($M)</label><input type="number" id="sbc_grant" step="1"><div class="hint">Notes: RSUs granted √ó weighted avg grant date FV</div></div>
  </div>
  <h3>Capital Expenditures</h3>
  <div class="row3">
    <div class="field"><label>Total CapEx ($M)</label><input type="number" id="capex" step="1"></div>
    <div class="field"><label>D&A ($M)</label><input type="number" id="da" step="1"></div>
    <div class="field"><label>Maint. CapEx ($M)</label><input type="number" id="maint_capex" step="1" placeholder="If disclosed"><div class="hint">Leave blank to auto-estimate</div></div>
  </div>
  <div class="row">
    <div class="field"><label>Depreciation Only ($M)</label><input type="number" id="depr_only" step="1" placeholder="Optional"><div class="hint">Physical depreciation only (excl. intangible amortization). Enables asset-light view for acquisitive companies.</div></div>
    <div class="field"><label>Amortization ($M)</label><input type="number" id="amort_only" step="1" placeholder="Auto-calculated" readonly style="opacity:.6"><div class="hint">= D&A ‚àí Depreciation. Shows acquisition-related portion.</div></div>
  </div>
  <h3>Other Adjustments</h3>
  <div class="row">
    <div class="field"><label>Restructuring Charges ($M)</label><input type="number" id="restructuring" step="1" value="0"></div>
    <div class="field"><label>Inventory Change ($M)</label><input type="number" id="inv_change" step="1"><div class="hint">+ = cash freed ¬∑ ‚àí = cash trapped</div></div>
  </div>
  <div class="row">
    <div class="field"><label>Receivables Change ($M)</label><input type="number" id="recv_change" step="1"><div class="hint">+ = collected ¬∑ ‚àí = not collected</div></div>
    <div class="field"><label>Interest Paid ($M)</label><input type="number" id="interest" step="1"><div class="hint">Supplemental disclosure</div></div>
  </div>
  <div class="field"><label>Income Tax Paid ($M)</label><input type="number" id="tax_paid" step="1"><div class="hint">Supplemental disclosure</div></div>
</div>

<div class="card">
  <h2>üè¶ Phase 2 ‚Äî Balance Sheet <span class="source-badge balance">from latest 10-Q</span></h2>
  <div class="row">
    <div class="field"><label>Total Debt ($M)</label><input type="number" id="debt" step="1"><div class="hint">CP + current term + non-current term debt</div></div>
    <div class="field"><label>Cash & Equivalents ($M)</label><input type="number" id="cash" step="1"></div>
  </div>
  <div class="row">
    <div class="field"><label>Short-Term Investments ($M)</label><input type="number" id="sti" step="1" value="0"></div>
    <div class="field"><label>Diluted Shares Outstanding (M)</label><input type="number" id="shares" step="1"></div>
  </div>
  <h3>üìê ROIC Inputs</h3>
  <div class="row">
    <div class="field"><label>Total Shareholders' Equity ($M)</label><input type="number" id="equity" step="1"><div class="hint">Total stockholders' equity</div></div>
    <div class="field"><label>Total Assets ($M)</label><input type="number" id="total_assets" step="1"><div class="hint">Asset turnover context</div></div>
  </div>
  <div class="row">
    <div class="field"><label>Goodwill ($M)</label><input type="number" id="goodwill" step="1" value="0"><div class="hint">From balance sheet; 0 if none</div></div>
    <div class="field"><label>Intangible Assets ($M)</label><input type="number" id="intangibles" step="1" value="0"><div class="hint">Net intangible assets (excl. goodwill)</div></div>
  </div>
  <h3>üí∞ Investment Portfolio</h3>
  <div class="row">
    <div class="field"><label>Non-Cash LT Investments ($M)</label><input type="number" id="lt_investments" step="1" value="0"><div class="hint">Marketable securities, bond portfolios</div></div>
    <div class="field"><label>Expected Return (%)</label><input type="number" id="inv_return_rate" step="0.1" value="4"><div class="hint">Default 4%</div></div>
  </div>
  <p class="section-note">Investment income is added to Real Economic Profit as a credit.</p>
</div>

<button class="calc" onclick="calculate()">‚ö° Analyze Real Economic Profit</button>
<button class="secondary" id="exportBtn" onclick="exportBrief()" style="display:none">üì§ Export Analysis Brief (Google Docs / NotebookLM)</button>

<div id="results">
  <div id="verdict" class="verdict"></div>
  <div id="metricsGrid" class="metrics"></div>
  <div class="card"><h2>üìâ Profit Waterfall</h2><div id="waterfall" class="waterfall"></div></div>
  <div class="card" id="roicCard" style="display:none">
    <h2>üîÑ ROIC & Growth CapEx Analysis</h2>
    <div id="roicMetrics" class="metrics" style="margin-bottom:16px;grid-template-columns:1fr 1fr 1fr"></div>
    <div id="growthProjection"></div>
  </div>
  <div class="card" id="projCard" style="display:none">
    <h2>üîÆ Analyst Projections</h2>
    <button class="proj-toggle" id="projToggle" onclick="toggleProjections()">Enter forward estimates to project Real Profit, Yield & ROIC ‚ñº</button>
    <div id="projInputArea" style="display:none;margin-top:12px">
      <p style="font-size:.78rem;color:var(--text3);margin-bottom:8px">Enter buy-side or consensus estimates. Leave blank to skip. The app projects forward Real Economic Profit using your framework.</p>
      <h3 style="font-size:.8rem;color:var(--text2);margin-bottom:8px">Method 1: Revenue & Margin</h3>
      <div class="proj-inputs">
        <div class="field"><label>Fwd Revenue ($M)</label><input type="number" id="proj_revenue" step="1" placeholder="Next FY"></div>
        <div class="field"><label>Fwd CFO Margin (%)</label><input type="number" id="proj_cfo_margin" step="0.1" placeholder="CFO/Rev %"><div class="hint">Current shown after Analyze</div></div>
        <div class="field"><label>Fwd CapEx ($M)</label><input type="number" id="proj_capex" step="1" placeholder="Next FY est."></div>
      </div>
      <h3 style="font-size:.8rem;color:var(--text2);margin:12px 0 8px">Method 2: Direct Estimates</h3>
      <div class="proj-inputs">
        <div class="field"><label>Fwd CFO ($M)</label><input type="number" id="proj_cfo" step="1" placeholder="Direct CFO est."></div>
        <div class="field"><label>Fwd EPS ($)</label><input type="number" id="proj_eps" step="0.01" placeholder="Consensus EPS"></div>
        <div class="field"><label>Target Price ($)</label><input type="number" id="proj_target" step="0.01" placeholder="Analyst target"></div>
      </div>
      <h3 style="font-size:.8rem;color:var(--text2);margin:12px 0 8px">Assumptions</h3>
      <div class="proj-inputs">
        <div class="field"><label>Fwd SBC ($M)</label><input type="number" id="proj_sbc" step="1" placeholder="Same or grow %"></div>
        <div class="field"><label>Fwd D&A ($M)</label><input type="number" id="proj_da" step="1" placeholder="For maint est."></div>
        <div class="field"><label>Growth Rate Override (%)</label><input type="number" id="proj_growth" step="0.1" placeholder="Annual profit growth"></div>
      </div>
      <button class="calc" onclick="runProjections()" style="margin-top:12px;padding:10px;font-size:.9rem">üîÆ Project Forward</button>
      <div id="projResults"></div>
    </div>
  </div>
  <div class="card" id="trendCard" style="display:none">
    <h2>üìà Historical Trend</h2>
    <div id="trendContent"></div>
  </div>
  <div class="card"><h2>üìã Detailed Breakdown</h2><table id="breakdown" class="breakdown"></table></div>
  <div class="card"><h2>üö© Red Flags & Signals</h2><div id="flags" class="flags"></div></div>
</div>

<div class="modal-overlay" id="importModal">
  <div class="modal">
    <h3>üìã Import 10-K Data from Gemini</h3>
    <p>Paste the JSON output from Gemini. The fiscal year is auto-detected. For <strong>multi-year trends</strong>, import each year's 10-K separately (new Gemini chat each time). Enter <strong>ticker</strong> and <strong>share price</strong> manually.</p>
    <textarea id="jsonInput" placeholder='Paste Gemini JSON here...'></textarea>
    <div id="importStatus" class="import-status"></div>
    <div class="btn-row">
      <button class="btn-cancel" onclick="closeImport()">Cancel</button>
      <button class="btn-import" onclick="doImport()">Import & Fill</button>
    </div>
  </div>
</div>

<div class="compare-overlay" id="compareOverlay">
  <div class="compare-panel">
    <button class="compare-close" onclick="closeCompare()">‚úï Close</button>
    <h3>üìä Portfolio Comparison</h3>
    <div id="compareContent"></div>
  </div>
</div>

<div class="modal-overlay" id="pickerModal">
  <div class="modal" style="max-width:450px">
    <h3 id="pickerTitle">Select Companies</h3>
    <p style="margin-bottom:8px">Choose which companies to include:</p>
    <div id="pickerGrid" class="picker-grid"></div>
    <div class="btn-row" style="margin-top:16px">
      <button class="btn-cancel" onclick="closePicker()">Cancel</button>
      <button class="btn-import" id="pickerGoBtn" onclick="pickerGo()">Compare</button>
    </div>
  </div>
</div>

<div class="compare-overlay" id="scorecardOverlay">
  <div class="compare-panel">
    <button class="compare-close" onclick="closeScorecard()">‚úï Close</button>
    <h3>üèÜ Portfolio Scorecard</h3>
    <p style="font-size:.78rem;color:var(--text3);margin-bottom:16px">Ranked by each metric. <span class="rank-badge r1">1</span> = best in portfolio.</p>
    <div id="scorecardContent"></div>
  </div>
</div>

<div class="compare-overlay" id="glossaryOverlay">
  <div class="compare-panel" style="max-width:800px">
    <button class="compare-close" onclick="closeGlossary()">‚úï Close</button>
    <h3>üìñ Glossary & Definitions</h3>
    <p style="font-size:.78rem;color:var(--text3);margin-bottom:16px">All terms, acronyms, and custom metrics used in the Real Economic Profit Analyzer.</p>
    <div id="glossaryContent" style="font-size:.88rem;line-height:1.7;color:var(--text)">

      <h4 style="color:var(--accent);margin:20px 0 10px;font-size:.95rem;border-bottom:1px solid var(--border);padding-bottom:6px">Core Metrics</h4>

      <p><strong style="color:var(--accent2)">Real Economic Profit (REP)</strong><br>
      What a company actually earns in cash after accounting for true stock dilution, real asset maintenance, and one-time charges.<br>
      <span style="color:var(--text2);font-family:'JetBrains Mono',monospace;font-size:.82rem">= CFO ‚àí Real SBC ‚àí Maintenance CapEx ‚àí Restructuring + Investment Income</span></p>

      <p><strong style="color:var(--accent2)">Real Cash Yield</strong><br>
      Real Economic Profit √∑ Enterprise Value. Your real cash return on the market price. Above 7% = strong, 4‚Äì7% = fair, 2‚Äì4% = growth priced in, below 2% = expensive.</p>

      <p><strong style="color:var(--accent2)">Real ROIC</strong><br>
      Real Economic Profit √∑ Invested Capital. How efficiently the company uses deployed capital. Above 12% is strong; below 6% is concerning.</p>

      <p><strong style="color:var(--accent2)">Conservative vs. Asset-Light Views</strong><br>
      <em>Conservative:</em> Full D&A √ó 1.05 as maintenance CapEx ‚Äî penalizes acquisitive companies, which may be appropriate.<br>
      <em>Asset-Light:</em> Depreciation Only √ó 1.05, excluding intangible amortization from acquisitions. Better reflects actual cash needs for M&A-heavy companies since acquired intangibles (customer relationships, technology) don't require equivalent cash to maintain.</p>

      <p><strong style="color:var(--accent2)">Real SBC Burden</strong><br>
      MAX of SBC Expense (cash flow statement) or SBC Grant Date Fair Value (units granted √ó grant price). Captures true dilution cost ‚Äî the accounting expense often understates the economic value transferred to employees.</p>

      <p><strong style="color:var(--accent2)">Return on NTA</strong><br>
      Real Profit √∑ Net Tangible Assets (Total Assets ‚àí Goodwill ‚àí Intangibles ‚àí Cash ‚àí STI). Strips out acquisition premiums and buyback-compressed equity. Useful for comparing companies with different M&A and capital return histories.</p>

      <p><strong style="color:var(--accent2)">Real P/E</strong><br>
      Share Price √∑ Real Economic Profit per share. Alternative to traditional P/E using real profit instead of reported earnings.</p>

      <p><strong style="color:var(--accent2)">Unlevered Yield</strong><br>
      (Real Profit + Interest Paid) √∑ Enterprise Value. Yield as if the company had no debt ‚Äî useful for cross-company comparison.</p>

      <p><strong style="color:var(--accent2)">Real vs. Reported Gap</strong><br>
      Real Economic Profit minus Reported FCF (CFO ‚àí Total CapEx). Negative = reported FCF overstates real earnings, typically because SBC dilution isn't deducted in traditional FCF.</p>

      <h4 style="color:var(--accent);margin:24px 0 10px;font-size:.95rem;border-bottom:1px solid var(--border);padding-bottom:6px">Capital & Growth</h4>

      <p><strong style="color:var(--accent2)">Invested Capital (IC)</strong><br>
      Equity + Total Debt ‚àí Cash ‚àí STI. Total capital deployed from equity and debt holders, net of liquid assets.</p>

      <p><strong style="color:var(--accent2)">Net Tangible Assets (NTA)</strong><br>
      Total Assets ‚àí Goodwill ‚àí Intangibles ‚àí Cash ‚àí STI. Physical and working capital in operations, excluding acquisition paper assets.</p>

      <p><strong style="color:var(--accent2)">Enterprise Value (EV)</strong><br>
      Market Cap + Total Debt ‚àí Cash ‚àí STI. Total price to acquire the entire business including debt, net of cash.</p>

      <p><strong style="color:var(--accent2)">Growth CapEx</strong><br>
      Total CapEx ‚àí Maintenance CapEx. Investment in future growth beyond maintaining current capacity.</p>

      <p><strong style="color:var(--accent2)">Maintenance CapEx</strong><br>
      Annual cash needed to maintain current productive capacity. Auto-estimated as D&A √ó 1.05 (conservative) or Depreciation Only √ó 1.05 (asset-light) when not disclosed by the company. The √ó 1.05 is an inflation adjustment ‚Äî replacing aging assets costs more today.</p>

      <p><strong style="color:var(--accent2)">Reinvestment Rate</strong><br>
      Growth CapEx √∑ Invested Capital. Fraction of capital being redeployed into growth.</p>

      <p><strong style="color:var(--accent2)">Implied Profit Growth</strong><br>
      Reinvestment Rate √ó Real ROIC. Organic growth rate assuming reinvested capital earns current returns.</p>

      <p><strong style="color:var(--accent2)">Incremental Return</strong><br>
      Year-over-year Œî Real Profit √∑ prior year Growth CapEx. What each dollar of growth spending actually produced.</p>

      <h4 style="color:var(--accent);margin:24px 0 10px;font-size:.95rem;border-bottom:1px solid var(--border);padding-bottom:6px">Input Fields</h4>

      <p><strong style="color:var(--accent2)">CFO</strong> ‚Äî Cash From Operations. Net cash from operating activities (cash flow statement).</p>
      <p><strong style="color:var(--accent2)">SBC Expense Addback</strong> ‚Äî Stock-based compensation added back in CFO section. Non-cash charge.</p>
      <p><strong style="color:var(--accent2)">SBC Grant Date Fair Value</strong> ‚Äî Units granted √ó weighted-average grant price. From SBC footnote.</p>
      <p><strong style="color:var(--accent2)">D&A</strong> ‚Äî Depreciation & Amortization combined. From cash flow adjustments.</p>
      <p><strong style="color:var(--accent2)">Depreciation Only</strong> ‚Äî Physical depreciation of PP&E, excluding intangible amortization. Enables asset-light view.</p>
      <p><strong style="color:var(--accent2)">Amortization</strong> ‚Äî D&A minus Depreciation. Acquisition-related intangible write-down. An accounting convention ‚Äî acquired assets often retain or grow in value even as they amortize to zero on the books.</p>
      <p><strong style="color:var(--accent2)">STI</strong> ‚Äî Short-Term Investments. Current marketable securities, treated like cash.</p>
      <p><strong style="color:var(--accent2)">Interest Paid</strong> ‚Äî Cash interest from supplemental disclosures (bottom of cash flow statement).</p>
      <p><strong style="color:var(--accent2)">Income Tax Paid</strong> ‚Äî Cash taxes from supplemental disclosures. Often very different from tax provision.</p>

      <h4 style="color:var(--accent);margin:24px 0 10px;font-size:.95rem;border-bottom:1px solid var(--border);padding-bottom:6px">Growth Decomposition (Multi-Year)</h4>

      <p><strong style="color:var(--accent2)">Organic Growth</strong> ‚Äî Profit growth from existing base getting more productive (pricing, margins, customers).</p>
      <p><strong style="color:var(--accent2)">Reinvestment Growth</strong> ‚Äî Profit from growth CapEx earning returns. Estimated as prior year Growth CapEx √ó ROIC.</p>
      <p><strong style="color:var(--accent2)">Profit CAGR</strong> ‚Äî Compound Annual Growth Rate of Real Profit.</p>
      <p><strong style="color:var(--accent2)">Capital CAGR</strong> ‚Äî Compound Annual Growth Rate of Invested Capital.</p>
      <p><strong style="color:var(--accent2)">Profit / Capital Growth</strong> ‚Äî Profit CAGR √∑ Capital CAGR. Above 1.0x = increasingly efficient. Below 1.0x = diminishing returns.</p>

      <h4 style="color:var(--accent);margin:24px 0 10px;font-size:.95rem;border-bottom:1px solid var(--border);padding-bottom:6px">Data Pipeline</h4>

      <p><strong style="color:var(--accent2)">10-K</strong> ‚Äî SEC annual report. Primary source for all cash flow items and full-year financials.</p>
      <p><strong style="color:var(--accent2)">10-Q</strong> ‚Äî SEC quarterly report. Used to update balance sheet with more current data.</p>
      <p><strong style="color:var(--accent2)">Gemini Extraction</strong> ‚Äî Google Gemini processes full filing PDFs and returns structured JSON via standardized prompt.</p>
      <p><strong style="color:var(--accent2)">Claude Audit</strong> ‚Äî Cross-checks Gemini extraction against computed results, explains findings, identifies risks.</p>

    </div>
  </div>
</div>

<script>
// ============ Portfolio (localStorage) ============
const PORTFOLIO_KEY='rep_portfolio';

function getPortfolio(){
  try{return JSON.parse(localStorage.getItem(PORTFOLIO_KEY))||{};}catch(e){return {};}
}
function putPortfolio(p){localStorage.setItem(PORTFOLIO_KEY,JSON.stringify(p));}

function refreshPortfolioSelect(){
  var sel=document.getElementById('portfolioSelect');
  var p=getPortfolio();
  var tickers=Object.keys(p).sort();
  var curVal=sel.value;
  sel.innerHTML='<option value="">‚Äî New Company ‚Äî</option>';
  tickers.forEach(function(t){
    var opt=document.createElement('option');
    opt.value=t;opt.textContent=t+' ('+Object.keys(p[t].years).length+' yrs)';
    sel.appendChild(opt);
  });
  sel.value=curVal;
}

function saveToPortfolio(){
  var ticker=document.getElementById('ticker').value.trim().toUpperCase();
  if(!ticker){alert('Enter a ticker before saving.');return;}
  // Sync current form to yearStore
  if(currentYearKey&&yearStore[currentYearKey])yearStore[currentYearKey].formData=captureForm();
  var p=getPortfolio();
  p[ticker]={
    ticker:ticker,
    price:v('price'),
    years:JSON.parse(JSON.stringify(yearStore)),
    currentYearKey:currentYearKey,
    savedAt:new Date().toISOString()
  };
  putPortfolio(p);
  refreshPortfolioSelect();
  document.getElementById('portfolioSelect').value=ticker;
  // Brief visual feedback
  var btn=event.target;btn.textContent='‚úì Saved!';setTimeout(function(){btn.textContent='üíæ Save'},1200);
}

function loadFromPortfolio(){
  var sel=document.getElementById('portfolioSelect');
  var ticker=sel.value;
  if(!ticker){clearForNewCompany();return;}
  var p=getPortfolio();
  var entry=p[ticker];
  if(!entry)return;
  // Clear current state
  for(var k in yearStore)delete yearStore[k];
  currentYearKey=null;
  // Restore
  var ys=entry.years;
  for(var k in ys){yearStore[k]=ys[k];}
  currentYearKey=entry.currentYearKey||Object.keys(yearStore)[0]||null;
  document.getElementById('ticker').value=entry.ticker||ticker;
  if(entry.price)document.getElementById('price').value=entry.price;
  if(currentYearKey&&yearStore[currentYearKey]){
    restoreForm(yearStore[currentYearKey].formData);
  }
  renderPills();
  document.getElementById('results').style.display='none';
  document.getElementById('exportBtn').style.display='none';
}

function onPortfolioSelect(){
  var sel=document.getElementById('portfolioSelect');
  if(sel.value)loadFromPortfolio();
  else clearForNewCompany();
}

function clearForNewCompany(){
  for(var k in yearStore)delete yearStore[k];
  currentYearKey=null;
  var fields=['cfo','sbc_expense','sbc_grant','capex','da','maint_capex','depr_only','restructuring','inv_change','recv_change','interest','tax_paid','debt','cash','sti','shares','lt_investments','equity','total_assets','goodwill','intangibles'];
  fields.forEach(function(f){var el=document.getElementById(f);if(el)el.value='';});
  document.getElementById('amort_only').value='';
  document.getElementById('ticker').value='';
  document.getElementById('price').value='';
  document.getElementById('inv_return_rate').value='4';
  renderPills();
  document.getElementById('results').style.display='none';
  document.getElementById('exportBtn').style.display='none';
}

// Auto-calc amortization when depreciation or D&A changes
document.getElementById('depr_only').addEventListener('input',calcAmort);
document.getElementById('da').addEventListener('input',calcAmort);
function calcAmort(){
  var da=v('da'),depr=v('depr_only');
  var el=document.getElementById('amort_only');
  if(da&&depr&&da>depr){el.value=(da-depr).toFixed(0);}
  else{el.value='';}
}

function deleteFromPortfolio(){
  var sel=document.getElementById('portfolioSelect');
  var ticker=sel.value;
  if(!ticker){alert('Select a company to delete.');return;}
  if(!confirm('Delete '+ticker+' from portfolio? This cannot be undone.'))return;
  var p=getPortfolio();
  delete p[ticker];
  putPortfolio(p);
  refreshPortfolioSelect();
  clearForNewCompany();
}

function downloadPortfolio(){
  var p=getPortfolio();
  if(Object.keys(p).length===0){alert('Portfolio is empty ‚Äî nothing to download.');return;}
  var blob=new Blob([JSON.stringify(p,null,2)],{type:'application/json'});
  var url=URL.createObjectURL(blob);
  var a=document.createElement('a');a.href=url;
  a.download='REP_Portfolio_'+new Date().toISOString().slice(0,10)+'.json';
  a.click();URL.revokeObjectURL(url);
}

function restorePortfolio(evt){
  var file=evt.target.files[0];if(!file)return;
  var reader=new FileReader();
  reader.onload=function(e){
    try{
      var imported=JSON.parse(e.target.result);
      var p=getPortfolio();
      var count=0;
      for(var t in imported){
        if(imported.hasOwnProperty(t)){p[t]=imported[t];count++;}
      }
      putPortfolio(p);
      refreshPortfolioSelect();
      alert('Restored '+count+' companies into portfolio.');
    }catch(err){alert('Invalid portfolio file: '+err.message);}
  };
  reader.readAsText(file);
  evt.target.value='';
}

// Compare - show picker first
var _pickerMode='compare';
function comparePortfolio(){showPicker('compare')}
function scorecardPortfolio(){showPicker('scorecard')}

function showPicker(mode){
  _pickerMode=mode;
  var p=getPortfolio();
  var tickers=Object.keys(p).sort();
  if(tickers.length<2){alert('Save at least 2 companies.');return;}
  document.getElementById('pickerTitle').textContent=mode==='compare'?'üìä Select Companies to Compare':'üèÜ Select Companies for Scorecard';
  document.getElementById('pickerGoBtn').textContent=mode==='compare'?'Compare':'Scorecard';
  var grid=document.getElementById('pickerGrid');
  grid.innerHTML=tickers.map(function(t){
    return '<label class="picker-chip selected" onclick="togglePickerChip(this)"><span class="picker-check">‚úì</span><input type="checkbox" value="'+t+'" checked>'+t+'</label>';
  }).join('');
  document.getElementById('pickerModal').classList.add('active');
}

function togglePickerChip(el){
  var cb=el.querySelector('input');
  cb.checked=!cb.checked;
  el.classList.toggle('selected',cb.checked);
}

function closePicker(){document.getElementById('pickerModal').classList.remove('active')}

function pickerGo(){
  var checks=document.querySelectorAll('#pickerGrid input:checked');
  var selected=[];
  checks.forEach(function(cb){selected.push(cb.value)});
  if(selected.length<2){alert('Select at least 2 companies.');return;}
  closePicker();
  if(_pickerMode==='compare')runCompare(selected);
  else runScorecard(selected);
}

function runCompare(selectedTickers){
  var p=getPortfolio();
  var tickers=selectedTickers;

  var companies=tickers.map(function(t){
    var entry=p[t];
    var ys=entry.years;
    var keys=Object.keys(ys).sort(function(a,b){
      var da=ys[a].fiscal_year_end||a;var db=ys[b].fiscal_year_end||b;return da<db?-1:da>db?1:0;
    });
    // Use latest year
    var latestKey=keys[keys.length-1];
    var yr=ys[latestKey];
    var m=computeMetrics(yr);
    var price=entry.price||0;
    var shares=yr.formData.shares||0;
    var mktCap=price*shares;
    var cash=yr.formData.cash||0;
    var sti=yr.formData.sti||0;
    var debt=m.debt||0;
    var ev=mktCap+debt-(cash+sti);
    var realYield=ev>0?m.realProfit/ev:0;
    var realPE=shares>0&&m.realProfit>0?price/(m.realProfit/shares):0;
    var sbcPctCFO=m.cfo>0?m.realSBC/m.cfo:0;
    var latestLabel=yr.fiscal_year_label||(yr.fiscal_year_end?'FY'+new Date(yr.fiscal_year_end).getFullYear():latestKey);
    // ROIC trajectory if multiple years
    var roicFirst=null,roicLast=m.realROIC;
    if(keys.length>=2){
      var firstYr=ys[keys[0]];
      var fm=computeMetrics(firstYr);
      roicFirst=fm.realROIC;
    }
    return {
      ticker:t,price:price,latestYear:latestLabel,yearsCount:keys.length,
      realProfit:m.realProfit,realYield:realYield,realPE:realPE,realROIC:m.realROIC,
      ev:ev,investedCapital:m.investedCapital,
      cfo:m.cfo,realSBC:m.realSBC,sbcPctCFO:sbcPctCFO,
      capex:m.capex,growthCapex:m.growthCapex,maintCapex:m.maintCapex,
      reportedFCF:m.reportedFCF,gap:m.realProfit-m.reportedFCF,
      roicFirst:roicFirst,roicLast:roicLast,
      da:m.da,equity:m.equity,debt:debt,
      reinvestRate:m.investedCapital>0?m.growthCapex/m.investedCapital:0,
      impliedGrowth:m.investedCapital>0?(m.growthCapex/m.investedCapital)*m.realROIC:0,
      organicBase:keys.length>=2?computeMetrics(ys[keys[0]]).realProfit:m.realProfit,
      reinvestLayer:keys.length>=2?m.realProfit-computeMetrics(ys[keys[0]]).realProfit:0,
      nta:m.nta,returnOnNTA:m.returnOnNTA,
      incrementalReturn:keys.length>=2?(function(){
        var prevYr=ys[keys[keys.length-2]];var pm=computeMetrics(prevYr);
        return pm.growthCapex>0?(m.realProfit-pm.realProfit)/pm.growthCapex:null;
      })():null
    };
  });

  var h='<div class="compare-table-wrap"><table class="compare-table"><tr>';
  h+='<th>Metric</th>';
  companies.forEach(function(c){h+='<th>'+c.ticker+'</th>'});
  h+='</tr>';

  var rows=[
    {label:'Latest Year',f:function(c){return c.latestYear}},
    {label:'Share Price',f:function(c){return '$'+c.price}},
    {label:'Enterprise Value',f:function(c){return fmtM(c.ev)}},
    {label:'',f:function(){return ''}},
    {label:'Real Economic Profit',f:function(c){return fmtM(c.realProfit)},hl:true},
    {label:'Real Cash Yield',f:function(c){return pct(c.realYield)},hl:true},
    {label:'Real P/E',f:function(c){return c.realPE>0?c.realPE.toFixed(1)+'x':'N/A'}},
    {label:'Real ROIC',f:function(c){return pct(c.realROIC)},hl:true},
    {label:'Return on NTA',f:function(c){return c.nta>0?pct(c.returnOnNTA):'‚Äî'},hl:true},
    {label:'Incremental Return',f:function(c){return c.incrementalReturn!==null?pct(c.incrementalReturn):'‚Äî'},hl:true},
    {label:'Reinvestment Rate',f:function(c){return pct(c.reinvestRate,1)},hl:true},
    {label:'Implied Profit Growth',f:function(c){return pct(c.impliedGrowth,1)},hl:true},
    {label:'ROIC Trend',f:function(c){
      if(c.roicFirst===null)return '‚Äî';
      var ch=c.roicLast-c.roicFirst;
      if(ch>0.02)return '<span style="color:var(--green)">‚Üë '+pct(c.roicFirst,1)+' ‚Üí '+pct(c.roicLast,1)+'</span>';
      if(ch<-0.02)return '<span style="color:var(--red)">‚Üì '+pct(c.roicFirst,1)+' ‚Üí '+pct(c.roicLast,1)+'</span>';
      return '‚Üí stable ~'+pct(c.roicLast,1);
    }},
    {label:'',f:function(){return ''}},
    {label:'CFO',f:function(c){return fmtM(c.cfo)}},
    {label:'Real SBC',f:function(c){return fmtM(c.realSBC)}},
    {label:'SBC % of CFO',f:function(c){return pct(c.sbcPctCFO,1)}},
    {label:'Total CapEx',f:function(c){return fmtM(c.capex)}},
    {label:'Growth CapEx',f:function(c){return fmtM(c.growthCapex)}},
    {label:'Maint CapEx',f:function(c){return fmtM(c.maintCapex)}},
    {label:'',f:function(){return ''}},
    {label:'Reported FCF',f:function(c){return fmtM(c.reportedFCF)}},
    {label:'Real vs Reported Gap',f:function(c){return fmtM(c.gap)}},
    {label:'Invested Capital',f:function(c){return fmtM(c.investedCapital)}},
    {label:'Net Tangible Assets',f:function(c){return c.nta>0?fmtM(c.nta):'‚Äî'}},
    {label:'Total Debt',f:function(c){return fmtM(c.debt)}},
    {label:'Equity',f:function(c){return fmtM(c.equity)}},
    {label:'',f:function(){return ''}},
    {label:'Profit Composition',f:function(){return ''},hl:true},
    {label:'Organic Base',f:function(c){return fmtM(c.organicBase)}},
    {label:'Reinvestment Layer',f:function(c){return c.reinvestLayer!==0?fmtM(c.reinvestLayer):'‚Äî'}},
    {label:'Reinvest % of Profit',f:function(c){return c.realProfit>0&&c.reinvestLayer!==0?pct(c.reinvestLayer/c.realProfit,0):'‚Äî'}}
  ];

  rows.forEach(function(row){
    if(!row.label){h+='<tr><td colspan="'+(companies.length+1)+'" style="border-bottom:1px solid var(--border);padding:2px"></td></tr>';return;}
    h+='<tr><td'+(row.hl?' style="font-weight:600;color:var(--accent2)"':'')+'>'+row.label+'</td>';
    companies.forEach(function(c){
      h+='<td'+(row.hl?' style="font-weight:600"':'')+'>'+row.f(c)+'</td>';
    });
    h+='</tr>';
  });
  h+='</table></div>';

  document.getElementById('compareContent').innerHTML=h;
  document.getElementById('compareOverlay').classList.add('active');
}

function closeCompare(){document.getElementById('compareOverlay').classList.remove('active')}
function closeScorecard(){document.getElementById('scorecardOverlay').classList.remove('active')}
function openGlossary(){document.getElementById('glossaryOverlay').classList.add('active')}
function closeGlossary(){document.getElementById('glossaryOverlay').classList.remove('active')}

// ============ Scorecard ============
function runScorecard(selectedTickers){
  var p=getPortfolio();
  var tickers=selectedTickers;

  var companies=tickers.map(function(t){
    var entry=p[t];
    var ys=entry.years;
    var keys=Object.keys(ys).sort(function(a,b){
      var da=ys[a].fiscal_year_end||a;var db=ys[b].fiscal_year_end||b;return da<db?-1:da>db?1:0;
    });
    var latestKey=keys[keys.length-1];
    var yr=ys[latestKey];
    var m=computeMetrics(yr);
    var price=entry.price||0;
    var shares=yr.formData.shares||0;
    var mktCap=price*shares;
    var cash=yr.formData.cash||0,sti=yr.formData.sti||0,debt=m.debt||0;
    var ev=mktCap+debt-(cash+sti);
    var realYield=ev>0?m.realProfit/ev:0;
    var realPE=shares>0&&m.realProfit>0?price/(m.realProfit/shares):0;
    var sbcPctCFO=m.cfo>0?m.realSBC/m.cfo:0;
    // Incremental return
    var incReturn=null;
    if(keys.length>=2){
      var prevYr=ys[keys[keys.length-2]];
      var pm=computeMetrics(prevYr);
      if(pm.growthCapex>0)incReturn=(m.realProfit-pm.realProfit)/pm.growthCapex;
    }
    return {
      ticker:t,realYield:realYield,realPE:realPE,realROIC:m.realROIC,
      returnOnNTA:m.returnOnNTA,nta:m.nta,
      reinvestRate:m.investedCapital>0?m.growthCapex/m.investedCapital:0,
      impliedGrowth:m.investedCapital>0?(m.growthCapex/m.investedCapital)*m.realROIC:0,
      incrementalReturn:incReturn,
      sbcPctCFO:sbcPctCFO,realProfit:m.realProfit,ev:ev
    };
  });

  // Define scorecard metrics with ranking direction
  var metrics=[
    {label:'Real Cash Yield',key:'realYield',f:pct,higher:true},
    {label:'Real P/E',key:'realPE',f:function(v){return v>0?v.toFixed(1)+'x':'N/A'},higher:false,skipZero:true},
    {label:'Real ROIC',key:'realROIC',f:pct,higher:true},
    {label:'Return on NTA',key:'returnOnNTA',f:pct,higher:true,skipZero:true},
    {label:'Reinvestment Rate',key:'reinvestRate',f:function(v){return pct(v,1)},higher:true},
    {label:'Implied Growth',key:'impliedGrowth',f:function(v){return pct(v,1)},higher:true},
    {label:'Incremental Return',key:'incrementalReturn',f:function(v){return v!==null?pct(v):'‚Äî'},higher:true,skipNull:true},
    {label:'SBC % of CFO',key:'sbcPctCFO',f:function(v){return pct(v,1)},higher:false}
  ];

  function rankValues(vals,higher,skipZero,skipNull){
    var indexed=vals.map(function(v,i){return {v:v,i:i}});
    var valid=indexed.filter(function(x){
      if(skipNull&&x.v===null)return false;
      if(skipZero&&(x.v===0||x.v===null))return false;
      return x.v!==null&&!isNaN(x.v);
    });
    valid.sort(function(a,b){return higher?(b.v-a.v):(a.v-b.v)});
    var ranks={};
    valid.forEach(function(x,rank){ranks[x.i]=rank+1;});
    indexed.forEach(function(x){if(!(x.i in ranks))ranks[x.i]=null;});
    return ranks;
  }

  var n=companies.length;
  var maxRank=n;
  function rankClass(r){
    if(r===null)return '';
    if(r===1)return 'rank-1';
    if(r===n||r>=5)return 'rank-5';
    if(r===2)return 'rank-2';
    if(r>=4)return 'rank-4';
    return 'rank-3';
  }
  function badgeClass(r){
    if(r===null)return '';
    if(r===1)return 'r1';
    if(r===n||r>=5)return 'r5';
    if(r===2)return 'r2';
    if(r>=4)return 'r4';
    return 'r3';
  }

  var h='<div class="compare-table-wrap"><table class="scorecard-table"><tr><th>Metric</th>';
  companies.forEach(function(c){h+='<th>'+c.ticker+'</th>'});
  h+='</tr>';

  metrics.forEach(function(met){
    var vals=companies.map(function(c){return c[met.key]});
    var ranks=rankValues(vals,met.higher,met.skipZero,met.skipNull);
    h+='<tr><td>'+met.label+'</td>';
    companies.forEach(function(c,i){
      var val=c[met.key];
      var r=ranks[i];
      var display=(val===null||val===undefined)?'‚Äî':met.f(val);
      var badge=r!==null?'<span class="rank-badge '+badgeClass(r)+'">'+r+'</span>':'';
      h+='<td class="'+rankClass(r)+'">'+badge+display+'</td>';
    });
    h+='</tr>';
  });
  h+='</table></div>';

  document.getElementById('scorecardContent').innerHTML=h;
  document.getElementById('scorecardOverlay').classList.add('active');
}

// ============ Projections ============
function toggleProjections(){
  var area=document.getElementById('projInputArea');
  var btn=document.getElementById('projToggle');
  if(area.style.display==='none'){
    area.style.display='block';
    btn.textContent='Hide projection inputs ‚ñ≤';
    btn.classList.add('active');
    // Pre-fill current margins as hints
    prefillProjectionHints();
  }else{
    area.style.display='none';
    btn.textContent='Enter forward estimates to project Real Profit, Yield & ROIC ‚ñº';
    btn.classList.remove('active');
  }
}

function prefillProjectionHints(){
  var cfo=v('cfo')||0,capex=v('capex')||0,da=v('da')||0;
  var sbcExp=v('sbc_expense')||0,sbcGrant=v('sbc_grant')||0;
  // Show current CFO margin if we have revenue in yearStore
  var rev=null;
  if(currentYearKey&&yearStore[currentYearKey]&&yearStore[currentYearKey].extra){
    rev=yearStore[currentYearKey].extra.revenue||yearStore[currentYearKey].extra.total_revenue||null;
  }
  if(rev&&cfo){
    var cm=document.getElementById('proj_cfo_margin');
    if(!cm.value)cm.placeholder='Current: '+(cfo/rev*100).toFixed(1)+'%';
  }
  var sbc=document.getElementById('proj_sbc');
  if(!sbc.value&&(sbcExp||sbcGrant))sbc.placeholder='Current: '+Math.max(sbcExp,sbcGrant);
  var daEl=document.getElementById('proj_da');
  if(!daEl.value&&da)daEl.placeholder='Current: '+da;
  var cxEl=document.getElementById('proj_capex');
  if(!cxEl.value&&capex)cxEl.placeholder='Current: '+capex;
}

function runProjections(){
  // Gather current actuals
  var currCFO=v('cfo')||0,currCapex=v('capex')||0,currDA=v('da')||0;
  var currSBCExp=v('sbc_expense')||0,currSBCGrant=v('sbc_grant')||0;
  var currRealSBC=Math.max(currSBCExp,currSBCGrant);
  var currEquity=v('equity')||0,currDebt=v('debt')||0,currCash=v('cash')||0,currSTI=v('sti')||0;
  var currShares=v('shares')||0,currPrice=v('price')||0;
  var currGoodwill=v('goodwill')||0,currIntangibles=v('intangibles')||0;
  var currTotalAssets=v('total_assets')||0;
  var currLtInv=v('lt_investments')||0,currInvRate=(v('inv_return_rate')||4)/100;
  var currMaintCapex,currMC=v('maint_capex');
  if(currMC!==null&&currMC>0)currMaintCapex=currMC;
  else{var ratio=currDA>0?currCapex/currDA:999;if(ratio>=0.8&&ratio<=1.2)currMaintCapex=currCapex;else currMaintCapex=currDA*1.05;}
  var currRealProfit=currCFO-currRealSBC-currMaintCapex-(v('restructuring')||0)+currLtInv*currInvRate;
  var currEV=currPrice*currShares+currDebt-(currCash+currSTI);
  var currIC=currEquity>0?(currEquity+currDebt-currCash-currSTI):0;
  var currROIC=currIC>0?currRealProfit/currIC:0;
  var currYield=currEV>0?currRealProfit/currEV:0;

  // Get projection inputs
  var projRev=v('proj_revenue');
  var projCFOMargin=v('proj_cfo_margin');
  var projCapex=v('proj_capex');
  var projCFO=v('proj_cfo');
  var projEPS=v('proj_eps');
  var projTarget=v('proj_target');
  var projSBC=v('proj_sbc');
  var projDA=v('proj_da');
  var projGrowth=v('proj_growth');

  // Determine forward CFO
  var fwdCFO=null;
  var method='';
  if(projCFO){
    fwdCFO=projCFO;
    method='Direct CFO estimate';
  }else if(projRev&&projCFOMargin){
    fwdCFO=projRev*(projCFOMargin/100);
    method='Revenue √ó CFO Margin ('+projCFOMargin+'%)';
  }else if(projRev&&currCFO){
    // Use current CFO margin
    var currRev=null;
    if(currentYearKey&&yearStore[currentYearKey]&&yearStore[currentYearKey].extra){
      currRev=yearStore[currentYearKey].extra.revenue||yearStore[currentYearKey].extra.total_revenue||null;
    }
    if(currRev){
      var impliedMargin=currCFO/currRev;
      fwdCFO=projRev*impliedMargin;
      method='Revenue √ó Current CFO Margin ('+pct(impliedMargin,1)+')';
    }
  }

  // Growth rate override
  if(!fwdCFO&&projGrowth){
    fwdCFO=currCFO*(1+projGrowth/100);
    method='Current CFO √ó (1 + '+projGrowth+'%)';
  }

  if(!fwdCFO){
    document.getElementById('projResults').innerHTML='<p style="color:var(--red);font-size:.85rem;margin-top:12px">Need at least: Forward CFO, or Revenue + CFO Margin, or Growth Rate.</p>';
    return;
  }

  // Forward assumptions
  var fwdSBC=projSBC||currRealSBC;
  var fwdDA=projDA||currDA;
  var fwdCapex=projCapex||currCapex;
  var fwdMaintCapex;
  var fwdRatio=fwdDA>0?fwdCapex/fwdDA:999;
  if(fwdRatio>=0.8&&fwdRatio<=1.2)fwdMaintCapex=fwdCapex;
  else fwdMaintCapex=fwdDA*1.05;
  var fwdGrowthCapex=Math.max(fwdCapex-fwdMaintCapex,0);
  var fwdInvIncome=currLtInv*currInvRate;
  var fwdRealProfit=fwdCFO-fwdSBC-fwdMaintCapex+fwdInvIncome;

  // Forward ROIC (assume IC grows by growth capex)
  var fwdIC=currIC+fwdGrowthCapex;
  var fwdROIC=fwdIC>0?fwdRealProfit/fwdIC:0;

  // Forward yield (current EV)
  var fwdYield=currEV>0?fwdRealProfit/currEV:0;

  // Forward yield at target price
  var fwdTargetEV=null,fwdTargetYield=null;
  if(projTarget&&currShares){
    fwdTargetEV=projTarget*currShares+currDebt-(currCash+currSTI);
    fwdTargetYield=fwdTargetEV>0?fwdRealProfit/fwdTargetEV:0;
  }

  // Forward P/E from EPS
  var fwdPE=null;
  if(projEPS&&currPrice)fwdPE=currPrice/projEPS;
  var fwdRealPE=currShares>0&&fwdRealProfit>0?currPrice/(fwdRealProfit/currShares):0;

  // Deltas
  var profitDelta=currRealProfit!==0?(fwdRealProfit-currRealProfit)/Math.abs(currRealProfit):0;
  var roicDelta=fwdROIC-currROIC;
  var yieldDelta=fwdYield-currYield;

  function deltaHTML(d){
    if(d>0.005)return '<div class="pr-delta up">‚Üë +'+pct(d,1)+' vs current</div>';
    if(d<-0.005)return '<div class="pr-delta down">‚Üì '+pct(d,1)+' vs current</div>';
    return '<div class="pr-delta flat">‚Üí flat vs current</div>';
  }

  var h='<div style="margin-top:16px">';
  h+='<p style="font-size:.78rem;color:var(--text3);margin-bottom:12px">Method: '+method+'</p>';
  h+='<div class="proj-result-grid">';
  h+='<div class="proj-result"><div class="pr-val" style="color:var(--accent2)">'+fmtM(fwdRealProfit)+'</div><div class="pr-lbl">Projected Real Profit</div>'+deltaHTML(profitDelta)+'</div>';
  h+='<div class="proj-result"><div class="pr-val">'+pct(fwdYield)+'</div><div class="pr-lbl">Projected Yield (Current EV)</div>'+deltaHTML(yieldDelta)+'</div>';
  h+='<div class="proj-result"><div class="pr-val">'+pct(fwdROIC)+'</div><div class="pr-lbl">Projected ROIC</div>'+deltaHTML(roicDelta)+'</div>';
  h+='<div class="proj-result"><div class="pr-val">'+fmtM(fwdCFO)+'</div><div class="pr-lbl">Forward CFO</div></div>';
  h+='<div class="proj-result"><div class="pr-val">'+(fwdRealPE>0?fwdRealPE.toFixed(1)+'x':'N/A')+'</div><div class="pr-lbl">Fwd Real P/E</div></div>';
  h+='<div class="proj-result"><div class="pr-val">'+fmtM(fwdGrowthCapex)+'</div><div class="pr-lbl">Fwd Growth CapEx</div></div>';
  h+='</div>';

  if(fwdTargetYield!==null){
    h+='<div class="proj-result-grid" style="grid-template-columns:1fr 1fr">';
    h+='<div class="proj-result"><div class="pr-val">'+pct(fwdTargetYield)+'</div><div class="pr-lbl">Yield at Target $'+projTarget+'</div></div>';
    h+='<div class="proj-result"><div class="pr-val">'+fmtM(fwdTargetEV)+'</div><div class="pr-lbl">Target EV</div></div>';
    h+='</div>';
  }
  if(fwdPE!==null){
    h+='<div style="font-size:.82rem;color:var(--text2);margin-top:8px">Consensus P/E (from EPS $'+projEPS+'): <strong style="color:var(--text)">'+fwdPE.toFixed(1)+'x</strong> vs Real P/E: <strong style="color:var(--accent2)">'+(fwdRealPE>0?fwdRealPE.toFixed(1)+'x':'N/A')+'</strong></div>';
  }

  // Trend comparison
  h+='<h3 style="color:var(--accent);margin:20px 0 8px;font-size:.9rem">üìê vs Historical Pattern</h3>';
  h+='<table class="breakdown" style="max-width:500px"><tr><th>Metric</th><th style="text-align:right">Current</th><th style="text-align:right">Projected</th><th style="text-align:right">Delta</th></tr>';
  var compRows=[
    {label:'Real Profit',curr:currRealProfit,proj:fwdRealProfit,f:fmtM},
    {label:'CFO',curr:currCFO,proj:fwdCFO,f:fmtM},
    {label:'Real SBC',curr:currRealSBC,proj:fwdSBC,f:fmtM,inv:true},
    {label:'Total CapEx',curr:currCapex,proj:fwdCapex,f:fmtM,inv:true},
    {label:'Maint CapEx',curr:currMaintCapex,proj:fwdMaintCapex,f:fmtM},
    {label:'Growth CapEx',curr:Math.max(currCapex-currMaintCapex,0),proj:fwdGrowthCapex,f:fmtM},
    {label:'Cash Yield',curr:currYield,proj:fwdYield,f:pct},
    {label:'Real ROIC',curr:currROIC,proj:fwdROIC,f:pct}
  ];
  compRows.forEach(function(r){
    var d=r.curr!==0?(r.proj-r.curr)/Math.abs(r.curr):0;
    var dColor=d>0.02?(r.inv?'var(--red)':'var(--green)'):(d<-0.02?(r.inv?'var(--green)':'var(--red)'):'var(--text3)');
    var dText=d>0.005?'+'+pct(d,0):(d<-0.005?pct(d,0):'flat');
    h+='<tr><td>'+r.label+'</td><td style="text-align:right">'+r.f(r.curr)+'</td><td style="text-align:right">'+r.f(r.proj)+'</td><td style="text-align:right;color:'+dColor+'">'+dText+'</td></tr>';
  });
  h+='</table>';

  // Assessment
  var assessments=[];
  if(profitDelta>0.15)assessments.push({type:'ok',text:'Analysts project '+pct(profitDelta,0)+' profit growth ‚Äî if achieved at current ROIC, this supports the valuation.'});
  else if(profitDelta>0.05)assessments.push({type:'ok',text:'Moderate profit growth projected ('+pct(profitDelta,0)+'). Consistent with organic + reinvestment trend.'});
  else if(profitDelta>-0.02)assessments.push({type:'caution',text:'Flat profit projected. If the market prices in growth, this may disappoint.'});
  else assessments.push({type:'warn',text:'Profit decline projected ('+pct(profitDelta,0)+'). Check if the market has priced this in.'});

  if(fwdROIC<currROIC-0.03)assessments.push({type:'caution',text:'ROIC compression: '+pct(currROIC,1)+' ‚Üí '+pct(fwdROIC,1)+'. Capital growing faster than profit ‚Äî incremental returns declining.'});
  if(fwdSBC>fwdCFO*0.25)assessments.push({type:'warn',text:'SBC remains heavy at '+pct(fwdSBC/fwdCFO,0)+' of projected CFO.'});

  if(assessments.length){
    h+='<div style="margin-top:12px">';
    assessments.forEach(function(a){h+='<div class="flag '+a.type+'" style="font-size:.82rem">'+a.text+'</div>'});
    h+='</div>';
  }
  h+='</div>';

  document.getElementById('projResults').innerHTML=h;
}

// Init portfolio on load
refreshPortfolioSelect();

// ============ Multi-year store ============
const yearStore = {};
let currentYearKey = null;

function v(id){const el=document.getElementById(id);return el.value===''?null:parseFloat(el.value)}
function fmt(n,dec){if(dec===undefined)dec=0;if(n===null||isNaN(n))return '‚Äî';return n<0?'-$'+Math.abs(n).toLocaleString('en-US',{minimumFractionDigits:dec,maximumFractionDigits:dec}):'$'+n.toLocaleString('en-US',{minimumFractionDigits:dec,maximumFractionDigits:dec})}
function fmtM(n){if(n===null||isNaN(n))return '‚Äî';var abs=Math.abs(n);var s;if(abs>=1e6)s=(n/1e6).toFixed(1)+'T';else if(abs>=1e3)s=(n/1e3).toFixed(1)+'B';else s=n.toFixed(0)+'M';return n<0?'-$'+s.replace('-',''):'$'+s}
function pct(n,dec){if(dec===undefined)dec=2;if(n===null||isNaN(n))return '‚Äî';return (n*100).toFixed(dec)+'%'}

// ============ JSON Import ============
function openImport(){document.getElementById('jsonInput').value='';document.getElementById('importStatus').className='import-status';document.getElementById('importModal').classList.add('active')}
function closeImport(){document.getElementById('importModal').classList.remove('active');document.getElementById('importStatus').className='import-status'}

function stripJsonComments(str){return str.replace(/("(?:[^"\\]|\\.)*")|\/\/[^\n]*/g,function(m,g){return g||''});}

function doImport(){
  var raw=document.getElementById('jsonInput').value.trim();
  var statusEl=document.getElementById('importStatus');
  try{
    // Save current year's form data before importing new year (prevents cross-contamination)
    if(currentYearKey&&yearStore[currentYearKey]){
      yearStore[currentYearKey].formData=captureForm();
    }
    // Clear cash flow fields before filling to prevent cross-year contamination
    var cashFlowFields=['cfo','sbc_expense','sbc_grant','capex','da','maint_capex','depr_only','restructuring','inv_change','recv_change','interest','tax_paid'];
    cashFlowFields.forEach(function(f){var el=document.getElementById(f);if(el)el.value='';});
    document.getElementById('amort_only').value='';
    var cleaned=stripJsonComments(raw);
    var d=JSON.parse(cleaned);
    var map={
      'cash from operations':'cfo','cash_from_operations':'cfo','cfo':'cfo',
      'sbc expense addback':'sbc_expense','sbc expense':'sbc_expense','sbc_expense_addback':'sbc_expense','sbc_expense':'sbc_expense',
      'sbc grant date fair value':'sbc_grant','sbc grant value':'sbc_grant','sbc_grant_value':'sbc_grant','calculated_total_grant_value':'sbc_grant','total_grant_value':'sbc_grant',
      'total capex':'capex','capital expenditures':'capex','capex_total':'capex','capex':'capex',
      'd&a':'da','da':'da','d_and_a':'da','depreciation & amortization':'da','depreciation and amortization':'da','depreciation_and_amortization':'da','depreciation_amortization':'da',
      'maintenance capex':'maint_capex','maint capex':'maint_capex','maintenance_capex_explicit':'maint_capex','maintenance_capex':'maint_capex',
      'depreciation only':'depr_only','depreciation':'depr_only','depreciation_only':'depr_only','physical depreciation':'depr_only','physical_depreciation':'depr_only',
      'restructuring charges':'restructuring','restructuring':'restructuring','restructuring_cash_payments':'restructuring','restructuring_payments':'restructuring',
      'inventory change':'inv_change','inventory_change':'inv_change',
      'receivables change':'recv_change','accounts receivable change':'recv_change','trade receivables change':'recv_change','receivables_change':'recv_change',
      'interest paid':'interest','cash_interest_paid':'interest','cash interest paid':'interest','interest_paid':'interest',
      'income tax paid':'tax_paid','income taxes paid':'tax_paid','cash_taxes_paid':'tax_paid','cash taxes paid':'tax_paid','income_tax_paid':'tax_paid',
      'total debt':'debt','total_debt_principal':'debt','total debt principal':'debt','total_debt':'debt',
      'cash & equivalents':'cash','cash and equivalents':'cash','cash & cash equivalents':'cash','cash and cash equivalents':'cash','cash_and_equivalents':'cash','cash_and_cash_equivalents':'cash',
      'short-term investments':'sti','short term investments':'sti','current marketable securities':'sti','short_term_investments':'sti','marketable_securities_current':'sti',
      'non-current marketable securities':'lt_investments','non current marketable securities':'lt_investments','long-term investments':'lt_investments','long term investments':'lt_investments','non_current_marketable_securities':'lt_investments','marketable_securities_non_current':'lt_investments',
      'diluted shares outstanding':'shares','diluted shares':'shares','shares_outstanding_diluted':'shares','weighted_avg_shares_diluted':'shares','weighted_average_shares_diluted':'shares','diluted_shares_outstanding':'shares','diluted_shares':'shares',
      'total shareholders equity':'equity','total stockholders equity':'equity','shareholders_equity':'equity','stockholders_equity':'equity','total_shareholders_equity':'equity','total_stockholders_equity':'equity','equity':'equity','total_equity':'equity',
      'total assets':'total_assets','total_assets':'total_assets',
      'goodwill':'goodwill','goodwill_net':'goodwill',
      'intangible assets':'intangibles','intangible_assets':'intangibles','intangibles':'intangibles','net intangible assets':'intangibles','net_intangible_assets':'intangibles','intangible assets net':'intangibles','other intangible assets':'intangibles','other_intangible_assets':'intangibles',
      'ticker':'ticker','company':'ticker','share price':'price','current share price':'price'
    };
    var fyKeys={'fiscal_year_end':1,'fiscal year end':1,'fiscal_year_end_date':1,'fiscal year end date':1,'period_end_date':1,'period end date':1};
    var fyLabelKeys={'fiscal_year_label':1,'fiscal year label':1,'fiscal_year':1,'fy_label':1};
    var extraKeys={'revenue':1,'total revenue':1,'net revenue':1,'total_revenue':1,'net income':1,'net_income':1,'operating income':1,'operating_income':1,'risk flags':1,'risk_flags':1};

    function flatten(obj){var flat={};for(var k in obj){if(!obj.hasOwnProperty(k))continue;var val=obj[k];if(val!==null&&typeof val==='object'&&!Array.isArray(val)){var sub=flatten(val);for(var sk in sub)flat[sk]=sub[sk];}else{flat[k]=val;}}return flat;}
    var flat=flatten(d);

    var filled=0,warnings=[],fyEnd=null,fyLabel=null,extra={};
    for(var key in flat){
      if(!flat.hasOwnProperty(key))continue;
      var val=flat[key];
      var lk=key.toLowerCase();
      if(fyKeys[lk]){fyEnd=val;continue;}
      if(fyLabelKeys[lk]){fyLabel=val;continue;}
      if(extraKeys[lk]){extra[lk.replace(/ /g,'_')]=val;continue;}
      var fieldId=map[lk];
      if(fieldId&&val!==null&&val!==undefined){
        var el=document.getElementById(fieldId);
        if(el){el.value=val;filled++;}
      }else if(val===null&&map[lk]){warnings.push(key);}
    }

    // Post-import fixups
    var mcEl=document.getElementById('maint_capex');
    if(mcEl&&(mcEl.value===''||mcEl.value==='0'||parseFloat(mcEl.value)===0))mcEl.value='';
    var cxEl=document.getElementById('capex');
    if(cxEl&&parseFloat(cxEl.value)<0)cxEl.value=Math.abs(parseFloat(cxEl.value));
    var daEl=document.getElementById('da');
    if(daEl&&parseFloat(daEl.value)<0)daEl.value=Math.abs(parseFloat(daEl.value));

    // Convert numeric fiscal_year to FY label (e.g., 2024 -> "FY2024")
    if(fyLabel&&typeof fyLabel==='number')fyLabel='FY'+fyLabel;
    if(fyLabel&&typeof fyLabel==='string'&&/^\d{4}$/.test(fyLabel))fyLabel='FY'+fyLabel;

    // Save to year store
    if(fyEnd||fyLabel){
      var yearKey=fyEnd||fyLabel;
      saveCurrentYear(yearKey,fyEnd,fyLabel,extra);
    }

    var msg='‚úì Imported '+filled+' fields.';
    if(fyLabel||fyEnd)msg+=' üìÖ '+(fyLabel||'')+' '+(fyEnd?'(ended '+fyEnd+')':'');
    if(warnings.length>0)msg+=' ‚ö† Null: '+warnings.join(', ')+'.';
    if(!fyEnd&&!fyLabel)msg+=' ‚ö† No fiscal year detected ‚Äî add fiscal_year_end & fiscal_year_label to prompt.';
    msg+=' Enter ticker & share price, then analyze!';
    statusEl.className='import-status success';
    statusEl.textContent=msg;
    setTimeout(function(){closeImport()},3500);
  }catch(e){
    statusEl.className='import-status error';
    statusEl.textContent='‚úó Invalid JSON: '+e.message;
  }
}

// ============ Year Management ============
function captureForm(){
  return {cfo:v('cfo'),sbc_expense:v('sbc_expense'),sbc_grant:v('sbc_grant'),capex:v('capex'),da:v('da'),maint_capex:v('maint_capex'),depr_only:v('depr_only'),restructuring:v('restructuring'),inv_change:v('inv_change'),recv_change:v('recv_change'),interest:v('interest'),tax_paid:v('tax_paid'),debt:v('debt'),cash:v('cash'),sti:v('sti'),shares:v('shares'),lt_investments:v('lt_investments'),inv_return_rate:v('inv_return_rate'),equity:v('equity'),total_assets:v('total_assets'),goodwill:v('goodwill'),intangibles:v('intangibles'),ticker:document.getElementById('ticker').value,price:v('price')};
}

function restoreForm(d){
  var fields=['cfo','sbc_expense','sbc_grant','capex','da','maint_capex','depr_only','restructuring','inv_change','recv_change','interest','tax_paid','debt','cash','sti','shares','lt_investments','inv_return_rate','equity','total_assets','goodwill','intangibles'];
  fields.forEach(function(f){var el=document.getElementById(f);if(el&&d[f]!==null&&d[f]!==undefined)el.value=d[f];else if(el)el.value='';});
  if(d.ticker)document.getElementById('ticker').value=d.ticker;
  if(d.price)document.getElementById('price').value=d.price;
  calcAmort();
}

function saveCurrentYear(yearKey,fyEnd,fyLabel,extra){
  yearStore[yearKey]={formData:captureForm(),fiscal_year_end:fyEnd,fiscal_year_label:fyLabel,extra:extra||{}};
  currentYearKey=yearKey;
  renderPills();
}

function computeMetrics(entry){
  var d=entry.formData;
  var cfo=d.cfo||0,sbcExp=d.sbc_expense||0,sbcGrant=d.sbc_grant||0;
  var capex=d.capex||0,da=d.da||0,mcIn=d.maint_capex;
  var deprOnly=d.depr_only||0;
  var restructuring=d.restructuring||0;
  var ltInv=d.lt_investments||0,invRate=(d.inv_return_rate||4)/100;
  var equity=d.equity||0,debt=d.debt||0,cash=d.cash||0,sti=d.sti||0;
  var totalAssets=d.total_assets||0,goodwill=d.goodwill||0,intangibles=d.intangibles||0;
  var maintCapex;
  if(mcIn!==null&&mcIn>0){maintCapex=mcIn;}
  else{var ratio=da>0?capex/da:999;if(ratio>=0.8&&ratio<=1.2)maintCapex=capex;else maintCapex=da*1.05;}
  // Asset-light maintenance CapEx (depreciation-only √ó 1.05)
  var maintCapexLight=null,realProfitLight=null,realROICLight=null,returnOnNTALight=null;
  if(deprOnly>0&&da>0&&deprOnly<da*0.95){
    maintCapexLight=deprOnly*1.05;
    var realSBCForLight=Math.max(sbcExp,sbcGrant);
    var invIncomeLight=ltInv*invRate;
    realProfitLight=cfo-realSBCForLight-maintCapexLight-restructuring+invIncomeLight;
    var icLight=equity>0?(equity+debt-cash-sti):0;
    realROICLight=icLight>0?realProfitLight/icLight:0;
    var ntaLight=totalAssets>0?(totalAssets-goodwill-intangibles-cash-sti):0;
    returnOnNTALight=ntaLight>0?realProfitLight/ntaLight:0;
  }
  var realSBC=Math.max(sbcExp,sbcGrant);
  var invIncome=ltInv*invRate;
  var realProfit=cfo-realSBC-maintCapex-restructuring+invIncome;
  var growthCapex=Math.max(capex-maintCapex,0);
  var investedCapital=equity>0?(equity+debt-cash-sti):0;
  var realROIC=investedCapital>0?realProfit/investedCapital:0;
  var reportedFCF=cfo-capex;
  var reinvestRate=investedCapital>0?growthCapex/investedCapital:0;
  var impliedGrowth=reinvestRate*realROIC;
  var nta=totalAssets>0?(totalAssets-goodwill-intangibles-cash-sti):0;
  var returnOnNTA=nta>0?realProfit/nta:0;
  return {cfo:cfo,realSBC:realSBC,maintCapex:maintCapex,maintCapexLight:maintCapexLight,deprOnly:deprOnly,growthCapex:growthCapex,realProfit:realProfit,realProfitLight:realProfitLight,realROICLight:realROICLight,returnOnNTALight:returnOnNTALight,investedCapital:investedCapital,realROIC:realROIC,reinvestRate:reinvestRate,impliedGrowth:impliedGrowth,reportedFCF:reportedFCF,equity:equity,debt:debt,sbcExp:sbcExp,sbcGrant:sbcGrant,capex:capex,da:da,totalAssets:totalAssets,goodwill:goodwill,intangibles:intangibles,nta:nta,returnOnNTA:returnOnNTA,revenue:entry.extra.revenue||entry.extra.total_revenue||entry.extra.net_revenue||null,net_income:entry.extra.net_income||null};
}

function renderPills(){
  var c=document.getElementById('yearPills');
  var keys=Object.keys(yearStore).sort(function(a,b){
    var da=yearStore[a].fiscal_year_end||a;
    var db=yearStore[b].fiscal_year_end||b;
    return da<db?-1:da>db?1:0;
  });
  if(keys.length===0){c.style.display='none';return;}
  c.style.display='flex';
  c.innerHTML=keys.map(function(k){
    var yr=yearStore[k];
    var label=yr.fiscal_year_label||(yr.fiscal_year_end?'FY'+new Date(yr.fiscal_year_end).getFullYear():k);
    var endD=yr.fiscal_year_end||'';
    var cur=k===currentYearKey;
    return '<span class="year-pill'+(cur?' current':'')+'" title="'+endD+'"><span class="load-year" onclick="loadYear(\''+k+'\')">'+label+(endD?' ('+endD+')':'')+'</span> <span class="remove-year" onclick="removeYear(\''+k+'\')" title="Remove">‚úï</span></span>';
  }).join('');
}

function loadYear(k){
  if(currentYearKey&&yearStore[currentYearKey])yearStore[currentYearKey].formData=captureForm();
  var yr=yearStore[k];
  if(yr){restoreForm(yr.formData);currentYearKey=k;renderPills();}
}

function removeYear(k){
  delete yearStore[k];
  if(currentYearKey===k)currentYearKey=null;
  renderPills();
  if(document.getElementById('results').style.display==='block')renderTrend();
}

// ============ Trend Rendering ============
function renderTrend(){
  var trendCard=document.getElementById('trendCard');
  var keys=Object.keys(yearStore).sort(function(a,b){
    var da=yearStore[a].fiscal_year_end||a;var db=yearStore[b].fiscal_year_end||b;return da<db?-1:da>db?1:0;
  });
  if(keys.length<2){trendCard.style.display='none';return;}
  trendCard.style.display='block';

  var years=keys.map(function(k){
    var yr=yearStore[k];
    var m=computeMetrics(yr);
    m.label=yr.fiscal_year_label||(yr.fiscal_year_end?'FY'+new Date(yr.fiscal_year_end).getFullYear():k);
    m.endDate=yr.fiscal_year_end||k;
    return m;
  });

  var html='';

  // SVG Chart
  var cW=720,cH=240,pL=55,pR=55,pT=25,pB=35;
  var plotW=cW-pL-pR,plotH=cH-pT-pB;
  var n=years.length;

  var roicVals=years.map(function(y){return y.realROIC});
  var rMin=Math.min.apply(null,roicVals)*0.8;
  var rMax=Math.max.apply(null,roicVals)*1.2;
  if(rMax-rMin<0.01){rMin-=0.05;rMax+=0.05;}
  var rRange=rMax-rMin;

  var profitVals=years.map(function(y){return y.realProfit});
  var pMin=Math.min.apply(null,profitVals.concat([0]))*0.9;
  var pMax=Math.max.apply(null,profitVals)*1.1;
  if(pMax-pMin<1){pMin-=1000;pMax+=1000;}
  var pRange=pMax-pMin;

  function xP(i){return pL+(n>1?i/(n-1)*plotW:plotW/2)}
  function yR(val){return pT+plotH-((val-rMin)/rRange*plotH)}
  function yP(val){return pT+plotH-((val-pMin)/pRange*plotH)}

  html+='<svg viewBox="0 0 '+cW+' '+cH+'" style="width:100%;height:auto;margin:16px 0;overflow:visible">';

  // Grid
  for(var i=0;i<=4;i++){
    var gy=pT+(plotH/4)*i;
    html+='<line x1="'+pL+'" y1="'+gy+'" x2="'+(cW-pR)+'" y2="'+gy+'" stroke="#333" stroke-width="0.5"/>';
    var rv=rMax-((rMax-rMin)/4)*i;
    html+='<text x="'+(pL-6)+'" y="'+(gy+4)+'" fill="#999" font-size="9" text-anchor="end" font-family="JetBrains Mono">'+(rv*100).toFixed(1)+'%</text>';
    var pv=pMax-((pMax-pMin)/4)*i;
    html+='<text x="'+(cW-pR+6)+'" y="'+(gy+4)+'" fill="#999" font-size="9" text-anchor="start" font-family="JetBrains Mono">'+fmtM(pv)+'</text>';
  }

  // X labels
  years.forEach(function(y,i){
    html+='<text x="'+xP(i)+'" y="'+(cH-6)+'" fill="#999" font-size="10" text-anchor="middle" font-family="DM Sans">'+y.label+'</text>';
  });

  // Axis titles
  html+='<text x="10" y="'+(pT+plotH/2)+'" fill="#d4a025" font-size="9" text-anchor="middle" font-family="DM Sans" transform="rotate(-90,10,'+(pT+plotH/2)+')">Real ROIC</text>';
  html+='<text x="'+(cW-6)+'" y="'+(pT+plotH/2)+'" fill="#3498db" font-size="9" text-anchor="middle" font-family="DM Sans" transform="rotate(90,'+(cW-6)+','+(pT+plotH/2)+')">Real Profit</text>';

  // Profit bars
  var barW=Math.min(36,plotW/n*0.5);
  var zeroY=yP(0);
  years.forEach(function(y,i){
    var bx=xP(i)-barW/2;
    var by=yP(y.realProfit);
    var topY=Math.min(by,zeroY);
    var bh=Math.abs(by-zeroY);
    var barColor=y.realProfit>=0?'rgba(52,152,219,0.35)':'rgba(231,76,60,0.35)';
    var barStroke=y.realProfit>=0?'#3498db':'#e74c3c';
    html+='<rect x="'+bx+'" y="'+topY+'" width="'+barW+'" height="'+bh+'" fill="'+barColor+'" stroke="'+barStroke+'" stroke-width="1" rx="3"/>';
  });

  // ROIC line
  if(n>1){
    var path=years.map(function(y,i){return (i===0?'M':'L')+xP(i).toFixed(1)+','+yR(y.realROIC).toFixed(1)}).join(' ');
    html+='<path d="'+path+'" fill="none" stroke="#d4a025" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>';
  }
  years.forEach(function(y,i){
    html+='<circle cx="'+xP(i)+'" cy="'+yR(y.realROIC)+'" r="4" fill="#d4a025" stroke="#0f0f0f" stroke-width="2"/>';
    html+='<text x="'+xP(i)+'" y="'+(yR(y.realROIC)-10)+'" fill="#d4a025" font-size="10" text-anchor="middle" font-family="JetBrains Mono" font-weight="600">'+pct(y.realROIC,1)+'</text>';
  });
  html+='</svg>';
  html+='<div class="chart-legend"><span><span class="dot" style="background:#d4a025"></span> Real ROIC (left axis)</span><span><span class="dot" style="background:#3498db"></span> Real Profit (right axis)</span></div>';

  // Trend data table
  html+='<table class="trend-table"><tr><th style="text-align:left">Metric</th>';
  years.forEach(function(y){html+='<th>'+y.label+'</th>'});
  html+='<th>Trend</th></tr>';

  var trendRows=[
    {label:'Real Profit',key:'realProfit',f:fmtM},
    {label:'CFO',key:'cfo',f:fmtM},
    {label:'Real SBC',key:'realSBC',f:fmtM,inv:true},
    {label:'Total CapEx',key:'capex',f:fmtM,inv:true},
    {label:'Maint CapEx',key:'maintCapex',f:fmtM},
    {label:'Growth CapEx',key:'growthCapex',f:fmtM},
    {label:'Invested Capital',key:'investedCapital',f:fmtM},
    {label:'Real ROIC',key:'realROIC',f:function(v){return pct(v,1)}},
    {label:'Reinvestment Rate',key:'reinvestRate',f:function(v){return pct(v,1)}},
    {label:'Implied Profit Growth',key:'impliedGrowth',f:function(v){return pct(v,1)}},
    {label:'Reported FCF',key:'reportedFCF',f:fmtM}
  ];
  // Add asset-light rows if any year has depreciation data
  if(years.some(function(y){return y.maintCapexLight!==null})){
    // Insert after Maint CapEx row (index 4)
    var insertIdx=trendRows.length;
    for(var ti=0;ti<trendRows.length;ti++){if(trendRows[ti].key==='reportedFCF'){insertIdx=ti;break;}}
    trendRows.splice(insertIdx,0,
      {label:'Maint CapEx (Asset-Light)',key:'maintCapexLight',f:function(v){return v!==null?fmtM(v):'‚Äî'}},
      {label:'Real Profit (Asset-Light)',key:'realProfitLight',f:function(v){return v!==null?fmtM(v):'‚Äî'}},
      {label:'Real ROIC (Asset-Light)',key:'realROICLight',f:function(v){return v!==null?pct(v,1):'‚Äî'}}
    );
  }
  if(years.some(function(y){return y.nta>0})){
    trendRows.push({label:'Net Tangible Assets',key:'nta',f:fmtM});
    trendRows.push({label:'Return on NTA',key:'returnOnNTA',f:function(v){return pct(v,1)}});
  }
  // Incremental Return on Growth CapEx (YoY: Œî Profit / Prior Year Growth CapEx)
  var hasIncremental=years.length>=2&&years.some(function(y){return y.growthCapex>0});
  if(hasIncremental){
    years.forEach(function(y,i){
      if(i===0){y.incrementalReturn=null;}
      else{
        var priorGC=years[i-1].growthCapex;
        var deltaProfit=y.realProfit-years[i-1].realProfit;
        y.incrementalReturn=priorGC>0?deltaProfit/priorGC:null;
      }
    });
    trendRows.push({label:'Incremental Return',key:'incrementalReturn',f:function(v){return v!==null?pct(v,1):'‚Äî'}});
  }
  if(years.some(function(y){return y.revenue})){
    trendRows.unshift({label:'Revenue',key:'revenue',f:fmtM});
  }

  trendRows.forEach(function(row){
    var vals=years.map(function(y){return y[row.key]});
    var first=vals[0],last=vals[vals.length-1];
    var trendClass='',trendText='‚Äî';
    if(first!=null&&last!=null&&Math.abs(first)>0){
      var ch=(last-first)/Math.abs(first);
      if(ch>0.05){trendClass=row.inv?'trend-down':'trend-up';trendText='‚Üë '+pct(ch,0);}
      else if(ch<-0.05){trendClass=row.inv?'trend-up':'trend-down';trendText='‚Üì '+pct(Math.abs(ch),0);}
      else trendText='‚Üí flat';
    }
    html+='<tr class="'+trendClass+'"><td>'+row.label+'</td>';
    vals.forEach(function(v){html+='<td>'+(v!=null?row.f(v):'‚Äî')+'</td>'});
    html+='<td class="trend-val" style="font-family:DM Sans;font-size:.75rem">'+trendText+'</td></tr>';
  });
  html+='</table>';

  // ============ Growth Decomposition ============
  if(years.length>=2){
    html+='<h3 style="color:var(--accent);margin:24px 0 8px;padding-top:16px;border-top:1px solid #333;font-size:.95rem">üî¨ Growth Decomposition</h3>';
    html+='<p style="font-size:.78rem;color:var(--text3);margin-bottom:16px">Where is profit growth coming from? Reinvestment engine (growth CapEx earning returns) vs. organic engine (existing base getting more productive).</p>';

    // For each year-over-year transition
    var decompData=[];
    for(var di=1;di<years.length;di++){
      var prev=years[di-1],curr=years[di];
      var profitChange=curr.realProfit-prev.realProfit;
      // Estimate reinvestment contribution: prior year growth capex * prior year ROIC
      // This assumes 1 year lag for growth capex to start earning
      var reinvestContrib=prev.growthCapex*prev.realROIC;
      var organicContrib=profitChange-reinvestContrib;
      decompData.push({
        from:prev.label,to:curr.label,
        profitChange:profitChange,
        reinvest:reinvestContrib,
        organic:organicContrib,
        prevProfit:prev.realProfit,
        currProfit:curr.realProfit,
        totalGrowthPct:prev.realProfit!==0?profitChange/Math.abs(prev.realProfit):0,
        capitalGrowthPct:(prev.investedCapital!==0)?(curr.investedCapital-prev.investedCapital)/Math.abs(prev.investedCapital):0
      });
    }

    // Summary metrics across all periods
    var totalProfitGrowth=years[years.length-1].realProfit-years[0].realProfit;
    var totalReinvest=decompData.reduce(function(s,d){return s+d.reinvest},0);
    var totalOrganic=decompData.reduce(function(s,d){return s+d.organic},0);
    var profitCAGR=years[0].realProfit>0?Math.pow(years[years.length-1].realProfit/years[0].realProfit,1/(years.length-1))-1:0;
    var capitalCAGR=years[0].investedCapital>0?Math.pow(years[years.length-1].investedCapital/years[0].investedCapital,1/(years.length-1))-1:0;

    // Capital efficiency ratio
    var efficiencyRatio=(capitalCAGR>0&&profitCAGR>0)?(profitCAGR/capitalCAGR):0;

    // Summary boxes
    html+='<div class="decomp-summary">';
    html+='<div class="decomp-stat"><div class="ds-val total-color">'+pct(profitCAGR,1)+'</div><div class="ds-lbl">Profit CAGR</div></div>';
    html+='<div class="decomp-stat"><div class="ds-val" style="color:var(--text2)">'+pct(capitalCAGR,1)+'</div><div class="ds-lbl">Capital CAGR</div></div>';
    html+='<div class="decomp-stat"><div class="ds-val '+(efficiencyRatio>=1?'organic-color':'neg-color')+'">'+efficiencyRatio.toFixed(2)+'x</div><div class="ds-lbl">Profit / Capital Growth</div></div>';
    html+='</div>';

    // Stacked bars for each period
    decompData.forEach(function(d){
      var absTotal=Math.abs(d.reinvest)+Math.abs(d.organic);
      if(absTotal===0)return;
      var reinvestPct=Math.abs(d.reinvest)/absTotal*100;
      var organicPct=Math.abs(d.organic)/absTotal*100;

      html+='<div class="decomp-row">';
      html+='<div class="decomp-label">'+d.from+' ‚Üí '+d.to+'</div>';
      html+='<div class="decomp-bar-track">';
      if(d.reinvest!==0){
        html+='<div class="decomp-seg reinvest" style="width:'+reinvestPct+'%" title="Reinvestment: '+fmtM(d.reinvest)+'">'+fmtM(d.reinvest)+'</div>';
      }
      if(d.organic!==0){
        var orgClass=d.organic>=0?'organic':'negative-organic';
        html+='<div class="decomp-seg '+orgClass+'" style="width:'+organicPct+'%" title="Organic: '+fmtM(d.organic)+'">'+(d.organic>=0?'+':'')+fmtM(d.organic)+'</div>';
      }
      html+='</div>';
      html+='</div>';

      // Period detail line
      html+='<div style="font-size:.72rem;color:var(--text3);margin:-4px 0 12px 120px">Œî Profit: '+fmtM(d.profitChange)+' ('+pct(d.totalGrowthPct,1)+') ¬∑ Capital grew '+pct(d.capitalGrowthPct,1)+'</div>';
    });

    // Legend
    html+='<div class="chart-legend" style="margin:12px 0"><span><span class="dot" style="background:#9b59b6"></span> Reinvestment engine (Growth CapEx √ó ROIC)</span><span><span class="dot" style="background:#2ecc71"></span> Organic growth (base productivity)</span></div>';

    // Interpretive narrative
    var avgOrganicPct=totalProfitGrowth!==0?totalOrganic/Math.abs(totalProfitGrowth):0;
    var narrative2='';
    if(avgOrganicPct>0.6){
      narrative2='<strong>Organic-Led Growth:</strong> ~'+Math.round(avgOrganicPct*100)+'% of profit growth comes from the existing base getting more productive ‚Äî pricing power, expanding margins, or growing users. This is high-quality growth that requires less capital to sustain.';
    }else if(avgOrganicPct>0.3){
      narrative2='<strong>Balanced Growth:</strong> Profit growth is split between organic improvement (~'+Math.round(avgOrganicPct*100)+'%) and reinvestment returns. Both engines are contributing, which is healthy.';
    }else if(avgOrganicPct>=0){
      narrative2='<strong>Reinvestment-Led Growth:</strong> Most profit growth (~'+Math.round((1-avgOrganicPct)*100)+'%) comes from growth CapEx earning returns. The existing base is stable but not expanding much on its own. Growth sustainability depends heavily on continued high-ROIC investment opportunities.';
    }else{
      narrative2='<strong>Base Erosion Alert:</strong> The organic base is actually shrinking ‚Äî existing operations are becoming less profitable. Growth CapEx is masking the decline. Watch for competitive pressure or margin compression in the core business.';
    }
    if(efficiencyRatio>=1.5){
      narrative2+=' The profit-to-capital growth ratio of '+efficiencyRatio.toFixed(1)+'x is excellent ‚Äî profit is growing significantly faster than capital deployed.';
    }else if(efficiencyRatio<0.8&&efficiencyRatio>0){
      narrative2+=' Profit is growing slower than capital ('+efficiencyRatio.toFixed(1)+'x) ‚Äî incremental returns may be dilutive.';
    }
    html+='<div class="flag '+(avgOrganicPct>0.3?'ok':avgOrganicPct>=0?'caution':'warn')+'" style="margin-top:12px">'+narrative2+'</div>';
    html+='<p class="section-note" style="margin-top:8px">Reinvestment contribution estimated as prior year Growth CapEx √ó ROIC (assumes ~1 year lag). Organic = total profit change minus reinvestment contribution.</p>';

    // ============ Profit Composition View ============
    html+='<h3 style="color:var(--accent);margin:24px 0 8px;padding-top:16px;border-top:1px solid #333;font-size:.95rem">üìä Profit Composition</h3>';
    html+='<p style="font-size:.78rem;color:var(--text3);margin-bottom:16px">How much of each year\'s real profit comes from the original base vs. cumulative returns on growth investments.</p>';

    // Build composition data
    // Year 0 = 100% organic base. Each subsequent year accumulates reinvestment layer.
    var baseProfit=years[0].realProfit;
    var compData=years.map(function(y,i){
      var reinvestLayer=0;
      // Sum up all reinvestment contributions from prior years
      for(var j=1;j<=i;j++){
        reinvestLayer+=years[j-1].growthCapex*years[j-1].realROIC;
      }
      var organicBase=y.realProfit-reinvestLayer;
      return {
        label:y.label,
        realProfit:y.realProfit,
        reinvestLayer:reinvestLayer,
        organicBase:organicBase,
        reinvestPct:y.realProfit>0?reinvestLayer/y.realProfit:0,
        organicPct:y.realProfit>0?organicBase/y.realProfit:0
      };
    });

    // Summary stats
    var latestComp=compData[compData.length-1];
    html+='<div class="decomp-summary">';
    html+='<div class="decomp-stat"><div class="ds-val organic-color">'+fmtM(latestComp.organicBase)+'</div><div class="ds-lbl">Organic Base ('+pct(latestComp.organicPct,0)+')</div></div>';
    html+='<div class="decomp-stat"><div class="ds-val reinvest-color">'+fmtM(latestComp.reinvestLayer)+'</div><div class="ds-lbl">Reinvestment Layer ('+pct(latestComp.reinvestPct,0)+')</div></div>';
    html+='<div class="decomp-stat"><div class="ds-val total-color">'+fmtM(latestComp.realProfit)+'</div><div class="ds-lbl">Total Real Profit</div></div>';
    html+='</div>';

    // Stacked bars for each year
    var maxProfit=Math.max.apply(null,compData.map(function(c){return Math.abs(c.realProfit)}));
    if(maxProfit===0)maxProfit=1;
    compData.forEach(function(c){
      var barWidth=Math.max(Math.abs(c.realProfit)/maxProfit*100,10);
      var orgPct=c.realProfit>0?Math.max(c.organicBase/c.realProfit*100,0):100;
      var reinPct=c.realProfit>0?Math.max(c.reinvestLayer/c.realProfit*100,0):0;
      // Clamp
      if(orgPct+reinPct>100){var scale=100/(orgPct+reinPct);orgPct*=scale;reinPct*=scale;}
      if(orgPct<0){reinPct=100;orgPct=0;}

      html+='<div class="decomp-row">';
      html+='<div class="decomp-label">'+c.label+'</div>';
      html+='<div class="decomp-bar-track" style="width:'+barWidth+'%">';
      if(orgPct>0){
        html+='<div class="decomp-seg organic" style="width:'+orgPct+'%">'+fmtM(c.organicBase)+'</div>';
      }
      if(reinPct>0){
        html+='<div class="decomp-seg reinvest" style="width:'+reinPct+'%">'+fmtM(c.reinvestLayer)+'</div>';
      }
      html+='</div>';
      html+='</div>';
    });

    html+='<div class="chart-legend" style="margin:12px 0"><span><span class="dot" style="background:#2ecc71"></span> Organic base earnings</span><span><span class="dot" style="background:#9b59b6"></span> Cumulative reinvestment returns</span></div>';

    // Interpretive note
    var orgTrend=compData.length>=2?(latestComp.organicBase-compData[0].organicBase):'';
    var compNarr='';
    if(latestComp.reinvestPct>0.4){
      compNarr='<strong>Compounding Engine Active:</strong> '+pct(latestComp.reinvestPct,0)+' of current profit comes from cumulative reinvestment returns ('+fmtM(latestComp.reinvestLayer)+'). The growth CapEx flywheel is a significant part of the earnings story.';
    }else if(latestComp.reinvestPct>0.15){
      compNarr='<strong>Growing Reinvestment Layer:</strong> '+pct(latestComp.reinvestPct,0)+' of profit now comes from reinvestment returns. The compounding engine is building but the organic base still dominates.';
    }else{
      compNarr='<strong>Organic-Dominant Earnings:</strong> '+pct(latestComp.organicPct,0)+' of profit comes from the organic base. The reinvestment layer is small ‚Äî either the company invests modestly or returns take more time to materialize.';
    }
    if(typeof orgTrend==='number'&&orgTrend<-compData[0].organicBase*0.1){
      compNarr+=' <span style="color:var(--orange)">Note: organic base has eroded by '+fmtM(Math.abs(orgTrend))+' ‚Äî core profitability may be declining.</span>';
    }
    html+='<div class="flag info" style="margin-top:8px">'+compNarr+'</div>';
    html+='<p class="section-note">Organic base = current profit minus cumulative reinvestment returns. Reinvestment layer = sum of each prior year\'s Growth CapEx √ó ROIC.</p>';
  }

  // ROIC trajectory narrative
  if(years.length>=2){
    var fR=years[0].realROIC,lR=years[years.length-1].realROIC;
    var rCh=lR-fR;
    var rPctCh=Math.abs(fR)>0?rCh/Math.abs(fR):0;
    var narrative='';
    if(Math.abs(rPctCh)<0.05){
      narrative='<strong>Stable ROIC:</strong> Real ROIC held at ~'+pct(lR,1)+' over '+years.length+' years. The company is maintaining returns even as invested capital grows ‚Äî a positive signal.';
    }else if(rCh>0){
      narrative='<strong>Improving ROIC:</strong> From '+pct(fR,1)+' to '+pct(lR,1)+' (+'+(rCh*100).toFixed(1)+'pp). Growth CapEx appears to be creating value.';
    }else{
      narrative='<strong>Compressing ROIC:</strong> From '+pct(fR,1)+' to '+pct(lR,1)+' ('+(rCh*100).toFixed(1)+'pp). New investments may be earning lower returns ‚Äî scrutinize growth CapEx quality.';
    }
    html+='<div class="flag info" style="margin-top:12px">'+narrative+'</div>';
  }

  document.getElementById('trendContent').innerHTML=html;
}

// ============ Markdown Generator (for download) ============
function generateMarkdown(ticker,price,years,latest,shares,ev,marketCap,realYield,unleverYield,realPE,gap,interest,taxPaid,totalAssets,rating,now,debt,cash,sti){
  var d='# Real Economic Profit Analysis: '+ticker+'\n';
  d+='Generated: '+now+' | Share Price: $'+price+' | Analysis Period: '+years[0].label+(years.length>1?' ‚Äì '+latest.label:'')+'\n\n---\n\n';
  d+='## Executive Summary\n\nReal Cash Yield on Enterprise Value: '+pct(realYield)+' ‚Äî '+rating+'\n\n';
  d+='| Metric | Value |\n|--------|-------|\n';
  d+='| Real Economic Profit | '+fmtM(latest.realProfit)+' ('+fmt(latest.realProfit/shares,2)+'/share) |\n';
  d+='| Enterprise Value | '+fmtM(ev)+' |\n| Market Cap | '+fmtM(marketCap)+' |\n| Real P/E | '+(realPE>0?realPE.toFixed(1)+'x':'N/A')+' |\n';
  d+='| Unlevered Yield | '+pct(unleverYield)+' |\n| Reported FCF | '+fmtM(latest.reportedFCF)+' |\n';
  d+='| Real vs Reported Gap | '+fmtM(gap)+' |\n| Real ROIC | '+pct(latest.realROIC)+' |\n| Invested Capital | '+fmtM(latest.investedCapital)+' |\n\n';

  d+='## Profit Waterfall ('+latest.label+')\n\n| Line Item | Amount | Notes |\n|-----------|--------|-------|\n';
  d+='| Cash From Operations | '+fmtM(latest.cfo)+' | |\n';
  d+='| ‚àí Real SBC Burden | '+fmtM(latest.realSBC)+' | '+(latest.sbcGrant>latest.sbcExp?'Grant Value (higher)':'Expense')+' |\n';
  d+='| ‚àí Maintenance CapEx | '+fmtM(latest.maintCapex)+' | |\n';
  var rs=latest.formData.restructuring||0;if(rs>0)d+='| ‚àí Restructuring | '+fmtM(rs)+' | |\n';
  d+='| = Real Economic Profit | '+fmtM(latest.realProfit)+' | |\n\n';

  d+='## Capital & ROIC ('+latest.label+')\n\n| Metric | Value |\n|--------|-------|\n';
  d+='| Total CapEx | '+fmtM(latest.capex)+' |\n| Growth CapEx | '+fmtM(latest.growthCapex)+' |\n| Maint CapEx | '+fmtM(latest.maintCapex)+' |\n';
  d+='| Real ROIC | '+pct(latest.realROIC)+' |\n| Invested Capital | '+fmtM(latest.investedCapital)+' |\n\n';

  if(years.length>=2){
    d+='## Historical Trend\n\n| Metric |';
    years.forEach(function(y){d+=' '+y.label+' |'});
    d+=' Trend |\n|--------|';
    years.forEach(function(){d+='--------|'});d+='-------|\n';
    [{l:'Real Profit',k:'realProfit'},{l:'CFO',k:'cfo'},{l:'Real SBC',k:'realSBC'},{l:'Total CapEx',k:'capex'},{l:'Growth CapEx',k:'growthCapex'},{l:'Real ROIC',k:'realROIC'}].concat(
      years.some(function(y){return y.maintCapexLight!==null})?[{l:'Real Profit (Asset-Light)',k:'realProfitLight'},{l:'Real ROIC (Asset-Light)',k:'realROICLight'}]:[]
    ).forEach(function(r){
      d+='| '+r.l+' |';
      var vals=years.map(function(y){return y[r.k]});
      vals.forEach(function(v){d+=' '+(v!=null?(r.k==='realROIC'?pct(v,1):fmtM(v)):'‚Äî')+' |'});
      var f=vals[0],l=vals[vals.length-1];
      var t='‚Äî';if(f!=null&&l!=null&&Math.abs(f)>0){var ch=(l-f)/Math.abs(f);if(ch>0.05)t='‚Üë '+pct(ch,0);else if(ch<-0.05)t='‚Üì '+pct(Math.abs(ch),0);else t='‚Üí flat';}
      d+=' '+t+' |\n';
    });
    d+='\n';
  }

  d+='## Methodology\n\nReal Economic Profit = CFO ‚àí Real SBC (MAX of expense vs grant value) ‚àí Maintenance CapEx ‚àí Restructuring + Investment Income\n\n';
  d+='Data sourced from SEC 10-K/10-Q filings. Extracted via Gemini AI with manual verification.\n';
  return d;
}

// ============ Export Analysis Brief ============
function exportBrief(){
  var ticker=document.getElementById('ticker').value||'Company';
  var price=v('price');
  var keys=Object.keys(yearStore).sort(function(a,b){
    var da=yearStore[a].fiscal_year_end||a;var db=yearStore[b].fiscal_year_end||b;return da<db?-1:da>db?1:0;
  });

  var years=keys.map(function(k){
    var yr=yearStore[k];
    var m=computeMetrics(yr);
    m.label=yr.fiscal_year_label||(yr.fiscal_year_end?'FY'+new Date(yr.fiscal_year_end).getFullYear():k);
    m.endDate=yr.fiscal_year_end||k;
    m.formData=yr.formData;
    m.extra=yr.extra;
    return m;
  });

  if(years.length===0){
    var fd=captureForm();
    var cfo=fd.cfo||0,sbcExp=fd.sbc_expense||0,sbcGrant=fd.sbc_grant||0;
    var capex=fd.capex||0,da=fd.da||0,mc=fd.maint_capex;
    var restructuring=fd.restructuring||0;
    var ltInv=fd.lt_investments||0,invRate=(fd.inv_return_rate||4)/100;
    var eq=fd.equity||0,dbt=fd.debt||0,csh=fd.cash||0,st=fd.sti||0;
    var maintCapex;
    if(mc!==null&&mc>0){maintCapex=mc;}else{var ratio=da>0?capex/da:999;if(ratio>=0.8&&ratio<=1.2)maintCapex=capex;else maintCapex=da*1.05;}
    var realSBC=Math.max(sbcExp,sbcGrant);
    var invIncome=ltInv*invRate;
    var rp=cfo-realSBC-maintCapex-restructuring+invIncome;
    var gc=Math.max(capex-maintCapex,0);
    var ic=eq>0?(eq+dbt-csh-st):0;
    var roic=ic>0?rp/ic:0;
    var rfcf=cfo-capex;
    years=[{label:'Current',endDate:'',cfo:cfo,realSBC:realSBC,maintCapex:maintCapex,growthCapex:gc,realProfit:rp,investedCapital:ic,realROIC:roic,reportedFCF:rfcf,equity:eq,debt:dbt,sbcExp:sbcExp,sbcGrant:sbcGrant,capex:capex,da:da,revenue:null,net_income:null,formData:fd,extra:{}}];
  }

  var latest=years[years.length-1];
  var shares=latest.formData.shares||0;
  var marketCap=price*shares;
  var cash=latest.formData.cash||0;
  var sti=latest.formData.sti||0;
  var debt=latest.debt||0;
  var ev=marketCap+debt-(cash+sti);
  var realYield=ev>0?latest.realProfit/ev:0;
  var unleverYield=ev>0?(latest.realProfit+(latest.formData.interest||0))/ev:0;
  var realPE=shares>0?price/(latest.realProfit/shares):0;
  var gap=latest.realProfit-latest.reportedFCF;
  var interest=latest.formData.interest||0;
  var taxPaid=latest.formData.tax_paid||0;
  var totalAssets=latest.formData.total_assets||0;

  var rating,ratingColor;
  if(realYield>=0.07){rating='Strong Value';ratingColor='#2ecc71';}
  else if(realYield>=0.04){rating='Fair Value';ratingColor='#3498db';}
  else if(realYield>=0.02){rating='Growth Priced In';ratingColor='#e67e22';}
  else{rating='Expensive';ratingColor='#e74c3c';}

  var now=new Date().toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'});

  // Build HTML document
  var h='<!DOCTYPE html><html><head><meta charset="UTF-8"><title>'+ticker+' ‚Äî Real Economic Profit Brief</title>';
  h+='<style>';
  h+='*{margin:0;padding:0;box-sizing:border-box}';
  h+='body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;max-width:850px;margin:0 auto;padding:40px 32px;color:#1a1a1a;line-height:1.6;background:#fff}';
  h+='h1{font-size:1.8rem;font-weight:700;margin-bottom:4px;color:#111}';
  h+='.meta{color:#666;font-size:.85rem;margin-bottom:24px;padding-bottom:16px;border-bottom:2px solid #111}';
  h+='h2{font-size:1.15rem;font-weight:700;color:#111;margin:32px 0 12px;padding-bottom:6px;border-bottom:1px solid #ddd}';
  h+='h2:first-of-type{margin-top:0}';
  h+='.verdict-box{background:#f8f9fa;border:2px solid #ddd;border-radius:8px;padding:20px 24px;margin:0 0 24px;text-align:center}';
  h+='.verdict-box .yield{font-size:2rem;font-weight:700;line-height:1.2}';
  h+='.verdict-box .label{font-size:.9rem;color:#666;margin-top:4px}';
  h+='.verdict-box .rating{display:inline-block;padding:3px 14px;border-radius:20px;font-size:.82rem;font-weight:600;margin-top:8px;color:#fff}';
  h+='table{width:100%;border-collapse:collapse;margin:8px 0 16px;font-size:.88rem}';
  h+='th{text-align:left;padding:8px 10px;border-bottom:2px solid #ddd;color:#555;font-weight:600;font-size:.78rem;text-transform:uppercase;letter-spacing:.3px}';
  h+='td{padding:7px 10px;border-bottom:1px solid #eee}';
  h+='td:last-child,th:last-child{text-align:right}';
  h+='tr:nth-child(even){background:#fafafa}';
  h+='.subtotal td{border-top:2px solid #333;font-weight:700;background:#f0f0f0}';
  h+='.neg{color:#c0392b}';
  h+='.pos{color:#27ae60}';
  h+='.flag{padding:8px 12px;border-radius:6px;margin-bottom:6px;font-size:.85rem;line-height:1.5}';
  h+='.flag.warn{background:#fdf0ed;border-left:3px solid #e74c3c}';
  h+='.flag.caution{background:#fef9ed;border-left:3px solid #e67e22}';
  h+='.flag.ok{background:#edfaf2;border-left:3px solid #2ecc71}';
  h+='.flag.info{background:#edf4fe;border-left:3px solid #3498db}';
  h+='.flag.growth{background:#f5edfc;border-left:3px solid #9b59b6}';
  h+='.narrative{background:#f8f9fa;border-radius:6px;padding:12px 16px;margin:8px 0;font-size:.88rem;line-height:1.6}';
  h+='.methodology{font-size:.82rem;color:#666;line-height:1.6;margin-top:8px}';
  h+='.section-note{font-size:.78rem;color:#888;font-style:italic;margin:4px 0 12px}';
  h+='@media print{';
  h+='body{padding:16px 20px;font-size:11pt;color:#000;max-width:100%}';
  h+='.no-print{display:none!important}';
  h+='h1{font-size:16pt;color:#000;margin-bottom:2px}';
  h+='.meta{color:#444;border-bottom:2px solid #000;padding-bottom:8px;margin-bottom:12px;font-size:9pt}';
  h+='h2{font-size:12pt;color:#000;margin:18px 0 6px;padding-bottom:4px;border-bottom:1px solid #999;break-after:avoid}';
  h+='.verdict-box{border:2px solid #333;padding:14px;margin-bottom:14px;break-inside:avoid}';
  h+='.verdict-box .yield{font-size:20pt;color:#000!important}';
  h+='.verdict-box .rating{border:1px solid #333;color:#000!important;background:#eee!important}';
  h+='table{width:100%;border-collapse:collapse;margin:4px 0 10px;font-size:9.5pt;break-inside:avoid}';
  h+='th{padding:5px 8px;border-bottom:2px solid #333;color:#000;font-weight:700;font-size:8.5pt;background:#f0f0f0!important;-webkit-print-color-adjust:exact;print-color-adjust:exact}';
  h+='td{padding:5px 8px;border-bottom:1px solid #ccc;color:#000}';
  h+='tr:nth-child(even){background:#f5f5f5!important;-webkit-print-color-adjust:exact;print-color-adjust:exact}';
  h+='.subtotal td{border-top:2px solid #000;font-weight:700;background:#e8e8e8!important;-webkit-print-color-adjust:exact;print-color-adjust:exact}';
  h+='.neg{color:#000;font-weight:600}';
  h+='.pos{color:#000;font-weight:600}';
  h+='.flag{padding:6px 10px;margin-bottom:4px;font-size:9.5pt;border-radius:4px;break-inside:avoid;-webkit-print-color-adjust:exact;print-color-adjust:exact}';
  h+='.flag.warn{background:#fdf0ed!important;border-left:3px solid #c0392b!important}';
  h+='.flag.caution{background:#fef9ed!important;border-left:3px solid #e67e22!important}';
  h+='.flag.ok{background:#edfaf2!important;border-left:3px solid #27ae60!important}';
  h+='.flag.info{background:#edf4fe!important;border-left:3px solid #3498db!important}';
  h+='.flag.growth{background:#f5edfc!important;border-left:3px solid #9b59b6!important}';
  h+='.narrative{background:#f5f5f5!important;-webkit-print-color-adjust:exact;print-color-adjust:exact;padding:8px 12px;border-radius:4px;font-size:9.5pt;break-inside:avoid;margin:6px 0}';
  h+='.methodology{font-size:8.5pt;color:#444}';
  h+='.section-note{font-size:8pt;color:#666}';
  h+='}';
  h+='.action-bar{display:flex;gap:8px;margin-bottom:20px}.action-bar button{padding:8px 18px;border-radius:6px;border:1px solid #ddd;background:#fff;font-size:.85rem;cursor:pointer;font-family:inherit;font-weight:500;transition:background .2s}.action-bar button:hover{background:#f0f0f0}';
  h+='</style></head><body>';

  // Action bar
  h+='<div class="action-bar no-print">';
  h+='<button onclick="window.print()">üñ® Print / Save as PDF</button>';
  h+='<button onclick="downloadHTML()">üíæ Download HTML</button>';
  h+='<button onclick="downloadMD()">üìÑ Download Markdown</button>';
  h+='</div>';

  // Header
  h+='<h1>Real Economic Profit Analysis: '+ticker+'</h1>';
  h+='<div class="meta">Generated: '+now+' &nbsp;|&nbsp; Share Price: $'+price+' &nbsp;|&nbsp; Analysis Period: '+years[0].label+(years.length>1?' ‚Äì '+latest.label:'')+'</div>';

  // Verdict
  h+='<div class="verdict-box"><div class="yield" style="color:'+ratingColor+'">'+pct(realYield)+'</div>';
  h+='<div class="label">Real Cash Yield on Enterprise Value ‚Äî '+ticker+'</div>';
  h+='<div class="rating" style="background:'+ratingColor+'">'+rating+'</div></div>';

  // Executive Summary
  h+='<h2>Executive Summary</h2>';
  h+='<table><tr><th>Metric</th><th>Value</th></tr>';
  h+='<tr><td>Real Economic Profit</td><td>'+fmtM(latest.realProfit)+' ('+fmt(latest.realProfit/shares,2)+'/share)</td></tr>';
  h+='<tr><td>Enterprise Value</td><td>'+fmtM(ev)+'</td></tr>';
  h+='<tr><td>Market Cap</td><td>'+fmtM(marketCap)+'</td></tr>';
  h+='<tr><td>Real P/E</td><td>'+(realPE>0?realPE.toFixed(1)+'x':'N/A')+'</td></tr>';
  h+='<tr><td>Unlevered Yield</td><td>'+pct(unleverYield)+'</td></tr>';
  h+='<tr><td>Reported FCF</td><td>'+fmtM(latest.reportedFCF)+'</td></tr>';
  h+='<tr><td>Real vs Reported Gap</td><td class="'+(gap>=0?'pos':'neg')+'">'+fmtM(gap)+'</td></tr>';
  h+='<tr><td>Real ROIC</td><td>'+pct(latest.realROIC)+'</td></tr>';
  h+='<tr><td>Invested Capital</td><td>'+fmtM(latest.investedCapital)+'</td></tr>';
  h+='</table>';

  // Profit Waterfall
  h+='<h2>Profit Waterfall ('+latest.label+')</h2>';
  h+='<table><tr><th>Line Item</th><th style="text-align:left">Notes</th><th>Amount</th></tr>';
  h+='<tr><td>Cash From Operations</td><td style="text-align:left"></td><td>'+fmtM(latest.cfo)+'</td></tr>';
  h+='<tr><td>‚àí Real SBC Burden (MAX)</td><td style="text-align:left;color:#888">'+(latest.sbcGrant>latest.sbcExp?'Grant Value (higher than expense)':'Expense')+'</td><td class="neg">'+fmtM(latest.realSBC)+'</td></tr>';
  h+='<tr><td style="padding-left:24px;color:#888">SBC Expense</td><td style="text-align:left;color:#888">From cash flow statement</td><td style="color:#888">'+fmtM(latest.sbcExp)+'</td></tr>';
  h+='<tr><td style="padding-left:24px;color:#888">SBC Grant Value</td><td style="text-align:left;color:#888">RSUs granted √ó grant date FV</td><td style="color:#888">'+fmtM(latest.sbcGrant)+'</td></tr>';
  h+='<tr><td>‚àí Maintenance CapEx</td><td style="text-align:left;color:#888">'+(latest.formData.maint_capex>0?'Disclosed':'D&A √ó 1.05 estimate')+' (Conservative)</td><td class="neg">'+fmtM(latest.maintCapex)+'</td></tr>';
  var restruct=latest.formData.restructuring||0;
  if(restruct>0)h+='<tr><td>‚àí Restructuring</td><td style="text-align:left"></td><td class="neg">'+fmtM(restruct)+'</td></tr>';
  h+='<tr class="subtotal"><td>= Real Economic Profit (Conservative)</td><td style="text-align:left"></td><td>'+fmtM(latest.realProfit)+'</td></tr>';
  if(latest.maintCapexLight!==null){
    h+='<tr><td colspan="3" style="padding:4px;border-bottom:none"></td></tr>';
    h+='<tr><td>‚àí Maintenance CapEx (Asset-Light)</td><td style="text-align:left;color:#888">Depreciation Only √ó 1.05</td><td class="neg">'+fmtM(latest.maintCapexLight)+'</td></tr>';
    h+='<tr class="subtotal"><td>= Real Economic Profit (Asset-Light)</td><td style="text-align:left;color:#888">Excl. acquisition amortization</td><td>'+fmtM(latest.realProfitLight)+'</td></tr>';
  }
  h+='</table>';

  // Capital & ROIC
  h+='<h2>Capital &amp; ROIC Analysis ('+latest.label+')</h2>';
  h+='<table><tr><th>Metric</th><th>Value</th></tr>';
  h+='<tr><td>Total CapEx</td><td>'+fmtM(latest.capex)+'</td></tr>';
  h+='<tr><td>D&amp;A</td><td>'+fmtM(latest.da)+'</td></tr>';
  h+='<tr><td>Maintenance CapEx</td><td>'+fmtM(latest.maintCapex)+'</td></tr>';
  h+='<tr><td>Growth CapEx</td><td>'+fmtM(latest.growthCapex)+'</td></tr>';
  h+='<tr><td>Growth CapEx % of Total</td><td>'+pct(latest.capex>0?latest.growthCapex/latest.capex:0,0)+'</td></tr>';
  if(latest.maintCapexLight!==null){
    h+='<tr><td>Depreciation Only</td><td>'+fmtM(latest.deprOnly)+'</td></tr>';
    h+='<tr><td>Amortization</td><td>'+fmtM(latest.da-latest.deprOnly)+'</td></tr>';
    h+='<tr><td>Maint CapEx (Asset-Light)</td><td>'+fmtM(latest.maintCapexLight)+'</td></tr>';
    h+='<tr><td><strong>Real Profit (Asset-Light)</strong></td><td><strong>'+fmtM(latest.realProfitLight)+'</strong></td></tr>';
    h+='<tr><td><strong>Real ROIC (Asset-Light)</strong></td><td><strong>'+pct(latest.realROICLight)+'</strong></td></tr>';
  }
  h+='<tr><td>Shareholders Equity</td><td>'+fmtM(latest.equity)+'</td></tr>';
  h+='<tr><td>Total Debt</td><td>'+fmtM(debt)+'</td></tr>';
  h+='<tr><td>Cash &amp; STI</td><td>'+fmtM(cash+sti)+'</td></tr>';
  h+='<tr><td>Invested Capital</td><td>'+fmtM(latest.investedCapital)+'</td></tr>';
  h+='<tr><td><strong>Real ROIC</strong></td><td><strong>'+pct(latest.realROIC)+'</strong></td></tr>';
  var expReinvestRate=latest.investedCapital>0?latest.growthCapex/latest.investedCapital:0;
  var expImpliedGrowth=expReinvestRate*latest.realROIC;
  h+='<tr><td>Reinvestment Rate</td><td>'+pct(expReinvestRate,1)+'</td></tr>';
  h+='<tr><td>Implied Profit Growth</td><td>'+pct(expImpliedGrowth,1)+'</td></tr>';
  if(latest.nta>0){
    h+='<tr><td>Net Tangible Assets</td><td>'+fmtM(latest.nta)+'</td></tr>';
    h+='<tr><td><strong>Return on NTA</strong></td><td><strong>'+pct(latest.returnOnNTA)+'</strong></td></tr>';
  }
  if(totalAssets>0)h+='<tr><td>Total Assets</td><td>'+fmtM(totalAssets)+'</td></tr>';
  if(interest>0)h+='<tr><td>Interest Paid</td><td>'+fmtM(interest)+'</td></tr>';
  if(taxPaid>0)h+='<tr><td>Income Tax Paid</td><td>'+fmtM(taxPaid)+'</td></tr>';
  h+='</table>';

  // Growth CapEx Scenarios ‚Äî FIX: always sort Bear < Base < Bull
  if(latest.growthCapex>0){
    h+='<h2>Growth CapEx Return Scenarios</h2>';
    h+='<p class="section-note">If growth CapEx of '+fmtM(latest.growthCapex)+'/yr earns a given return, what will real profit become?</p>';

    var baseROIC=latest.realROIC;
    var bearROIC=0.10;
    var bullROIC=Math.max(baseROIC*1.25,baseROIC+0.05);
    if(baseROIC<=0.10){bearROIC=0.05;bullROIC=0.20;}
    if(bullROIC<=bearROIC+0.05)bullROIC=bearROIC+0.15;
    var scenarios=[
      {label:'Bear ('+pct(bearROIC,0)+')',roic:bearROIC},
      {label:'Base ('+pct(baseROIC,0)+')',roic:baseROIC},
      {label:'Bull ('+pct(bullROIC,0)+')',roic:bullROIC}
    ];

    h+='<table><tr><th style="text-align:left">Scenario</th><th>New Profit (Yr 3)</th><th>Yield (Yr 3)</th><th>New Profit (Yr 5)</th><th>Yield (Yr 5)</th></tr>';
    scenarios.forEach(function(s,i){
      var a3=latest.growthCapex*s.roic*3,a5=latest.growthCapex*s.roic*5;
      var p3=latest.realProfit+a3,p5=latest.realProfit+a5;
      var y3=ev>0?p3/ev:0,y5=ev>0?p5/ev:0;
      var style=i===1?' style="font-weight:700;background:#f0f0f0"':'';
      h+='<tr'+style+'><td style="text-align:left">'+s.label+'</td><td>'+fmtM(p3)+'</td><td>'+pct(y3)+'</td><td>'+fmtM(p5)+'</td><td>'+pct(y5)+'</td></tr>';
    });
    h+='</table>';
    h+='<p class="section-note">Assumes constant EV (no price change) and cumulative returns on annual growth CapEx.</p>';
  }

  // Historical Trend
  if(years.length>=2){
    h+='<h2>Historical Trend</h2>';
    h+='<table><tr><th style="text-align:left">Metric</th>';
    years.forEach(function(y){h+='<th>'+y.label+'</th>'});
    h+='<th>Trend</th></tr>';

    var trendRows=[
      {label:'Revenue',key:'revenue',f:fmtM},
      {label:'Real Profit',key:'realProfit',f:fmtM},
      {label:'CFO',key:'cfo',f:fmtM},
      {label:'Real SBC',key:'realSBC',f:fmtM,inv:true},
      {label:'Total CapEx',key:'capex',f:fmtM,inv:true},
      {label:'Maint CapEx',key:'maintCapex',f:fmtM},
      {label:'Growth CapEx',key:'growthCapex',f:fmtM},
      {label:'Invested Capital',key:'investedCapital',f:fmtM},
      {label:'Real ROIC',key:'realROIC',f:function(v){return pct(v,1)}},
      {label:'Reinvestment Rate',key:'reinvestRate',f:function(v){return pct(v,1)}},
      {label:'Implied Growth',key:'impliedGrowth',f:function(v){return pct(v,1)}},
      {label:'Reported FCF',key:'reportedFCF',f:fmtM},
      {label:'Return on NTA',key:'returnOnNTA',f:function(v){return v>0?pct(v,1):'‚Äî'}}
    ];

    trendRows.forEach(function(row){
      var vals=years.map(function(y){return y[row.key]});
      var first=vals[0],last=vals[vals.length-1];
      var trendText='‚Äî',trendClass='';
      if(first!=null&&last!=null&&Math.abs(first)>0){
        var ch=(last-first)/Math.abs(first);
        if(ch>0.05){trendClass=row.inv?'neg':'pos';trendText='‚Üë '+pct(ch,0);}
        else if(ch<-0.05){trendClass=row.inv?'pos':'neg';trendText='‚Üì '+pct(Math.abs(ch),0);}
        else trendText='‚Üí flat';
      }
      h+='<tr><td style="text-align:left">'+row.label+'</td>';
      vals.forEach(function(v){h+='<td>'+(v!=null?row.f(v):'‚Äî')+'</td>'});
      h+='<td class="'+trendClass+'">'+trendText+'</td></tr>';
    });
    h+='</table>';

    // Growth Decomposition
    h+='<h2>Growth Decomposition</h2>';
    var profitCAGR=years[0].realProfit>0?Math.pow(years[years.length-1].realProfit/years[0].realProfit,1/(years.length-1))-1:0;
    var capitalCAGR=years[0].investedCapital>0?Math.pow(years[years.length-1].investedCapital/years[0].investedCapital,1/(years.length-1))-1:0;
    var effRatio=(capitalCAGR>0&&profitCAGR>0)?(profitCAGR/capitalCAGR):0;

    h+='<table style="max-width:400px"><tr><th style="text-align:left">Metric</th><th>Value</th></tr>';
    h+='<tr><td style="text-align:left">Profit CAGR</td><td>'+pct(profitCAGR,1)+'</td></tr>';
    h+='<tr><td style="text-align:left">Capital CAGR</td><td>'+pct(capitalCAGR,1)+'</td></tr>';
    h+='<tr><td style="text-align:left">Profit / Capital Growth</td><td '+(effRatio>=1?'class="pos"':'class="neg"')+'>'+effRatio.toFixed(2)+'x</td></tr>';
    h+='</table>';

    // Period-by-period decomposition ‚Äî FIX: handle negative organic cleanly
    var totalPG=years[years.length-1].realProfit-years[0].realProfit;
    var totalReinvest=0,totalOrganic=0;
    var decompPeriods=[];
    for(var di=1;di<years.length;di++){
      var prev=years[di-1],curr=years[di];
      var pc=curr.realProfit-prev.realProfit;
      var rc=prev.growthCapex*prev.realROIC;
      var oc=pc-rc;
      totalReinvest+=rc;totalOrganic+=oc;
      decompPeriods.push({from:prev.label,to:curr.label,profitChange:pc,reinvest:rc,organic:oc});
    }
    var avgOrganicPct=totalPG!==0?totalOrganic/Math.abs(totalPG):0;

    h+='<table><tr><th style="text-align:left">Period</th><th>Œî Profit</th><th>Reinvestment</th><th>Organic</th><th>Assessment</th></tr>';
    decompPeriods.forEach(function(d){
      // FIX: show readable assessment instead of raw %
      var assessment='';
      if(d.profitChange<=0&&d.organic<0)assessment='Organic base contracted';
      else if(d.organic<0)assessment='Organic drag; reinvestment offset it';
      else if(d.organic>Math.abs(d.reinvest)*2)assessment='Organic-led growth';
      else if(d.organic>d.reinvest)assessment='Mostly organic';
      else assessment='Reinvestment-led';
      var orgClass=d.organic>=0?'pos':'neg';
      h+='<tr><td style="text-align:left">'+d.from+' ‚Üí '+d.to+'</td><td>'+fmtM(d.profitChange)+'</td><td>'+fmtM(d.reinvest)+'</td><td class="'+orgClass+'">'+fmtM(d.organic)+'</td><td style="text-align:left;font-size:.82rem;color:#666">'+assessment+'</td></tr>';
    });
    h+='</table>';

    // Growth narrative
    var narrative='';
    if(avgOrganicPct>0.6){
      narrative='<strong>Growth Assessment: Organic-Led.</strong> ~'+Math.round(avgOrganicPct*100)+'% of profit growth comes from the existing base getting more productive ‚Äî pricing power, expanding margins, or growing users. High-quality growth requiring less capital.';
    }else if(avgOrganicPct>0.3){
      narrative='<strong>Growth Assessment: Balanced.</strong> Profit growth split between organic improvement (~'+Math.round(avgOrganicPct*100)+'%) and reinvestment returns. Both engines contributing.';
    }else if(avgOrganicPct>=0){
      narrative='<strong>Growth Assessment: Reinvestment-Led.</strong> Most profit growth (~'+Math.round((1-avgOrganicPct)*100)+'%) from growth CapEx earning returns. Sustainability depends on continued investment opportunities.';
    }else{
      narrative='<strong>Growth Assessment: Base Erosion.</strong> Organic base is shrinking. Growth CapEx masking decline in core profitability.';
    }
    h+='<div class="narrative">'+narrative+'</div>';

    // ROIC trajectory ‚Äî FIX: detect V-shape / non-linear patterns
    var fR=years[0].realROIC,lR=years[years.length-1].realROIC;
    var rCh=lR-fR;
    var roicNarr='';
    if(years.length>=3){
      // Check for V-shape or inverted V
      var midROICs=years.slice(1,-1).map(function(y){return y.realROIC});
      var minMid=Math.min.apply(null,midROICs);
      var maxMid=Math.max.apply(null,midROICs);
      var isVShape=(minMid<fR-0.02)&&(lR>minMid+0.02);
      var isInvV=(maxMid>fR+0.02)&&(lR<maxMid-0.02);

      if(isVShape){
        roicNarr='<strong>ROIC Trajectory: V-Shaped Recovery.</strong> Dipped from '+pct(fR,1)+' to '+pct(minMid,1)+' before recovering to '+pct(lR,1)+'. ';
        if(lR>=fR-0.02)roicNarr+='Returns have largely recovered despite significantly more capital deployed ‚Äî a strong signal.';
        else roicNarr+='Recovery underway but not yet back to prior peak. Watch whether the trend continues.';
      }else if(isInvV){
        roicNarr='<strong>ROIC Trajectory: Peaked and Declining.</strong> Rose from '+pct(fR,1)+' to '+pct(maxMid,1)+' then fell to '+pct(lR,1)+'. Returns may be compressing as investment scales.';
      }else if(Math.abs(rCh)<0.005){
        roicNarr='<strong>ROIC Trajectory: Stable</strong> at ~'+pct(lR,1)+'. Maintaining returns as capital grows ‚Äî positive signal.';
      }else if(rCh>0){
        roicNarr='<strong>ROIC Trajectory: Improving</strong> from '+pct(fR,1)+' to '+pct(lR,1)+' (+'+(rCh*100).toFixed(1)+'pp). Growth CapEx appears value-creating.';
      }else{
        roicNarr='<strong>ROIC Trajectory: Compressing</strong> from '+pct(fR,1)+' to '+pct(lR,1)+' ('+(rCh*100).toFixed(1)+'pp). New investments may earn lower returns.';
      }
    }else{
      if(Math.abs(rCh)<0.005){
        roicNarr='<strong>ROIC Trajectory: Stable</strong> at ~'+pct(lR,1)+'.';
      }else if(rCh>0){
        roicNarr='<strong>ROIC Trajectory: Improving</strong> from '+pct(fR,1)+' to '+pct(lR,1)+' (+'+(rCh*100).toFixed(1)+'pp).';
      }else{
        roicNarr='<strong>ROIC Trajectory: Compressing</strong> from '+pct(fR,1)+' to '+pct(lR,1)+' ('+(rCh*100).toFixed(1)+'pp).';
      }
    }
    h+='<div class="narrative">'+roicNarr+'</div>';
  }

  // Red Flags & Signals
  h+='<h2>Signals &amp; Red Flags</h2>';
  var flags=[];
  var sbcPctCFO=latest.realSBC/latest.cfo;
  if(latest.sbcGrant>0&&latest.sbcGrant>latest.sbcExp*1.2){
    flags.push({type:'warn',text:'<strong>‚ö† Hidden SBC Dilution:</strong> Grant Value is '+(latest.sbcGrant/latest.sbcExp).toFixed(1)+'x the expensed amount ‚Äî significant dilution not reflected in reported earnings.'});
  }
  if(sbcPctCFO>0.3)flags.push({type:'warn',text:'<strong>‚ö† SBC as % of CFO:</strong> '+pct(sbcPctCFO,1)+' ‚Äî shareholders funding large portion of compensation.'});
  else if(sbcPctCFO>0.15)flags.push({type:'caution',text:'<strong>‚ö° SBC as % of CFO:</strong> '+pct(sbcPctCFO,1)+' ‚Äî moderate, worth watching.'});
  else flags.push({type:'ok',text:'<strong>‚úì SBC as % of CFO:</strong> '+pct(sbcPctCFO,1)+' ‚Äî reasonable.'});

  if(debt>0&&latest.realProfit>0){
    var debtRatio=debt/latest.realProfit;
    if(debtRatio>8)flags.push({type:'warn',text:'<strong>‚ö† High Leverage:</strong> Debt is '+debtRatio.toFixed(1)+'x real profit.'});
    else if(debtRatio>4)flags.push({type:'caution',text:'<strong>‚ö° Moderate Leverage:</strong> Debt is '+debtRatio.toFixed(1)+'x real profit.'});
    else flags.push({type:'ok',text:'<strong>‚úì Leverage:</strong> Debt is '+debtRatio.toFixed(1)+'x real profit ‚Äî manageable.'});
  }
  if(latest.realROIC>0.20)flags.push({type:'ok',text:'<strong>‚úì Real ROIC:</strong> '+pct(latest.realROIC)+' ‚Äî exceptional returns on invested capital.'});
  else if(latest.realROIC>0.12)flags.push({type:'ok',text:'<strong>‚úì Real ROIC:</strong> '+pct(latest.realROIC)+' ‚Äî solid returns above cost of capital.'});
  else if(latest.realROIC>0.06)flags.push({type:'caution',text:'<strong>‚ö° Real ROIC:</strong> '+pct(latest.realROIC)+' ‚Äî moderate.'});
  else flags.push({type:'warn',text:'<strong>‚ö† Real ROIC:</strong> '+pct(latest.realROIC)+' ‚Äî below typical cost of capital.'});

  if(latest.growthCapex>0&&latest.growthCapex>latest.maintCapex){
    var growthPct=latest.growthCapex/latest.capex;
    flags.push({type:'growth',text:'<strong>üöÄ Growth Investment:</strong> '+fmtM(latest.growthCapex)+' ('+pct(growthPct,0)+' of total CapEx) deployed as growth spending.'});
  }
  if(realYield>=0.07)flags.push({type:'ok',text:'<strong>‚úì Yield:</strong> '+pct(realYield)+' ‚Äî strong cash generation relative to price.'});
  else if(realYield>=0.04)flags.push({type:'ok',text:'<strong>‚úì Yield:</strong> '+pct(realYield)+' ‚Äî fair cash generation for the price.'});
  else if(realYield>=0.02)flags.push({type:'caution',text:'<strong>‚ö° Yield:</strong> '+pct(realYield)+' ‚Äî growth priced in, need earnings growth to justify.'});
  else flags.push({type:'warn',text:'<strong>‚ö† Yield:</strong> '+pct(realYield)+' ‚Äî expensive, market pricing exceptional growth.'});

  flags.forEach(function(f){h+='<div class="flag '+f.type+'">'+f.text+'</div>'});

  // Risk flags from extraction
  if(keys.length>0){
    var latestKey=keys[keys.length-1];
    var latestYr=yearStore[latestKey];
    if(latestYr&&latestYr.extra){
      var rf=latestYr.extra.risk_flags||latestYr.extra['risk_flags']||null;
      if(rf&&typeof rf==='string'){
        var rfType=rf.toLowerCase().indexOf('no material')===-1?'warn':'ok';
        h+='<div class="flag '+rfType+'">'+(rfType==='warn'?'<strong>‚ö† Off-Balance-Sheet / Risk Flags:</strong> ':'<strong>‚úì Risk Scan:</strong> ')+rf+'</div>';
      }
    }
  }

  // Methodology
  h+='<h2>Methodology</h2>';
  h+='<div class="methodology">';
  h+='<p><strong>Real Economic Profit</strong> = CFO ‚àí Real SBC (MAX of expense vs grant value) ‚àí Maintenance CapEx ‚àí Restructuring + Investment Income</p>';
  h+='<p style="margin-top:8px">Real SBC uses the greater of expensed SBC or calculated grant-date fair value to capture true dilution cost. <strong>Conservative view:</strong> Maintenance CapEx = D&A √ó 1.05 when not separately disclosed and CapEx significantly exceeds D&A. <strong>Asset-Light view</strong> (when Depreciation Only is provided): Maintenance CapEx = Physical Depreciation √ó 1.05, excluding acquisition-related intangible amortization. The asset-light view better reflects actual cash maintenance needs for companies with large acquired intangible bases. Growth CapEx = Total CapEx ‚àí Maintenance CapEx. Real ROIC = Real Economic Profit √∑ Invested Capital (Equity + Debt ‚àí Cash ‚àí STI).</p>';
  h+='<p style="margin-top:8px">Data sourced from SEC 10-K filings (cash flow) and 10-Q filings (balance sheet). Extracted via Gemini AI with manual verification.</p>';
  h+='</div>';

  h+='</body></html>';

  // Also generate markdown version for download
  var md=generateMarkdown(ticker,price,years,latest,shares,ev,marketCap,realYield,unleverYield,realPE,gap,interest,taxPaid,totalAssets,rating,now,debt,cash,sti);

  // Inject download scripts with markdown data
  var scriptInsert='<script>';
  scriptInsert+='var _md='+JSON.stringify(md)+';';
  scriptInsert+='var _ticker='+JSON.stringify(ticker)+';';
  scriptInsert+='function downloadHTML(){var b=new Blob([document.documentElement.outerHTML],{type:"text/html"});var u=URL.createObjectURL(b);var a=document.createElement("a");a.href=u;a.download=_ticker+"_Real_Economic_Profit_Brief.html";a.click();URL.revokeObjectURL(u);}';
  scriptInsert+='function downloadMD(){var b=new Blob([_md],{type:"text/markdown"});var u=URL.createObjectURL(b);var a=document.createElement("a");a.href=u;a.download=_ticker+"_Real_Economic_Profit_Brief.md";a.click();URL.revokeObjectURL(u);}';
  scriptInsert+='<\/script>';
  h=h.replace('</body>',scriptInsert+'</body>');

  // Open in new tab
  var w=window.open('','_blank');
  if(w){w.document.write(h);w.document.close();}
  else{
    // Fallback: download as HTML
    var blob=new Blob([h],{type:'text/html;charset=utf-8'});
    var url=URL.createObjectURL(blob);
    var a=document.createElement('a');a.href=url;a.download=ticker+'_Real_Economic_Profit_Brief.html';a.click();
    URL.revokeObjectURL(url);
  }
}

// ============ Main Calculate ============
function calculate(){
  var ticker=document.getElementById('ticker').value||'Company';
  var price=v('price');
  var cfo=v('cfo');
  var sbcExp=v('sbc_expense')||0;
  var sbcGrant=v('sbc_grant')||0;
  var capex=v('capex')||0;
  var da=v('da')||0;
  var maintCapexInput=v('maint_capex');
  var restructuring=v('restructuring')||0;
  var invChange=v('inv_change')||0;
  var recvChange=v('recv_change')||0;
  var interest=v('interest')||0;
  var taxPaid=v('tax_paid')||0;
  var debt=v('debt')||0;
  var cash=v('cash')||0;
  var sti=v('sti')||0;
  var shares=v('shares');
  var ltInvestments=v('lt_investments')||0;
  var invReturnRate=(v('inv_return_rate')||4)/100;
  var equity=v('equity')||0;
  var totalAssets=v('total_assets')||0;

  if(!price||!cfo||!shares){alert('Please fill in at least: Share Price, CFO, and Diluted Shares.');return;}

  if(currentYearKey&&yearStore[currentYearKey])yearStore[currentYearKey].formData=captureForm();

  var maintCapex,maintMethod;
  if(maintCapexInput!==null&&maintCapexInput>0){maintCapex=maintCapexInput;maintMethod='Disclosed';}
  else{var ratio=da>0?capex/da:999;if(ratio>=0.8&&ratio<=1.2){maintCapex=capex;maintMethod='CapEx ‚âà D&A ‚Üí using total CapEx';}else{maintCapex=da*1.05;maintMethod='D&A + 5% inflation buffer';}}

  // Asset-light view: depreciation-only √ó 1.05
  var deprOnly=v('depr_only')||0;
  var hasLightView=deprOnly>0&&da>0&&deprOnly<da*0.95;
  var maintCapexLight=hasLightView?deprOnly*1.05:null;

  var realSBC=Math.max(sbcExp,sbcGrant);
  var sbcSource=sbcGrant>sbcExp?'Grant Value (higher)':'Expense';
  var wcDrag=invChange+recvChange;
  var investmentIncome=ltInvestments*invReturnRate;
  var realProfit=cfo-realSBC-maintCapex-restructuring+investmentIncome;
  var realProfitLight=hasLightView?(cfo-realSBC-maintCapexLight-restructuring+investmentIncome):null;
  var unleverProfit=realProfit+interest;
  var marketCap=price*shares;
  var ev=marketCap+debt-(cash+sti);
  var realYield=realProfit/ev;
  var unleverYield=unleverProfit/ev;
  var realPE=price/(realProfit/shares);
  var reportedFCF=cfo-capex;
  var gap=realProfit-reportedFCF;
  var growthCapex=Math.max(capex-maintCapex,0);
  var investedCapital=equity>0?(equity+debt-cash-sti):0;
  var realROIC=investedCapital>0?realProfit/investedCapital:0;

  var rating,ratingClass;
  if(realYield>=0.07){rating='Strong Value';ratingClass='strong';}
  else if(realYield>=0.04){rating='Fair Value';ratingClass='fair';}
  else if(realYield>=0.02){rating='Growth Priced In';ratingClass='growth';}
  else{rating='Expensive';ratingClass='expensive';}

  document.getElementById('verdict').className='verdict '+ratingClass;
  document.getElementById('verdict').innerHTML='<div class="yield-num">'+pct(realYield)+'</div><div class="yield-label">Real Cash Yield on EV ‚Äî '+ticker+'</div><div class="rating">'+rating+'</div>';

  var metricsData=[
    {label:'Real Economic Profit',value:fmtM(realProfit),sub:fmt(realProfit/shares,2)+'/share',hl:true},
    {label:'Unlevered Yield',value:pct(unleverYield)},
    {label:'Real P/E',value:realPE>0?realPE.toFixed(1)+'x':'N/A'},
    {label:'Enterprise Value',value:fmtM(ev)},
    {label:'Reported FCF',value:fmtM(reportedFCF)},
    {label:'Real vs Reported Gap',value:fmtM(gap),neg:gap<0}
  ];
  document.getElementById('metricsGrid').innerHTML=metricsData.map(function(m){
    return '<div class="metric'+(m.hl?' highlight':'')+'"><div class="val" '+(m.neg?'style="color:var(--red)"':'')+'>'+m.value+'</div><div class="lbl">'+m.label+(m.sub?' ¬∑ '+m.sub:'')+'</div></div>';
  }).join('');

  // Waterfall
  var wfItems=[{label:'CFO',value:cfo,type:'positive'},{label:'‚àí Real SBC',value:-realSBC,type:'negative'},{label:'‚àí Maint CapEx (Conservative)',value:-maintCapex,type:'negative'},{label:'‚àí Restructuring',value:-restructuring,type:'negative'}];
  if(investmentIncome>0)wfItems.push({label:'+ Invest. Income',value:investmentIncome,type:'invest'});
  wfItems.push({label:'= Real Profit (Conservative)',value:realProfit,type:'result'});
  if(hasLightView){
    wfItems.push({label:'',value:0,type:'positive'});
    wfItems.push({label:'‚àí Maint CapEx (Asset-Light)',value:-maintCapexLight,type:'negative'});
    wfItems.push({label:'= Real Profit (Asset-Light)',value:realProfitLight,type:'result'});
  }
  var maxVal=Math.max.apply(null,wfItems.map(function(w){return Math.abs(w.value)}).concat([1]));
  document.getElementById('waterfall').innerHTML=wfItems.map(function(w){
    if(w.label===''&&w.value===0)return '<div style="height:8px;border-top:1px dashed #444;margin:8px 0"></div>';
    var width=Math.max(Math.abs(w.value)/maxVal*100,8);
    return '<div class="wf-bar"><span class="wf-label">'+w.label+'</span><div class="wf-track"><div class="wf-fill '+w.type+'" style="width:'+width+'%">'+fmtM(Math.abs(w.value))+'</div></div></div>';
  }).join('');

  // ROIC section
  var goodwill=v('goodwill')||0;
  var intangiblesVal=v('intangibles')||0;
  var nta=totalAssets>0?(totalAssets-goodwill-intangiblesVal-cash-sti):0;
  var returnOnNTA=nta>0?realProfit/nta:0;
  var roicCard=document.getElementById('roicCard');
  if(equity>0&&growthCapex>0){
    roicCard.style.display='block';
    var reinvestRate=investedCapital>0?growthCapex/investedCapital:0;
    var impliedGrowth=reinvestRate*realROIC;
    var roicItems=[
      {label:'Real ROIC (Conservative)',value:pct(realROIC),sub:'Real Profit √∑ Invested Capital'},
      {label:'Invested Capital',value:fmtM(investedCapital),sub:'Equity + Debt ‚àí Cash ‚àí STI'},
      {label:'Growth CapEx',value:fmtM(growthCapex),sub:'Total CapEx ‚àí Maint CapEx'},
      {label:'Maint CapEx (Conservative)',value:fmtM(maintCapex),sub:maintMethod},
      {label:'Reinvestment Rate',value:pct(reinvestRate,1),sub:'Growth CapEx √∑ Invested Capital'},
      {label:'Implied Profit Growth',value:pct(impliedGrowth,1),sub:'Reinvest Rate √ó ROIC'}
    ];
    if(hasLightView){
      var realROICLight=investedCapital>0?realProfitLight/investedCapital:0;
      roicItems.push({label:'Maint CapEx (Asset-Light)',value:fmtM(maintCapexLight),sub:'Depreciation Only √ó 1.05'});
      roicItems.push({label:'Real ROIC (Asset-Light)',value:pct(realROICLight),sub:'Asset-Light Profit √∑ IC'});
    }
    if(nta>0){
      roicItems.push({label:'Return on NTA',value:pct(returnOnNTA),sub:'Real Profit √∑ Net Tangible Assets'});
      roicItems.push({label:'Net Tangible Assets',value:fmtM(nta),sub:'Assets ‚àí GW ‚àí Intang ‚àí Cash ‚àí STI'});
    }
    document.getElementById('roicMetrics').innerHTML=roicItems.map(function(m){return '<div class="metric"><div class="val">'+m.value+'</div><div class="lbl">'+m.label+' ¬∑ '+m.sub+'</div></div>'}).join('');

    var scenarios=[{label:'Bear (10%)',roic:0.10},{label:'Base (ROIC: '+pct(realROIC,0)+')',roic:realROIC},{label:'Bull ('+pct(Math.max(realROIC*1.25,realROIC+0.05),0)+')',roic:Math.max(realROIC*1.25,realROIC+0.05)}];
    if(realROIC<=0.10){scenarios=[{label:'Bear (5%)',roic:0.05},{label:'Base (ROIC: '+pct(realROIC,0)+')',roic:realROIC},{label:'Bull (20%)',roic:0.20}];}
    if(realROIC>=0.25)scenarios[0]={label:'Bear (10%)',roic:0.10};

    var projHTML='<p style="font-size:.82rem;color:var(--text2);margin-bottom:12px">If growth CapEx of <strong style="color:var(--text)">'+fmtM(growthCapex)+'/yr</strong> earns a given return, what will the real yield become?</p>';
    projHTML+='<table class="proj-table"><tr><th style="text-align:left">Scenario</th><th>New Profit (Yr 3)</th><th>Yield (Yr 3)</th><th>New Profit (Yr 5)</th><th>Yield (Yr 5)</th></tr>';
    scenarios.forEach(function(s,i){
      var a3=growthCapex*s.roic*3,a5=growthCapex*s.roic*5;
      var p3=realProfit+a3,p5=realProfit+a5;
      var y3=p3/ev,y5=p5/ev;
      var cls=i===1?' class="highlight-row"':'';
      projHTML+='<tr'+cls+'><td>'+s.label+'</td><td>'+fmtM(p3)+'</td><td>'+pct(y3)+'</td><td>'+fmtM(p5)+'</td><td>'+pct(y5)+'</td></tr>';
    });
    projHTML+='</table><p class="section-note">Assumes constant EV (no price change) and cumulative returns on annual growth CapEx.</p>';
    document.getElementById('growthProjection').innerHTML=projHTML;
  }else{
    roicCard.style.display=equity>0?'block':'none';
    if(equity>0){
      var ntaHTML='<div class="metric"><div class="val">'+pct(realROIC)+'</div><div class="lbl">Real ROIC (Conservative) ¬∑ Real Profit √∑ Invested Capital</div></div><div class="metric"><div class="val">'+fmtM(investedCapital)+'</div><div class="lbl">Invested Capital ¬∑ Equity + Debt ‚àí Cash ‚àí STI</div></div>';
      if(hasLightView){
        var realROICLight=investedCapital>0?realProfitLight/investedCapital:0;
        ntaHTML+='<div class="metric"><div class="val">'+pct(realROICLight)+'</div><div class="lbl">Real ROIC (Asset-Light) ¬∑ Depr Only √ó 1.05</div></div>';
        ntaHTML+='<div class="metric"><div class="val">'+fmtM(realProfitLight)+'</div><div class="lbl">Real Profit (Asset-Light)</div></div>';
      }
      if(nta>0)ntaHTML+='<div class="metric"><div class="val">'+pct(returnOnNTA)+'</div><div class="lbl">Return on NTA ¬∑ Real Profit √∑ Net Tangible Assets</div></div><div class="metric"><div class="val">'+fmtM(nta)+'</div><div class="lbl">Net Tangible Assets ¬∑ Assets ‚àí GW ‚àí Intang ‚àí Cash</div></div>';
      document.getElementById('roicMetrics').innerHTML=ntaHTML;
      document.getElementById('growthProjection').innerHTML='<p style="font-size:.82rem;color:var(--text3)">No material growth CapEx detected (CapEx ‚âà D&A). ROIC shown above reflects return on existing capital base.'+(hasLightView?' Asset-Light view uses physical depreciation only, excluding acquisition-related amortization.':'')+'</p>';
    }
  }

  // Breakdown table
  var rows=[
    ['Cash From Operations',fmt(cfo,0)+'M',''],
    ['SBC Expense (addback)',fmt(sbcExp,0)+'M','Included in CFO'],
    ['SBC Grant Value',fmt(sbcGrant,0)+'M',sbcGrant>0?'From Notes':'Not provided'],
    ['Real SBC Burden (MAX)',fmt(realSBC,0)+'M',sbcSource,'negative'],
    ['Total CapEx',fmt(capex,0)+'M',''],
    ['Depreciation & Amortization',fmt(da,0)+'M',''],
    ['Real Maintenance CapEx',fmt(maintCapex,0)+'M',maintMethod,'negative'],
    ['Growth CapEx',fmt(growthCapex,0)+'M','Total CapEx ‚àí Maint CapEx'],
    ['Restructuring',fmt(restructuring,0)+'M',restructuring===0?'None reported':'','negative'],
    ['Working Capital Drag',fmt(Math.abs(wcDrag),0)+'M',wcDrag<0?'Cash trapped':'Cash released',wcDrag<0?'negative':'positive'],
    ['Inventory Change',fmt(Math.abs(invChange),0)+'M',invChange<0?'Trapped':'Released'],
    ['Receivables Change',fmt(Math.abs(recvChange),0)+'M',recvChange<0?'Not collected':'Collected']
  ];
  if(ltInvestments>0){
    rows.push(['Non-Cash LT Investments',fmt(ltInvestments,0)+'M','Balance']);
    rows.push(['Expected Return Rate',pct(invReturnRate),'Applied to LT investments']);
    rows.push(['Investment Income Credit','+'+fmt(investmentIncome,0)+'M','Added to Real Profit','positive']);
  }
  rows.push(['','','','']);
  rows.push(['Real Economic Profit (Conservative)',fmt(realProfit,0)+'M','CFO ‚àí SBC ‚àí MaintCapex ‚àí Restruct'+(investmentIncome>0?' + Invest Income':''),'subtotal']);
  if(hasLightView){
    rows.push(['','','','']);
    rows.push(['Depreciation Only',fmt(deprOnly,0)+'M','Physical depreciation (excl. intangible amortization)']);
    rows.push(['Amortization',fmt(da-deprOnly,0)+'M','Acquisition-related intangible amortization']);
    rows.push(['Maint CapEx (Asset-Light)',fmt(maintCapexLight,0)+'M','Depreciation Only √ó 1.05','negative']);
    rows.push(['Real Economic Profit (Asset-Light)',fmt(realProfitLight,0)+'M','Uses physical depreciation only for maintenance','subtotal']);
  }
  rows.push(['','','','']);
  rows.push(['Reported FCF',fmt(reportedFCF,0)+'M','CFO ‚àí Total CapEx']);
  rows.push(['Gap (Real ‚àí Reported)',fmt(gap,0)+'M',gap<0?'Reported overstates profit':'Real exceeds reported',gap<0?'negative':'positive']);
  rows.push(['Interest Paid',fmt(interest,0)+'M','']);
  rows.push(['Unlevered Profit',fmt(unleverProfit,0)+'M','Real Profit + Interest']);
  rows.push(['Enterprise Value',fmtM(ev),'Mkt Cap + Debt ‚àí Cash ‚àí STI']);
  rows.push(['Market Cap',fmtM(marketCap),'Price √ó Shares']);
  if(equity>0){
    rows.push(['Shareholders Equity',fmtM(equity),'Balance sheet']);
    rows.push(['Invested Capital',fmtM(investedCapital),'Equity + Debt ‚àí Cash ‚àí STI']);
    rows.push(['Real ROIC',pct(realROIC),'Real Profit √∑ Invested Capital']);
    if(growthCapex>0){
      rows.push(['Reinvestment Rate',pct(investedCapital>0?growthCapex/investedCapital:0,1),'Growth CapEx √∑ Invested Capital']);
      rows.push(['Implied Profit Growth',pct(investedCapital>0?(growthCapex/investedCapital)*realROIC:0,1),'Reinvest Rate √ó ROIC']);
    }
    if(nta>0){
      rows.push(['Net Tangible Assets',fmtM(nta),'Assets ‚àí Goodwill ‚àí Intangibles ‚àí Cash ‚àí STI']);
      rows.push(['Return on NTA',pct(returnOnNTA),'Real Profit √∑ NTA (buyback-neutral)']);
    }
  }

  var tableHTML='<tr><th>Line Item</th><th>Notes</th><th>Value</th></tr>';
  rows.forEach(function(r){
    if(!r[0]&&!r[1])return;
    var cls='';
    if(r[3]==='negative')cls=' class="negative"';if(r[3]==='positive')cls=' class="positive"';if(r[3]==='subtotal')cls=' class="subtotal"';
    tableHTML+='<tr'+cls+'><td>'+r[0]+'</td><td style="color:var(--text3)">'+(r[2]||'')+'</td><td>'+r[1]+'</td></tr>';
  });
  document.getElementById('breakdown').innerHTML=tableHTML;

  // Red Flags
  var flags=[];
  if(sbcGrant>0&&sbcGrant>sbcExp*1.2){
    var ratio=(sbcGrant/sbcExp).toFixed(1);
    flags.push({type:'warn',text:'<strong>‚ö† Hidden SBC Dilution:</strong> Grant Value is '+ratio+'x the expensed amount ‚Äî significant shareholder dilution not reflected in reported earnings.'});
  }
  if(sbcGrant>0&&sbcExp>sbcGrant*1.1){
    flags.push({type:'info',text:'<strong>‚Ñπ SBC Note:</strong> Expense ('+fmtM(sbcExp)+') exceeds Grant Value ('+fmtM(sbcGrant)+') ‚Äî older, cheaper grants being amortized. Current dilution is actually less than expensed.'});
  }
  var sbcPctCFO=realSBC/cfo;
  if(sbcPctCFO>0.3){flags.push({type:'warn',text:'<strong>‚ö† SBC as % of CFO:</strong> '+pct(sbcPctCFO,1)+' ‚Äî shareholders are funding a large portion of employee compensation.'});}
  else if(sbcPctCFO>0.15){flags.push({type:'caution',text:'<strong>‚ö° SBC as % of CFO:</strong> '+pct(sbcPctCFO,1)+' ‚Äî moderate but worth watching.'});}
  else{flags.push({type:'ok',text:'<strong>‚úì SBC as % of CFO:</strong> '+pct(sbcPctCFO,1)+' ‚Äî reasonable level.'});}
  if(restructuring>0){
    var restPct=restructuring/cfo;
    flags.push({type:restPct>0.05?'warn':'caution',text:'<strong>'+(restPct>0.05?'‚ö†':'‚ö°')+' Restructuring:</strong> '+fmt(restructuring,0)+'M ('+pct(restPct,1)+' of CFO) ‚Äî '+(restPct>0.05?'serial restructurer, treat as ongoing cost':'one-time charges reduce real profit')+'.'});
  }
  if(wcDrag<-1000){flags.push({type:'caution',text:'<strong>‚ö° Working Capital Drag:</strong> '+fmt(Math.abs(wcDrag),0)+'M consumed ‚Äî cash trapped in inventory/receivables.'});}
  else if(wcDrag>1000){flags.push({type:'ok',text:'<strong>‚úì Working Capital:</strong> Released '+fmt(wcDrag,0)+'M ‚Äî positive cash conversion.'});}
  if(debt>0&&realProfit>0){
    var debtRatio=debt/realProfit;
    if(debtRatio>8)flags.push({type:'warn',text:'<strong>‚ö† High Leverage:</strong> Debt is '+debtRatio.toFixed(1)+'x real profit ‚Äî significant leverage risk.'});
    else if(debtRatio>4)flags.push({type:'caution',text:'<strong>‚ö° Moderate Leverage:</strong> Debt is '+debtRatio.toFixed(1)+'x real profit.'});
    else flags.push({type:'ok',text:'<strong>‚úì Leverage:</strong> Debt is '+debtRatio.toFixed(1)+'x real profit ‚Äî manageable.'});
  }
  if(ltInvestments>0){
    var invPctEV=ltInvestments/ev;
    flags.push({type:'info',text:'<strong>‚Ñπ Investment Portfolio:</strong> '+fmtM(ltInvestments)+' in long-term investments ('+pct(invPctEV,1)+' of EV). Credited '+fmtM(investmentIncome)+'/yr at '+pct(invReturnRate)+' assumed return.'});
  }
  if(equity>0&&realROIC>0){
    if(realROIC>0.20)flags.push({type:'ok',text:'<strong>‚úì Real ROIC:</strong> '+pct(realROIC)+' ‚Äî exceptional returns on invested capital. Growth CapEx likely value-creating.'});
    else if(realROIC>0.12)flags.push({type:'ok',text:'<strong>‚úì Real ROIC:</strong> '+pct(realROIC)+' ‚Äî solid returns above cost of capital.'});
    else if(realROIC>0.06)flags.push({type:'caution',text:'<strong>‚ö° Real ROIC:</strong> '+pct(realROIC)+' ‚Äî moderate. Growth spending may not create significant value.'});
    else flags.push({type:'warn',text:'<strong>‚ö† Real ROIC:</strong> '+pct(realROIC)+' ‚Äî below typical cost of capital. Growth CapEx may be destroying value.'});
  }
  if(hasLightView){
    var realROICLight=investedCapital>0?realProfitLight/investedCapital:0;
    if(realROIC<0&&realROICLight>0){
      flags.push({type:'info',text:'<strong>‚Ñπ Asset-Light View:</strong> Conservative ROIC is '+pct(realROIC)+' but Asset-Light ROIC is '+pct(realROICLight)+'. The gap ('+fmtM(realProfitLight-realProfit)+') is acquisition amortization treated as maintenance cost. For companies growing through M&A, the asset-light view may better reflect operating reality.'});
    }else if(realROICLight>realROIC+0.03){
      flags.push({type:'info',text:'<strong>‚Ñπ Asset-Light View:</strong> ROIC improves from '+pct(realROIC)+' (conservative) to '+pct(realROICLight)+' (asset-light) when excluding acquisition amortization from maintenance CapEx.'});
    }
  }
  if(nta>0&&returnOnNTA>0){
    var roicNTAGap=realROIC-returnOnNTA;
    if(Math.abs(roicNTAGap)>0.10){
      flags.push({type:'info',text:'<strong>‚Ñπ ROIC vs NTA Divergence:</strong> Real ROIC '+pct(realROIC)+' vs Return on NTA '+pct(returnOnNTA)+'. '+(roicNTAGap>0?'ROIC inflated by buybacks compressing equity ‚Äî NTA gives a truer picture of asset productivity.':'NTA return exceeds ROIC ‚Äî equity may include accumulated intangible/goodwill value not in NTA.')});
    }else{
      flags.push({type:'ok',text:'<strong>‚úì Return on NTA:</strong> '+pct(returnOnNTA)+' ‚Äî consistent with ROIC ('+pct(realROIC)+'). No significant buyback distortion.'});
    }
  }
  if(growthCapex>0&&growthCapex>maintCapex){
    var growthPct=growthCapex/capex;
    flags.push({type:'growth',text:'<strong>üöÄ Growth Investment:</strong> '+fmtM(growthCapex)+' ('+pct(growthPct,0)+' of total CapEx) is growth spending beyond maintenance. '+(realROIC>0.15?'At current ROIC, this should generate '+fmtM(growthCapex*realROIC)+'/yr in new profit.':'See projection table above for return scenarios.')});
  }
  if(realYield>=0.07)flags.push({type:'ok',text:'<strong>‚úì Yield Assessment:</strong> '+pct(realYield)+' real yield is strong ‚Äî business generating substantial cash relative to its price.'});
  else if(realYield>=0.04)flags.push({type:'ok',text:'<strong>‚úì Yield Assessment:</strong> '+pct(realYield)+' real yield is fair ‚Äî reasonable cash generation for the price.'});
  else if(realYield>=0.02)flags.push({type:'caution',text:'<strong>‚ö° Yield Assessment:</strong> '+pct(realYield)+' real yield means growth is priced in ‚Äî need significant earnings growth to justify.'});
  else flags.push({type:'warn',text:'<strong>‚ö† Yield Assessment:</strong> '+pct(realYield)+' real yield is expensive ‚Äî market pricing in exceptional future growth.'});

  // Risk flags from Gemini extraction
  if(currentYearKey&&yearStore[currentYearKey]&&yearStore[currentYearKey].extra){
    var rf=yearStore[currentYearKey].extra.risk_flags||yearStore[currentYearKey].extra['risk_flags']||null;
    if(rf&&typeof rf==='string'&&rf.toLowerCase().indexOf('no material')===-1){
      flags.push({type:'warn',text:'<strong>‚ö† Off-Balance-Sheet / Risk Flags:</strong> '+rf});
    }else if(rf){
      flags.push({type:'ok',text:'<strong>‚úì Risk Scan:</strong> '+rf});
    }
  }

  document.getElementById('flags').innerHTML=flags.map(function(f){return '<div class="flag '+f.type+'">'+f.text+'</div>'}).join('');
  document.getElementById('results').style.display='block';
  document.getElementById('exportBtn').style.display='block';
  document.getElementById('projCard').style.display='block';

  // Render trend
  renderTrend();

  document.getElementById('results').scrollIntoView({behavior:'smooth',block:'start'});
}
</script>
</body>
</html>
